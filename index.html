<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PaperWar - Battle Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        :root {
            --p-x: 35px; --p-y: 60px; --p-z: 250px;
            --e-x: -35px; --e-y: -100px; --e-z: -450px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617; 
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; 
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        .hidden-view { display: none !important; }

        /* --- AMBIENTE 3D --- */
        .battle-scene {
            perspective: 1200px; perspective-origin: 50% 35%;
            overflow: hidden;
            background: linear-gradient(to bottom, rgba(2, 6, 23, 0.4), rgba(2, 6, 23, 0.8)), 
                        url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?auto=format&fit=crop&q=80&w=1000') no-repeat center center;
            background-size: cover;
            display: flex; flex-direction: column; height: 100%;
        }

        .arena-container {
            position: relative; width: 100%; flex: 1;
            transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center;
        }

        .ground-plane {
            position: absolute; width: 300%; height: 300%;
            background-image: 
                radial-gradient(circle at center, rgba(79, 70, 229, 0.2) 0%, transparent 60%),
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 100% 100%, 60px 60px, 60px 60px;
            transform: rotateX(75deg) translateY(25%);
            bottom: -40%; z-index: 1;
        }

        /* --- ANIMA√á√ïES DE SPRITE --- */
        .sprite-renderer {
            width: 120px; height: 120px;
            display: flex; align-items: center; justify-content: center;
            transform-style: preserve-3d;
            transition: transform 0.4s ease;
        }

        #player-sprite-container { transform: rotateY(30deg) rotateX(5deg); }
        #enemy-sprite-container { transform: rotateY(-30deg) rotateX(5deg); }

        /* Rota√ß√£o Apenas para Melee */
        @keyframes spin-attack {
            0% { transform: rotateY(30deg) rotateZ(0deg); }
            50% { transform: rotateY(210deg) rotateZ(15deg) scale(1.2); }
            100% { transform: rotateY(390deg) rotateZ(0deg); }
        }
        .anim-spin-atk { animation: spin-attack 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        @keyframes hit-spin {
            0% { transform: rotateY(30deg) rotateZ(0deg); }
            20% { transform: rotateY(80deg) rotateZ(-20deg) translateX(20px); }
            40% { transform: rotateY(-20deg) rotateZ(20deg) translateX(-10px); }
            100% { transform: rotateY(30deg) rotateZ(0deg); }
        }
        .anim-hit-recoil { animation: hit-spin 0.5s ease-out; }

        @keyframes breathing {
            0%, 100% { transform: scale(1) translateY(0); opacity: 0.9; filter: drop-shadow(0 15px 20px rgba(0,0,0,0.6)); }
            50% { transform: scale(1.03) translateY(-4px); opacity: 1; filter: drop-shadow(0 20px 25px rgba(0,0,0,0.7)); }
        }

        .sprite-renderer img, .sprite-renderer .emoji-renderer {
            max-width: 100%; max-height: 100%; object-fit: contain;
            animation: breathing 3s ease-in-out infinite;
        }

        .emoji-renderer { font-size: 4.5rem; filter: drop-shadow(0 8px 10px rgba(0,0,0,0.4)); user-select: none; }

        /* --- POSICIONAMENTO 3D --- */
        .entity-wrapper {
            position: absolute; transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }

        .pos-enemy { transform: translateX(var(--e-x)) translateY(var(--e-y)) translateZ(var(--e-z)); }
        .pos-player { transform: translateX(var(--p-x)) translateY(var(--p-y)) translateZ(var(--p-z)); }

        .anim-melee-player { transform: translateX(-15px) translateY(-50px) translateZ(-350px) scale(1.1); }
        .anim-melee-enemy { transform: translateX(15px) translateY(50px) translateZ(150px) scale(1.1); }

        /* Magic Glow: Apenas sobe um pouco, sem avan√ßar */
        @keyframes magic-glow { 
            0%, 100% { transform: translateY(0px) scale(1); } 
            50% { transform: translateY(-15px) scale(1.1); filter: brightness(2.5) drop-shadow(0 0 10px white); } 
        }
        .anim-channeling { animation: magic-glow 0.5s ease-in-out infinite; }

        .character-shadow {
            position: absolute; bottom: -5px; left: 50%; width: 90px; height: 25px;
            background: rgba(0, 0, 0, 0.8); border-radius: 50%;
            transform: translateX(-50%) rotateX(80deg); filter: blur(10px);
            z-index: -1; pointer-events: none;
        }

        /* --- HUD --- */
        .hud-container {
            background: rgba(0, 0, 0, 0.7); border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 4px 8px; border-radius: 8px; width: 90px; opacity: 0.8;
            backdrop-filter: blur(4px); transition: opacity 0.3s ease;
        }

        /* --- ELEMENTOS --- */
        .element-fire { background: linear-gradient(135deg, #ef4444, #7f1d1d); }
        .element-water { background: linear-gradient(135deg, #3b82f6, #1e3a8a); }
        .element-lightning { background: linear-gradient(135deg, #eab308, #713f12); }
        .element-robot { background: linear-gradient(135deg, #64748b, #0f172a); }

        /* --- MOTOR DE PART√çCULAS --- */
        @keyframes p-fall { 0% { transform: var(--origin); opacity: 0; } 10% { opacity: 1; } 100% { transform: var(--destination); opacity: 0; } }
        @keyframes p-travel { 0% { transform: var(--origin) scale(0.2); opacity: 0; } 15% { opacity: 1; scale: 1.2; } 100% { transform: var(--destination) scale(0.6); opacity: 0; } }

        .particle { position: absolute; left: 50%; top: 50%; z-index: 60; pointer-events: none; }
        .p-fire { width: 45px; height: 45px; border-radius: 50%; background: radial-gradient(circle, #fff, #facc15, #ef4444); box-shadow: 0 0 30px #f97316; animation: p-travel 0.6s linear forwards; }
        .p-water { width: 25px; height: 25px; border-radius: 50%; background: #38bdf8; box-shadow: 0 0 20px #0ea5e9; filter: blur(2px); animation: p-travel 0.5s ease-out forwards; }
        .p-lightning { width: 8px; height: 600px; background: #fff; box-shadow: 0 0 20px #fff, 0 0 40px #facc15; transform-origin: top center; animation: p-fall 0.4s ease-in forwards; }

        .dmg-text { position: absolute; top: -120px; left: 50%; transform: translateX(-50%); color: #ff4444; font-weight: 900; font-size: 3.5rem; text-shadow: 0 4px 10px black; animation: damage-float 0.8s ease-out forwards; z-index: 100; }
        @keyframes damage-float { 0% { opacity: 0; transform: translateY(0); } 20% { opacity: 1; } 100% { opacity: 0; transform: translateY(-80px); } }

        /* --- CONTROLES DE BATALHA --- */
        .battle-controls {
            padding: 1.25rem;
            padding-bottom: calc(1.25rem + env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(2, 6, 23, 0.95), transparent);
            z-index: 100;
        }

        .hit-ring { position: absolute; border-radius: 50%; border: 10px solid white; animation: hit-ring-anim 0.5s ease-out forwards; }
        @keyframes hit-ring-anim { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(8); opacity: 0; } }

        .screen-shake { animation: shake-anim 0.2s ease-in-out 3; }
        @keyframes shake-anim { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(15px, -15px); } }

        ::-webkit-scrollbar { width: 0px; }
        
        .monster-slot {
            aspect-ratio: 1 / 1;
            position: relative;
            border: 2px solid #334155;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="flash-effect" class="fixed inset-0 bg-white z-[1000] pointer-events-none opacity-0"></div>

    <div id="app" class="w-full h-full max-w-md bg-white relative shadow-2xl overflow-hidden flex flex-col sm:h-[94vh] sm:rounded-[3rem] border-slate-900 border-[6px]">

        <!-- LOGIN VIEW -->
        <main id="view-login" class="flex-1 flex flex-col items-center justify-center p-8 bg-slate-900 text-white">
            <h1 class="text-6xl font-black uppercase italic tracking-tighter text-indigo-500 mb-8">PaperWar</h1>
            <input type="text" id="login-name" placeholder="Comandante..." class="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl px-6 py-4 font-bold text-white mb-4 outline-none focus:border-indigo-500">
            <button onclick="handleLogin()" class="w-full bg-indigo-600 py-5 rounded-3xl font-black uppercase shadow-xl active:scale-95 transition-all">Entrar</button>
        </main>

        <!-- HEADER UI -->
        <header id="ui-header" class="p-4 bg-white border-b hidden justify-between items-center z-[100] shrink-0">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-xl">üë§</div>
                <p id="player-name-ui" class="font-bold text-slate-800 text-sm truncate max-w-[100px]">---</p>
            </div>
            <div class="flex space-x-2 font-bold text-[10px]">
                <div class="bg-indigo-50 px-3 py-1.5 rounded-full text-indigo-700">‚ö° <span id="val-energy">100</span></div>
                <div class="bg-amber-50 px-3 py-1.5 rounded-full text-amber-700">üíé <span id="val-crystals">0</span></div>
                <div class="bg-slate-100 px-3 py-1.5 rounded-full text-slate-700">üí∞ <span id="val-mana">0</span></div>
            </div>
        </header>

        <!-- HOME VIEW -->
        <main id="view-home" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50 hidden-view">
            <div class="bg-indigo-600 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <h2 class="text-3xl font-black italic uppercase mb-2">Aventura</h2>
                <div class="flex space-x-3">
                    <button onclick="changeView('view-story')" class="bg-white text-indigo-700 px-6 py-4 rounded-2xl font-black text-xs uppercase shadow-xl active:scale-95 transition-all">Modo Hist√≥ria</button>
                    <button onclick="startBattle()" class="bg-indigo-500/30 border border-white/20 text-white px-6 py-4 rounded-2xl font-black text-xs uppercase active:scale-95">Boss Solo</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="changeView('view-collection')" class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center space-y-3">
                    <div class="text-4xl">üé¥</div>
                    <span class="text-xs font-black uppercase text-slate-800">Monster Box</span>
                </button>
                <button onclick="changeView('view-summon')" class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center space-y-3">
                    <div class="text-4xl">üì¶</div>
                    <span class="text-xs font-black uppercase text-slate-800">Summon</span>
                </button>
            </div>
        </main>

        <!-- BATTLE VIEW -->
        <main id="view-battle" class="flex-1 hidden-view battle-scene">
            <div id="arena" class="arena-container">
                <div class="ground-plane"></div>
                
                <!-- Inimigo -->
                <div id="ent-enemy" class="entity-wrapper pos-enemy">
                    <div class="flex flex-col items-center">
                        <div id="enemy-hud" class="hud-container mb-2">
                             <div class="flex justify-between text-[7px] text-white font-black mb-1 uppercase tracking-tighter"><span id="enemy-name-lbl">BOSS</span><span id="enemy-hp-pct">100%</span></div>
                             <div class="h-1 w-full bg-black/40 rounded-full overflow-hidden"><div id="enemy-hp-fill" class="h-full bg-red-500 transition-all duration-300" style="width: 100%"></div></div>
                        </div>
                        <div id="enemy-sprite-container" class="sprite-renderer"></div>
                        <div class="character-shadow"></div>
                    </div>
                </div>

                <div id="effect-layer" class="absolute inset-0 pointer-events-none" style="transform-style: preserve-3d;"></div>

                <!-- Jogador -->
                <div id="ent-player" class="entity-wrapper pos-player">
                    <div class="flex flex-col items-center">
                        <div id="player-hud" class="hud-container mb-2">
                             <div class="flex justify-between text-[7px] text-white font-black mb-1 uppercase tracking-tighter"><span id="player-lvl-lbl">Lv. 1</span><span id="player-hp-pct">100%</span></div>
                             <div class="h-1 w-full bg-black/40 rounded-full overflow-hidden"><div id="player-hp-fill" class="h-full bg-emerald-500 transition-all duration-300" style="width: 100%"></div></div>
                        </div>
                        <div id="player-sprite-container" class="sprite-renderer"></div>
                        <div class="character-shadow"></div>
                    </div>
                </div>
            </div>

            <div class="battle-controls">
                <div id="combat-log" class="text-[10px] text-white font-black text-center mb-4 uppercase tracking-[0.2em] italic drop-shadow-lg">Tua Vez!</div>
                <div id="skill-grid" class="grid grid-cols-3 gap-3"></div>
            </div>
        </main>

        <!-- STORY VIEW -->
        <main id="view-story" class="flex-1 overflow-y-auto p-6 hidden-view bg-slate-50">
            <button onclick="changeView('view-home')" class="mb-4 text-slate-500 font-bold">‚Üê VOLTAR</button>
            <div id="story-list" class="space-y-4"></div>
        </main>

        <!-- MONSTER BOX -->
        <main id="view-collection" class="flex-1 overflow-hidden hidden-view bg-slate-900 flex flex-col">
            <div class="p-4 bg-slate-800 flex justify-between items-center shrink-0">
                <button onclick="changeView('view-home')" class="text-white font-bold text-xs">‚Üê VOLTAR</button>
                <div class="text-[10px] text-slate-400 font-bold uppercase">BA√ö: <span id="box-count">0</span>/100</div>
            </div>
            <div id="list-monsters" class="flex-1 overflow-y-auto p-4 grid grid-cols-4 gap-2 content-start"></div>
        </main>

        <!-- SUMMON VIEW -->
        <main id="view-summon" class="flex-1 hidden-view bg-slate-950 flex flex-col items-center justify-center p-12">
            <div id="summon-box" class="w-48 h-48 bg-indigo-600 rounded-[2rem] flex items-center justify-center text-7xl shadow-[0_0_50px_rgba(79,70,229,0.4)] mb-12 overflow-hidden relative">üéÅ</div>
            <button onclick="doSummon()" class="w-full bg-amber-500 text-white py-6 rounded-[2rem] font-black uppercase shadow-2xl active:scale-95 transition-all">Summon (75 üíé)</button>
            <button onclick="changeView('view-home')" class="mt-6 text-slate-500 font-bold text-[10px] uppercase">Sair</button>
        </main>

    </div>

    <script>
        const SKILL_LIBRARY = {
            'melee': { n: 'Investida', t: 'melee', p: 1.2, icon: '‚öîÔ∏è' },
            'bolt': { n: 'Raio Neon', t: 'lightning', p: 1.8, icon: '‚ö°' },
            'water': { n: 'Jato d\'√Ågua', t: 'water', p: 1.6, icon: 'üåä' },
            'fire': { n: 'Bola Fogo', t: 'fire', p: 1.7, icon: 'üî•' },
            'sup_lightning': { n: 'Calamidade', t: 'lightning', p: 3.2, icon: 'üí•' },
            'sup_water': { n: 'Dil√∫vio', t: 'water', p: 2.8, icon: 'üåä' },
            'sup_fire': { n: 'Meteoro', t: 'fire', p: 3.5, icon: 'üåã' }
        };

        // Adicionei spriteUrl de volta para que o Summon funcione com imagens se existirem
        const MONSTERS_DATABASE = [
            { id: 'thunder', name: 'Thunder Lord', element: 'lightning', emoji: 'ü¶Ñ', spriteUrl: 'src/Thyron.png', hp: 1400, atk: 210, def: 80, stars: 5, skills: ['melee', 'bolt', 'sup_lightning'] },
            { id: 'water', name: 'Leviathan', element: 'water', emoji: 'üêã', spriteUrl: 'src/Neriah.png', hp: 1800, atk: 140, def: 120, stars: 5, skills: ['melee', 'water', 'sup_water'] },
            { id: 'fire', name: 'Magma Titan', element: 'fire', emoji: 'üåã', spriteUrl: 'src/Aelyra.png', hp: 1600, atk: 185, def: 100, stars: 5, skills: ['melee', 'fire', 'sup_fire'] }
        ];

        let state = {
            playerName: "", crystals: 1000, energy: 100, mana: 5000,
            inventory: [], leaderIdx: 0, storyProgress: 1,
            battle: { p: null, e: null, turn: 'player', busy: false }
        };

        const init = () => {
            const saved = localStorage.getItem('paperwar_v7');
            if (saved) state = JSON.parse(saved);
            
            if (state.inventory.length > 0) {
                state.inventory.forEach(m => {
                    const dbMon = MONSTERS_DATABASE.find(dm => dm.emoji === m.emoji);
                    if(dbMon) {
                        if(dbMon.skills.length > m.skills.length) m.skills = dbMon.skills;
                        if(!m.spriteUrl) m.spriteUrl = dbMon.spriteUrl; // Corrige saves antigos sem sprite
                    }
                });
            } else {
                state.inventory.push({...MONSTERS_DATABASE[0], lvl: 15, curHp: MONSTERS_DATABASE[0].hp + 150});
            }

            if (state.playerName) {
                document.getElementById('player-name-ui').innerText = state.playerName;
                changeView('view-home');
            }
            updateStats();
        };

        const handleLogin = () => {
            const name = document.getElementById('login-name').value.trim();
            if (name.length < 2) return;
            state.playerName = name;
            document.getElementById('player-name-ui').innerText = name;
            save(); changeView('view-home');
        };

        const updateStats = () => {
            document.getElementById('val-crystals').innerText = state.crystals;
            document.getElementById('val-energy').innerText = state.energy;
            document.getElementById('val-mana').innerText = state.mana.toLocaleString();
        };

        const save = () => localStorage.setItem('paperwar_v7', JSON.stringify(state));

        const changeView = (id) => {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden-view'));
            document.getElementById(id).classList.remove('hidden-view');
            const header = document.getElementById('ui-header');
            if (['view-login', 'view-battle', 'view-summon'].includes(id)) { header.classList.add('hidden'); header.classList.remove('flex'); }
            else { header.classList.remove('hidden'); header.classList.add('flex'); }
            if (id === 'view-collection') renderInventory();
            if (id === 'view-story') renderStory();
        };

        const renderCharacter = (monster, containerId) => {
            const container = document.getElementById(containerId);
            if(!container) return;
            if(monster.spriteUrl) {
                container.innerHTML = `
                    <img src="${monster.spriteUrl}" alt="${monster.name}" class="character-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                    <span class="emoji-renderer" style="display:none">${monster.emoji}</span>
                `;
            } else {
                container.innerHTML = `<span class="emoji-renderer">${monster.emoji}</span>`;
            }
        };

        const renderInventory = () => {
            const list = document.getElementById('list-monsters'); list.innerHTML = '';
            document.getElementById('box-count').innerText = state.inventory.length;
            state.inventory.forEach((m, i) => {
                const el = document.createElement('div');
                const isLeader = state.leaderIdx === i;
                el.className = `monster-slot ${isLeader ? 'border-amber-400 border-[3px]' : ''} element-${m.element}`;
                
                // Exibe imagem ou emoji no invent√°rio
                let visual = m.spriteUrl ? `<img src="${m.spriteUrl}" class="w-10 h-10 object-contain drop-shadow-md" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span class="text-3xl hidden">${m.emoji}</span>` : `<span class="text-3xl">${m.emoji}</span>`;

                el.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center p-1">${visual}<span class="text-[8px] font-black text-white uppercase mt-1">Lv.${m.lvl}</span></div>`;
                el.onclick = () => { state.leaderIdx = i; save(); renderInventory(); };
                list.appendChild(el);
            });
        };

        const renderStory = () => {
            const list = document.getElementById('story-list'); list.innerHTML = '';
            [1,2,3,4].forEach(lv => {
                const locked = lv > state.storyProgress;
                const div = document.createElement('div');
                div.className = `p-5 rounded-[2rem] border-2 ${locked ? 'bg-slate-100 border-slate-200' : 'bg-white border-indigo-100 shadow-md'}`;
                div.innerHTML = `<div class="mb-4"><p class="text-[9px] font-black text-indigo-500 uppercase">Stage ${lv}</p><h3 class="font-black text-slate-800 text-lg">Invas√£o ${lv}</h3></div>
                                 <button onclick="${locked ? '' : `startBattle()`}" class="w-full ${locked ? 'bg-slate-300' : 'bg-indigo-600 shadow-lg'} text-white py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest">${locked ? 'Bloqueado' : 'Combater'}</button>`;
                list.appendChild(div);
            });
        };

        const updateHUD = () => {
            const pPct = (state.battle.p.curHp / state.battle.p.maxHp) * 100;
            const ePct = (state.battle.e.curHp / state.battle.e.maxHp) * 100;
            document.getElementById('player-hp-fill').style.width = `${pPct}%`;
            document.getElementById('enemy-hp-fill').style.width = `${ePct}%`;
            document.getElementById('player-hp-pct').innerText = `${Math.ceil(pPct)}%`;
            document.getElementById('enemy-hp-pct').innerText = `${Math.ceil(ePct)}%`;
        };

        const startBattle = () => {
            const pMon = state.inventory[state.leaderIdx];
            const dbData = MONSTERS_DATABASE.find(m => m.emoji === pMon.emoji);
            if(dbData) { pMon.skills = dbData.skills; if(!pMon.spriteUrl) pMon.spriteUrl = dbData.spriteUrl; }

            const eData = MONSTERS_DATABASE[Math.floor(Math.random()*3)];
            state.battle.p = {...pMon, curHp: pMon.hp + (pMon.lvl*10), maxHp: pMon.hp + (pMon.lvl*10), atk: pMon.atk + (pMon.lvl*2)};
            state.battle.e = {...eData, curHp: eData.hp, maxHp: eData.hp, lvl: 15};
            
            renderCharacter(state.battle.p, 'player-sprite-container');
            renderCharacter(state.battle.e, 'enemy-sprite-container');
            
            document.getElementById('enemy-name-lbl').innerText = eData.name;
            document.getElementById('player-lvl-lbl').innerText = `Lv. ${pMon.lvl}`;
            
            renderSkills(); updateHUD();
            state.battle.busy = false; state.battle.turn = 'player';
            document.getElementById('combat-log').innerText = "Tua Vez!";
            changeView('view-battle');
        };

        const renderSkills = () => {
            const grid = document.getElementById('skill-grid'); grid.innerHTML = '';
            state.battle.p.skills.forEach(sk => {
                const s = SKILL_LIBRARY[sk];
                const isSup = sk.includes('sup');
                const btn = document.createElement('button');
                btn.className = `backdrop-blur-md border p-4 rounded-3xl flex flex-col items-center justify-center space-y-1 active:scale-90 transition-all ${isSup ? 'bg-amber-500/20 border-amber-300/40 shadow-[0_0_15px_rgba(251,191,36,0.2)]' : 'bg-white/10 border-white/20'}`;
                btn.innerHTML = `<span class="text-2xl drop-shadow-md">${s.icon}</span><span class="text-[8px] font-black text-white uppercase">${s.n}</span>`;
                btn.onclick = () => performSequence(sk);
                grid.appendChild(btn);
            });
        };

        const performSequence = async (skillKey) => {
            if(state.battle.busy || state.battle.turn !== 'player') return;
            state.battle.busy = true;
            const pEnt = document.getElementById('ent-player');
            const pVis = document.getElementById('player-sprite-container');
            const skill = SKILL_LIBRARY[skillKey];
            const isSup = skillKey.includes('sup');

            document.getElementById('combat-log').innerText = `USANDO ${skill.n.toUpperCase()}!`;

            if(skill.t === 'melee') {
                // F√≠sico: Gira e Avan√ßa
                pVis.classList.add('anim-spin-atk');
                pEnt.classList.add('anim-melee-player');
                await sleep(500);
            } else {
                // Magia: S√ì Brilha/Flutua (sem giro, sem avan√ßo)
                pEnt.classList.add('anim-channeling');
                await sleep(400);
                await spawnParticles(true, skill.t, isSup ? 10 : 1);
            }

            triggerImpact('ent-enemy');
            applyDmg(state.battle.p, state.battle.e, skill, 'ent-enemy');

            setTimeout(() => {
                pVis.classList.remove('anim-spin-atk');
                pEnt.classList.remove('anim-melee-player', 'anim-channeling');
            }, 200);

            if(state.battle.e.curHp <= 0) {
                document.getElementById('combat-log').innerText = "VIT√ìRIA!";
                state.crystals += 60; state.mana += 350; save(); updateStats();
                setTimeout(() => changeView('view-home'), 2000);
            } else {
                state.battle.turn = 'enemy';
                setTimeout(enemyTurn, 1200);
            }
        };

        const enemyTurn = async () => {
            const eEnt = document.getElementById('ent-enemy');
            const eVis = document.getElementById('enemy-sprite-container');
            const skillKey = state.battle.e.skills[Math.floor(Math.random() * state.battle.e.skills.length)];
            const skill = SKILL_LIBRARY[skillKey];
            const isSup = skillKey.includes('sup');
            
            document.getElementById('combat-log').innerText = `${state.battle.e.name} usou ${skill.n}!`;

            if(skill.t === 'melee') {
                 // Inimigo F√≠sico: Gira e Avan√ßa
                 eVis.classList.add('anim-spin-atk');
                 eEnt.classList.add('anim-melee-enemy');
                 await sleep(500);
            } else {
                 // Inimigo Magia: S√ì Brilha
                 eEnt.classList.add('anim-channeling');
                 await sleep(400);
                 await spawnParticles(false, skill.t, isSup ? 10 : 1);
            }

            triggerImpact('ent-player');
            applyDmg(state.battle.e, state.battle.p, skill, 'ent-player');

            setTimeout(() => {
                eVis.classList.remove('anim-spin-atk');
                eEnt.classList.remove('anim-melee-enemy', 'anim-channeling');
            }, 200);

            if(state.battle.p.curHp <= 0) {
                document.getElementById('combat-log').innerText = "DERROTA...";
                setTimeout(() => changeView('view-home'), 2000);
            } else {
                state.battle.turn = 'player';
                state.battle.busy = false;
                document.getElementById('combat-log').innerText = "TUA VEZ!";
            }
        };

        const applyDmg = (att, def, s, tid) => {
            const dmg = Math.floor(att.atk * s.p * (0.9 + Math.random() * 0.2));
            def.curHp = Math.max(0, def.curHp - dmg);
            updateHUD();
            
            // O ALVO sempre sofre recoil
            const visual = document.getElementById(tid === 'ent-player' ? 'player-sprite-container' : 'enemy-sprite-container');
            visual.classList.add('anim-hit-recoil');
            setTimeout(() => visual.classList.remove('anim-hit-recoil'), 500);

            const pop = document.createElement('div');
            pop.className = 'dmg-text'; pop.innerText = `-${dmg}`;
            document.getElementById(tid).appendChild(pop);
            setTimeout(() => pop.remove(), 800);
        };

        const spawnParticles = async (toEnemy, type, count = 1) => {
            const layer = document.getElementById('effect-layer');
            const tX = toEnemy ? 'var(--e-x)' : 'var(--p-x)';
            const tY = toEnemy ? 'var(--e-y)' : 'var(--p-y)';
            const oX = toEnemy ? 'var(--p-x)' : 'var(--e-x)';
            const oY = toEnemy ? 'var(--p-y)' : 'var(--e-y)';
            
            for(let i=0; i < (count === 1 ? 3 : 15); i++) {
                const p = document.createElement('div');
                p.className = `particle p-${type}`;
                const randX = count > 1 ? (Math.random() * 60 - 30) : 0;
                const randY = count > 1 ? (Math.random() * 60 - 30) : 0;
                p.style.setProperty('--origin', `translateX(${oX}) translateY(${oY}) translateZ(0)`);
                p.style.setProperty('--destination', `translateX(calc(${tX} + ${randX}px)) translateY(calc(${tY} + ${randY}px)) translateZ(${toEnemy ? '-400px' : '200px'})`);
                if(i > 0) p.style.animationDelay = `${i * 0.05}s`;
                layer.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
            if(type === 'lightning') {
                const f = document.getElementById('flash-effect');
                f.style.opacity = "0.6"; setTimeout(() => f.style.opacity = "0", 150);
            }
        };

        const triggerImpact = (tid) => {
            const arena = document.getElementById('arena');
            arena.classList.add('screen-shake');
            setTimeout(() => arena.classList.remove('screen-shake'), 300);
            const r = document.createElement('div'); r.className = 'hit-ring';
            document.getElementById(tid).appendChild(r);
            setTimeout(() => r.remove(), 500);
        };

        const doSummon = () => {
            if (state.crystals < 75) return;
            state.crystals -= 75;
            const res = MONSTERS_DATABASE[Math.floor(Math.random()*3)];
            state.inventory.push({...res, lvl: 1, curHp: res.hp});
            
            // Summon com Sprite
            const box = document.getElementById('summon-box');
            if (res.spriteUrl) {
                box.innerHTML = `<img src="${res.spriteUrl}" class="w-full h-full object-contain drop-shadow-lg animate-bounce" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"> <span style="display:none" class="text-7xl">${res.emoji}</span>`;
            } else {
                box.innerHTML = res.emoji;
            }
            
            save(); updateStats();
            setTimeout(() => { box.innerHTML = 'üéÅ'; }, 2000);
        };

        const sleep = ms => new Promise(r => setTimeout(r, ms));

        window.onload = init;
    </script>
</body>
</html>


