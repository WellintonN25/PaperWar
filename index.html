<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PaperWar - Battle Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 0.1s ease-out',
                        'toast-slide': 'toast-slide 0.3s ease-out forwards',
                        'toast-fade': 'toast-fade 0.3s ease-in forwards',
                        'shine-gold': 'shine-gold 1s ease-in-out infinite'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        flash: { '0%': { opacity: 0 }, '50%': { opacity: 0.8 }, '100%': { opacity: 0 } },
                        'toast-slide': { '0%': { transform: 'translateY(-20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        'toast-fade': { '0%': { opacity: 1 }, '100%': { opacity: 0 } },
                        'shine-gold': { '0%, 100%': { boxShadow: '0 0 20px #fbbf24' }, '50%': { boxShadow: '0 0 50px #fbbf24, 0 0 20px white' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap');

        :root {
            --p-x: 35px; --p-y: 60px; --p-z: 250px;
            --e-x: -35px; --e-y: -100px; --e-z: -450px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617; 
            margin: 0; padding: 0; 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
            display: flex; align-items: center; justify-content: center;
        }

        #app { 
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        .scroll-container {
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        .hidden-view { display: none !important; }

        /* --- UI ELEMENTS --- */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        .sw-slot {
            position: relative;
            background: radial-gradient(circle at center, #334155 0%, #0f172a 100%);
            border: 2px solid #475569;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.1s;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .sw-slot:active { transform: scale(0.95); }
        .sw-slot.selected { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }
        
        .star-row { 
            display: flex; gap: 0px; justify-content: center; 
            position: absolute; bottom: 4px; width: 100%; z-index: 20;
            filter: drop-shadow(0 1px 2px black);
        }
        .star-icon { font-size: 10px; color: #fbbf24; letter-spacing: -2px; }

        .elem-badge {
            position: absolute; top: 4px; right: 4px;
            width: 14px; height: 14px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.3); z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .bg-fire { background: #ef4444; }
        .bg-water { background: #3b82f6; }
        .bg-lightning { background: #eab308; }
        .bg-earth { background: #a8a29e; }
        .bg-nature { background: #22c55e; }
        .bg-void { background: #a855f7; }

        /* --- 3D SCENE --- */
        .battle-scene {
            perspective: 1200px; perspective-origin: 50% 35%;
            overflow: hidden;
            background: linear-gradient(to bottom, rgba(2, 6, 23, 0.5), rgba(2, 6, 23, 0.95)), 
                        url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?auto=format&fit=crop&q=80&w=1000') no-repeat center center;
            background-size: cover;
            display: flex; flex-direction: column; height: 100%;
        }

        .arena-container {
            position: relative; width: 100%; flex: 1;
            transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center;
        }

        #effect-layer {
            position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            overflow: visible; transform-style: preserve-3d; z-index: 100;
        }

        .ground-plane {
            position: absolute; width: 300%; height: 300%;
            background-image: 
                radial-gradient(circle at center, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 100% 100%, 80px 80px, 80px 80px;
            transform: rotateX(75deg) translateY(25%);
            bottom: -40%; z-index: 1;
        }

        .sprite-renderer {
            width: 160px; height: 160px;
            display: flex; align-items: center; justify-content: center;
            transform-style: preserve-3d;
            transition: transform 0.4s ease;
        }
        #player-sprite-container { transform: rotateY(30deg) rotateX(5deg); }
        #enemy-sprite-container { transform: rotateY(-30deg) rotateX(5deg); }

        .sprite-renderer img {
            max-width: 100%; max-height: 100%; object-fit: contain;
            filter: drop-shadow(0 20px 25px rgba(0,0,0,0.6));
            animation: breathing 3s ease-in-out infinite;
        }

        @keyframes breathing { 0%, 100% { transform: scale(1) translateY(0); } 50% { transform: scale(1.03) translateY(-4px); } }

        /* VFX Classes */
        .anim-spin-atk { animation: spin-attack 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes spin-attack { 
            0% { transform: rotateY(30deg) rotateZ(0deg); } 
            50% { transform: rotateY(210deg) rotateZ(15deg) scale(1.2); } 
            100% { transform: rotateY(390deg) rotateZ(0deg); } 
        }

        .anim-hit-recoil { animation: hit-recoil 0.4s ease-out; }
        @keyframes hit-recoil { 
            0% { filter: brightness(1); transform: translateX(0); } 
            20% { filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5); transform: translateX(-10px) rotateZ(-5deg); } 
            100% { filter: brightness(1); transform: translateX(0); } 
        }

        .anim-hit-spin { animation: hit-spin 0.6s ease-out; }
        @keyframes hit-spin {
            0% { filter: brightness(1); transform: rotateY(0deg) translateX(0); }
            15% { filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5); transform: rotateY(180deg) translateX(-15px) scale(0.9); }
            40% { transform: rotateY(360deg) translateX(-5px) scale(1); }
            60% { transform: rotateY(380deg) translateX(0); }
            100% { filter: brightness(1); transform: rotateY(360deg) translateX(0); }
        }

        .anim-cast { animation: cast-pulse 0.6s ease-in-out; }
        @keyframes cast-pulse {
            0% { filter: brightness(1) drop-shadow(0 0 0 transparent); transform: scale(1); }
            50% { filter: brightness(1.5) drop-shadow(0 0 30px currentColor); transform: scale(1.1); }
            100% { filter: brightness(1) drop-shadow(0 0 0 transparent); transform: scale(1); }
        }

        .projectile {
            position: absolute; width: 40px; height: 40px;
            z-index: 100; pointer-events: none;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .vfx-fireball { background: radial-gradient(circle, #fff, #fbbf24, #ef4444); border-radius: 50%; width: 50px; height: 50px; box-shadow: 0 0 20px #ef4444; }
        .vfx-waterball { background: radial-gradient(circle, #fff, #60a5fa, #2563eb); border-radius: 50%; width: 45px; height: 45px; opacity: 0.9; box-shadow: 0 0 20px #3b82f6; }
        .vfx-rock { background: #57534e; border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; width: 45px; height: 45px; border: 2px solid #292524; }
        .vfx-leaf { background: #4ade80; border-radius: 0 50% 0 50%; width: 30px; height: 30px; border: 1px solid #166534; }
        .vfx-void { background: #000; border: 2px solid #a855f7; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 0 15px #a855f7; }

        .vfx-lightning-strike {
            position: absolute; top: -300px; width: 12px; height: 600px;
            background: white; box-shadow: 0 0 20px #facc15, 0 0 50px #facc15;
            transform: translateX(-50%) skewX(-5deg);
            animation: flash 0.15s ease-out forwards;
            z-index: 101; pointer-events: none;
        }

        .vfx-blackhole {
            position: absolute; width: 100px; height: 100px; border-radius: 50%;
            background: radial-gradient(circle, #000, #4c1d95, transparent);
            box-shadow: 0 0 50px #4c1d95;
            z-index: 99; pointer-events: none;
        }

        .entity-wrapper {
            position: absolute; transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10;
        }
        .pos-enemy { transform: translateX(var(--e-x)) translateY(var(--e-y)) translateZ(var(--e-z)); }
        .pos-player { transform: translateX(var(--p-x)) translateY(var(--p-y)) translateZ(var(--p-z)); }

        .anim-melee-player { transform: translateX(-15px) translateY(-50px) translateZ(-350px) scale(1.1); }
        .anim-melee-enemy { transform: translateX(15px) translateY(50px) translateZ(150px) scale(1.1); }
        
        .character-shadow {
            position: absolute; bottom: -5px; left: 50%; width: 120px; height: 30px;
            background: rgba(0, 0, 0, 0.8); border-radius: 50%;
            transform: translateX(-50%) rotateX(80deg); filter: blur(12px);
            z-index: -1;
        }

        .hud-bar { background: rgba(0,0,0,0.8); border-radius: 99px; height: 6px; overflow: hidden; }
        .hud-fill { height: 100%; border-radius: 99px; transition: width 0.4s ease-out; }

        @keyframes float-dmg { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }
        .dmg-text { 
            position: absolute; color: #f87171; font-weight: 900; font-size: 3rem; 
            text-shadow: 2px 2px 0px #000, 0 0 10px #7f1d1d;
            animation: float-dmg 0.8s ease-out forwards; z-index: 100;
            left: 50%; top: -100px; margin-left: -50px; width: 100px; text-align: center;
        }
        
        .flash-screen {
            position: absolute; inset: 0; background: white; z-index: 200; pointer-events: none;
            animation: flash 0.15s ease-out forwards;
        }
        
        .shine-bg {
            animation: shine-gold 2s infinite;
            border: 2px solid #fbbf24;
        }

        /* --- TOAST SYSTEM --- */
        #toast-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 300px;
        }
        .toast {
            background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 16px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 8px;
            animation: toast-slide 0.3s ease-out forwards;
        }
        .toast.error { border-color: #ef4444; } .toast.success { border-color: #22c55e; } .toast.info { border-color: #3b82f6; }
        .toast-icon { font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="app" class="w-full h-full max-w-md bg-slate-950 relative shadow-2xl flex flex-col sm:h-[94vh] sm:rounded-[2.5rem] border-slate-800 border-[8px]">

        <div id="screen-flash" class="hidden"></div>
        <div id="toast-container"></div>

        <!-- LOGIN -->
        <main id="view-login" class="flex-1 flex flex-col items-center justify-center p-8 bg-[url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?auto=format&fit=crop&q=80&w=1000')] bg-cover bg-center relative">
            <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
            <div class="relative z-10 w-full flex flex-col items-center">
                <h1 class="text-7xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-cyan-300 mb-2 drop-shadow-lg">PAPER<br>WAR</h1>
                <p class="text-indigo-200 uppercase tracking-[0.3em] text-[10px] font-bold mb-12">Tactical RPG Simulator</p>
                <div class="w-full glass-panel p-6 rounded-3xl space-y-4">
                    <input type="text" id="login-name" placeholder="Nome do Comandante..." class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl px-5 py-4 font-bold text-white outline-none focus:border-indigo-500 transition-colors">
                    <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase tracking-wider shadow-lg active:scale-95 transition-all">Jogar</button>
                </div>
            </div>
        </main>

        <!-- HEADER -->
        <header id="ui-header" class="px-5 py-4 bg-slate-950/90 backdrop-blur-md border-b border-white/5 hidden justify-between items-center z-[50] shrink-0">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="changeView('view-home')">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg relative">
                    <span id="header-initial">P</span>
                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-black rounded-full flex items-center justify-center text-[9px] font-bold border border-white" id="header-lvl">1</div>
                </div>
                <div class="leading-tight">
                    <p class="text-[9px] font-bold text-slate-400 uppercase">Comandante</p>
                    <p id="player-name-ui" class="font-bold text-white text-sm truncate max-w-[100px]">---</p>
                    <!-- XP BAR -->
                    <div class="w-16 h-1 bg-slate-800 rounded-full mt-0.5 overflow-hidden border border-white/10">
                        <div id="header-xp-bar" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="bg-slate-800/80 border border-white/5 px-2 py-1 rounded-lg flex items-center space-x-1" title="Energia"><span class="text-xs">‚ö°</span><span id="val-energy" class="text-[10px] font-bold text-yellow-400">0</span></div>
                <div class="bg-slate-800/80 border border-white/5 px-2 py-1 rounded-lg flex items-center space-x-1" title="Mana"><span class="text-xs">üíß</span><span id="val-mana" class="text-[10px] font-bold text-blue-400">0</span></div>
                <div class="bg-slate-800/80 border border-white/5 px-2 py-1 rounded-lg flex items-center space-x-1" title="Cristais"><span class="text-xs">üíé</span><span id="val-crystals" class="text-[10px] font-bold text-cyan-400">0</span></div>
            </div>
        </header>

        <!-- HOME -->
        <main id="view-home" class="scroll-container flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950 hidden-view scroll-smooth pb-24">
            <div class="relative w-full h-40 rounded-[2rem] overflow-hidden group cursor-pointer shadow-2xl" onclick="changeView('view-story')">
                <img src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&q=80&w=800" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/40 to-transparent"></div>
                <div class="absolute bottom-6 left-6">
                    <p class="text-indigo-400 font-bold text-[10px] uppercase tracking-widest mb-1">Modo Hist√≥ria</p>
                    <h2 class="text-3xl font-black text-white italic uppercase leading-none">Campanha</h2>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="changeView('view-dungeon')" class="glass-panel p-4 rounded-3xl text-left active:scale-95 transition-all relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] text-6xl opacity-10">üóùÔ∏è</div>
                    <div class="w-10 h-10 rounded-xl bg-purple-500/20 text-purple-400 flex items-center justify-center text-xl mb-3">üóùÔ∏è</div>
                    <h3 class="text-white font-bold uppercase text-sm">Masmorra</h3>
                    <p class="text-slate-400 text-[10px] mt-1">Farm de Mana</p>
                </button>
                <button onclick="changeView('view-tower')" class="glass-panel p-4 rounded-3xl text-left active:scale-95 transition-all border-yellow-500/20 relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] text-6xl opacity-10">üè∞</div>
                    <div class="w-10 h-10 rounded-xl bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xl mb-3">üè∞</div>
                    <h3 class="text-white font-bold uppercase text-sm">Torre</h3>
                    <p class="text-slate-400 text-[10px] mt-1">Ascens√£o</p>
                </button>
            </div>

            <div class="space-y-3">
                <div onclick="changeView('view-shop')" class="glass-panel p-4 rounded-2xl flex items-center space-x-4 cursor-pointer bg-gradient-to-r from-amber-900/40 to-slate-900">
                    <div class="w-12 h-12 bg-amber-600 rounded-xl flex items-center justify-center text-2xl">üõí</div>
                    <div class="flex-1">
                        <h4 class="text-white font-bold uppercase">Loja</h4>
                        <p class="text-amber-200 text-xs">Comprar Recursos</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div onclick="changeView('view-collection')" class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-center">
                        <div class="text-2xl mb-2">üé¥</div>
                        <h4 class="text-white font-bold uppercase text-xs">Monstros</h4>
                    </div>
                    <!-- The button that caused the error: corrected to point to existing view-summon -->
                    <div onclick="changeView('view-summon')" class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-center">
                        <div class="text-2xl mb-2">üì¶</div>
                        <h4 class="text-white font-bold uppercase text-xs">Summon</h4>
                    </div>
                </div>
            </div>
        </main>

        <!-- PRE-BATTLE PREPARATION -->
        <main id="view-prep" class="flex-1 hidden-view bg-slate-950 flex flex-col p-6 relative">
            <button onclick="changeView('view-home')" class="mb-4 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max">‚Üê Cancelar</button>
            
            <h2 class="text-2xl font-black text-white uppercase italic mb-1">Batalha</h2>
            <p id="prep-title" class="text-indigo-400 text-xs font-bold uppercase mb-6">Masmorra B10</p>

            <div class="flex-1 flex flex-col space-y-6">
                <!-- Selected Unit -->
                <div class="glass-panel p-6 rounded-3xl flex flex-col items-center relative">
                    <div class="text-white text-xs font-bold uppercase mb-2">Seu Campe√£o</div>
                    <div class="w-24 h-24 rounded-full bg-slate-800 border-2 border-indigo-500 overflow-hidden relative mb-4">
                        <img id="prep-img" src="" class="w-full h-full object-contain">
                        <div id="prep-el" class="absolute top-0 right-0 w-6 h-6 rounded-full bg-red-500 border border-white flex items-center justify-center text-xs">üî•</div>
                    </div>
                    <h3 id="prep-name" class="text-xl font-bold text-white mb-1">Nome</h3>
                    <p id="prep-stats" class="text-xs text-slate-400">Atk: 0 | HP: 0</p>
                    
                    <button onclick="document.getElementById('prep-roster').classList.remove('hidden')" class="absolute top-4 right-4 bg-slate-700/50 p-2 rounded-lg text-xs text-white hover:bg-slate-600">‚Ü∫ Trocar</button>
                </div>

                <!-- Start Button -->
                <div class="mt-auto">
                    <div class="flex justify-between text-xs text-slate-400 font-bold mb-2 px-2">
                        <span>Custo Energia:</span>
                        <span class="text-yellow-400" id="prep-cost">5 ‚ö°</span>
                    </div>
                    <button onclick="confirmBattle()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl text-white font-black uppercase text-lg shadow-lg active:scale-95 transition-transform">
                        INICIAR
                    </button>
                </div>
            </div>

            <!-- Mini Roster Selector Overlay -->
            <div id="prep-roster" class="scroll-container absolute inset-0 bg-slate-950/95 z-20 flex flex-col p-4 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-bold">Escolha seu Monstro</h3>
                    <button onclick="document.getElementById('prep-roster').classList.add('hidden')" class="text-white text-xl">‚úï</button>
                </div>
                <div id="prep-grid" class="grid grid-cols-4 gap-3 overflow-y-auto pb-4"></div>
            </div>
        </main>

        <!-- MASMORRA (DUNGEON SELECT) -->
        <main id="view-dungeon" class="flex-1 hidden-view bg-slate-950 p-6 flex flex-col">
            <button onclick="changeView('view-home')" class="mb-4 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max">‚Üê Voltar</button>
            <h2 class="text-3xl font-black text-white uppercase italic mb-6">Masmorra</h2>
            <div class="scroll-container flex-1 overflow-y-auto space-y-3 pr-2" id="dungeon-list"></div>
        </main>

        <!-- TOWER SELECT -->
        <main id="view-tower" class="flex-1 hidden-view bg-slate-950 p-6 flex flex-col items-center justify-center relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <button onclick="changeView('view-home')" class="absolute top-6 left-6 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max z-10">‚Üê Voltar</button>
            <div class="relative z-10 text-center space-y-6">
                <div class="w-32 h-32 mx-auto bg-yellow-500/20 rounded-full flex items-center justify-center border-4 border-yellow-500/50 shadow-[0_0_50px_rgba(234,179,8,0.3)]"><span class="text-6xl">üè∞</span></div>
                <div><p class="text-yellow-500 font-bold uppercase tracking-widest text-sm mb-2">Andar Atual</p><h2 class="text-6xl font-black text-white" id="tower-floor-display">1</h2></div>
                <div class="glass-panel p-4 rounded-xl max-w-xs mx-auto"><p class="text-slate-300 text-xs mb-1">Recompensa Prevista</p><p class="text-white font-bold">üíé 50 Cristais + üíß 100 Mana</p></div>
                <button onclick="openPrep('tower', state.towerFloor)" class="px-12 py-4 bg-yellow-600 hover:bg-yellow-500 text-white font-black uppercase rounded-2xl shadow-lg active:scale-95 transition-all">DESAFIAR</button>
            </div>
        </main>

        <!-- SHOP -->
        <main id="view-shop" class="flex-1 hidden-view bg-slate-950 flex flex-col p-6 relative">
            <button onclick="changeView('view-home')" class="mb-6 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max">‚Üê Voltar</button>
            <h2 class="text-3xl font-black text-white uppercase italic mb-8">Loja</h2>
            <div class="scroll-container flex-1 space-y-3 overflow-y-auto">
                <h4 class="text-white font-bold text-sm uppercase mt-2">Invoca√ß√µes</h4>
                <!-- Bilhete Comum - Custa Mana -->
                <div class="glass-panel p-4 rounded-3xl flex items-center justify-between">
                    <div class="flex items-center space-x-3"><div class="text-2xl">üìú</div><div><h3 class="text-white font-bold">Bilhete Comum</h3><p class="text-[9px] text-slate-400">1-3 Estrelas</p></div></div>
                    <button onclick="buyShopItem('ticket_common')" class="bg-blue-600 px-4 py-2 rounded-xl text-white font-bold text-xs">2000 üíß</button>
                </div>
                <!-- Bilhete Epico - Custa Cristais -->
                <div class="glass-panel p-4 rounded-3xl flex items-center justify-between border border-amber-500/30">
                    <div class="flex items-center space-x-3"><div class="text-2xl">üé´</div><div><h3 class="text-white font-bold">Bilhete √âpico</h3><p class="text-[9px] text-slate-400">3-5 Estrelas</p></div></div>
                    <button onclick="buyShopItem('ticket_epic')" class="bg-amber-600 px-4 py-2 rounded-xl text-white font-bold text-xs">300 üíé</button>
                </div>

                <h4 class="text-white font-bold text-sm uppercase mt-4">Recursos</h4>
                <div class="glass-panel p-4 rounded-3xl flex items-center justify-between">
                    <div class="flex items-center space-x-3"><div class="text-2xl">‚ö°</div><div><h3 class="text-white font-bold">50 Energia</h3></div></div>
                    <button onclick="buyShopItem('energy')" class="bg-yellow-600 px-4 py-2 rounded-xl text-white font-bold text-xs">50 üíé</button>
                </div>
                <div class="glass-panel p-4 rounded-3xl flex items-center justify-between">
                    <div class="flex items-center space-x-3"><div class="text-2xl">üß™</div><div><h3 class="text-white font-bold">1x XP Potion</h3><p class="text-[9px] text-slate-400">+1 N√≠vel</p></div></div>
                    <button onclick="buyShopItem('xp_pot')" class="bg-blue-600 px-4 py-2 rounded-xl text-white font-bold text-xs">500 üíß</button>
                </div>
                <div class="glass-panel p-4 rounded-3xl flex items-center justify-between border border-blue-500/30">
                    <div class="flex items-center space-x-3"><div class="text-2xl">üß™</div><div><h3 class="text-white font-bold">10x XP Potions</h3><p class="text-[9px] text-slate-400">Bulk</p></div></div>
                    <button onclick="buyShopItem('xp_pot10')" class="bg-blue-800 px-4 py-2 rounded-xl text-white font-bold text-xs">4500 üíß</button>
                </div>
            </div>
            <div class="mt-4 glass-panel p-4 rounded-xl flex justify-between text-xs">
                <div>üíé <span id="shop-crystals" class="text-cyan-400 font-bold">0</span></div>
                <div>üíß <span id="shop-mana" class="text-blue-400 font-bold">0</span></div>
            </div>
        </main>

        <!-- MONSTER BOX -->
        <main id="view-collection" class="scroll-container flex-1 hidden-view bg-slate-950 flex flex-col p-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="changeView('view-home')" class="text-white font-bold text-xs bg-slate-800 px-3 py-2 rounded-lg">‚Üê VOLTAR</button>
                <span class="text-white font-bold uppercase text-xs">Monstros: <span id="mon-count">0</span></span>
            </div>
            <div id="roster-grid" class="grid grid-cols-5 gap-2 content-start overflow-y-auto pb-20"></div>
            <!-- Detail Overlay -->
            <div id="mon-detail-overlay" class="absolute inset-0 z-50 bg-slate-950/95 hidden flex-col">
                <div class="flex-1 relative flex flex-col p-6">
                    <button onclick="closeDetail()" class="absolute top-4 right-4 text-white text-2xl z-20">‚úï</button>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <div>
                            <div class="flex space-x-1 mb-1 text-yellow-400 text-xs" id="det-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                            <h2 id="det-name" class="text-3xl font-black text-white italic uppercase leading-none">NAME</h2>
                            <div class="flex items-center space-x-2 mt-1"><span id="det-nat-grade" class="bg-indigo-600 text-white text-[9px] font-bold px-1.5 py-0.5 rounded border border-white/20">NAT 5</span><p id="det-type" class="text-indigo-400 font-bold text-xs uppercase tracking-widest">Type</p></div>
                        </div>
                        <div id="det-element-badge" class="w-10 h-10 rounded-full flex items-center justify-center text-xl bg-slate-800 border border-white/20">üî•</div>
                    </div>
                    <div class="flex-1 flex items-center justify-center relative my-4">
                        <div class="absolute inset-0 bg-gradient-to-t from-indigo-500/20 to-transparent rounded-full blur-3xl"></div>
                        <img id="det-img" src="" class="h-64 object-contain drop-shadow-2xl animate-float relative z-10" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
                        <span style="display:none;font-size:6rem" class="relative z-10 filter drop-shadow-2xl animate-float" id="det-emoji">üêâ</span>
                    </div>
                    <div class="glass-panel p-5 rounded-3xl space-y-3">
                        <div class="flex justify-between text-white font-bold text-sm border-b border-white/10 pb-2 mb-2"><span>Status</span><span id="det-lvl" class="text-slate-400">Lv. MAX</span></div>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div><span class="text-slate-400 font-bold block">HP</span><span id="val-hp" class="text-white font-mono text-lg">0</span></div>
                            <div><span class="text-slate-400 font-bold block">ATK</span><span id="val-atk" class="text-white font-mono text-lg">0</span></div>
                            <div><span class="text-slate-400 font-bold block">DEF</span><span id="val-def" class="text-white font-mono text-lg">0</span></div>
                            <div><span class="text-slate-400 font-bold block">SPD</span><span class="text-white font-mono text-lg">100</span></div>
                        </div>
                        <div class="flex gap-2 mt-2">
                             <button onclick="equipLeader()" id="btn-equip" class="flex-1 py-3 bg-white text-slate-900 font-black uppercase rounded-xl active:scale-95 transition-all text-xs">Definir L√≠der</button>
                             <button onclick="useXpPotion()" id="btn-xp" class="flex-1 py-3 bg-blue-600 text-white font-black uppercase rounded-xl active:scale-95 transition-all text-xs">Usar Potion</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- STORY -->
        <main id="view-story" class="scroll-container flex-1 overflow-y-auto hidden-view bg-slate-950 p-6 relative">
            <button onclick="changeView('view-home')" class="mb-6 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold">‚Üê Voltar</button>
            <h2 class="text-3xl font-black text-white uppercase italic mb-8">Campanha</h2>
            <div id="story-nodes" class="space-y-6 relative pl-4 border-l-2 border-slate-800"></div>
        </main>

        <!-- BATTLE -->
        <main id="view-battle" class="flex-1 hidden-view battle-scene relative">
            <!-- Top HUD -->
            <div class="absolute top-0 w-full p-4 z-50 flex justify-between items-start">
                <div class="glass-panel px-3 py-2 rounded-2xl w-32">
                    <div class="flex justify-between text-[9px] text-white font-bold mb-1"><span id="hud-p-name">HERO</span> <span id="hud-p-hp-txt">100%</span></div>
                    <div class="hud-bar bg-black"><div id="hud-p-hp-bar" class="hud-fill bg-emerald-500" style="width: 100%"></div></div>
                    <!-- Mana Bar -->
                    <div class="mt-1 flex items-center space-x-1">
                        <span class="text-[8px] text-blue-300">MP</span>
                        <div class="flex-1 h-1 bg-black rounded-full overflow-hidden"><div id="hud-p-mp-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 100%"></div></div>
                    </div>
                </div>
                <div class="glass-panel px-3 py-1 rounded-full"><span id="battle-info" class="text-[10px] font-black text-white uppercase tracking-widest">VS</span></div>
                <div class="glass-panel px-3 py-2 rounded-2xl w-32 text-right">
                    <div class="flex justify-between text-[9px] text-white font-bold mb-1"><span id="hud-e-hp-txt">100%</span> <span id="hud-e-name">BOSS</span></div>
                    <div class="hud-bar bg-black"><div id="hud-e-hp-bar" class="hud-fill bg-red-500" style="width: 100%"></div></div>
                </div>
            </div>

            <!-- Auto/Speed Controls -->
            <div class="absolute top-20 right-4 z-50 flex flex-col space-y-2">
                <button id="btn-auto" onclick="toggleAuto()" class="w-10 h-10 rounded-full bg-slate-900/80 border border-white/20 text-xs font-bold text-white flex items-center justify-center opacity-50">AUTO</button>
                <button id="btn-speed" onclick="toggleSpeed()" class="w-10 h-10 rounded-full bg-slate-900/80 border border-white/20 text-xs font-bold text-white flex items-center justify-center opacity-50">1x</button>
            </div>

            <div id="arena" class="arena-container">
                <div class="ground-plane"></div>
                <div id="ent-enemy" class="entity-wrapper pos-enemy">
                    <div id="enemy-sprite-container" class="sprite-renderer"></div>
                    <div class="character-shadow"></div>
                </div>
                <div id="effect-layer"></div>
                <div id="ent-player" class="entity-wrapper pos-player">
                    <div id="player-sprite-container" class="sprite-renderer"></div>
                    <div class="character-shadow"></div>
                </div>
            </div>
            <div class="glass-panel m-4 mb-6 p-4 rounded-[2rem] z-50">
                <div id="combat-log" class="text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-3 h-4">...</div>
                <div id="skill-grid" class="grid grid-cols-4 gap-2"></div>
            </div>
            <div id="battle-overlay" class="absolute inset-0 z-[60] bg-slate-950/90 backdrop-blur-md hidden flex-col items-center justify-center p-8 opacity-0 transition-opacity duration-300">
                <h2 id="outcome-title" class="text-5xl font-black text-white italic uppercase mb-2">FIM</h2>
                <div id="outcome-rewards" class="text-indigo-300 font-bold uppercase text-xs mb-8">Rewards</div>
                <button onclick="closeBattle()" class="px-8 py-3 bg-white text-slate-900 font-black uppercase rounded-full hover:scale-105 transition-transform">Continuar</button>
            </div>
        </main>

        <!-- SUMMON SCREEN (FIXED) -->
        <main id="view-summon" class="flex-1 hidden-view bg-slate-950 flex flex-col items-center justify-center p-8 relative overflow-hidden">
            <button onclick="changeView('view-home')" class="absolute top-6 left-6 text-white font-bold text-xs z-20">‚Üê VOLTAR</button>
            <div class="absolute top-6 right-6 flex flex-col items-end space-y-1">
                <div class="flex items-center bg-slate-900/80 px-3 py-1.5 rounded-full border border-white/10"><span class="mr-2 text-xl">üìú</span><span id="summon-tickets-common" class="text-white font-bold">0</span></div>
                <div class="flex items-center bg-slate-900/80 px-3 py-1.5 rounded-full border border-amber-500/30"><span class="mr-2 text-xl">üé´</span><span id="summon-tickets-epic" class="text-amber-400 font-bold">0</span></div>
            </div>
            
            <div id="summon-circle" class="relative z-10 w-64 h-64 flex items-center justify-center mb-8">
                <div class="absolute inset-0 border-2 border-indigo-500/30 rounded-full animate-[spin_10s_linear_infinite]"></div>
                <div id="summon-box" class="text-6xl animate-bounce cursor-pointer">üì¶</div>
                <div id="summon-flash" class="absolute inset-0 bg-white rounded-full scale-0 transition-transform pointer-events-none"></div>
            </div>

            <div class="w-full max-w-sm space-y-3 relative z-10">
                <div class="flex gap-2">
                    <button onclick="doSummon('common', 1)" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">Comum x1</button>
                    <button onclick="doSummon('common', 10)" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">Comum x10</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="doSummon('epic', 1)" class="flex-1 bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">√âpico x1</button>
                    <button onclick="doSummon('epic', 10)" class="flex-1 bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">√âpico x10</button>
                </div>
            </div>
            <p onclick="changeView('view-shop')" class="relative z-10 mt-4 text-xs text-slate-400 underline cursor-pointer">Comprar Bilhetes na Loja</p>

            <!-- RESULTS MODAL -->
            <div id="summon-results" class="absolute inset-0 bg-slate-950/95 z-50 flex flex-col items-center justify-center p-6 hidden">
                <h3 class="text-2xl font-black text-white uppercase italic mb-6">Invoca√ß√£o Conclu√≠da</h3>
                <div id="summon-grid" class="grid grid-cols-5 gap-3 w-full max-w-sm mb-8"></div>
                <button onclick="document.getElementById('summon-results').classList.add('hidden')" class="px-8 py-3 bg-white text-slate-900 font-bold rounded-full">Fechar</button>
            </div>
        </main>

    </div>

    <script>
        // --- DATABASE ---
        const MONSTERS_DB = [
            { id: 'thyron', name: 'Thyron', type: 'Storm Bringer', element: 'lightning', stars: 5, hp: 1400, atk: 210, def: 80, emoji: '‚ö°', img: 'src/Thyron.png', skills: ['melee', 'bolt', 'sup_lightning'] },
            { id: 'neriah', name: 'Neriah', type: 'Ocean Guardian', element: 'water', stars: 5, hp: 1800, atk: 140, def: 120, emoji: 'üåä', img: 'src/Neriah.png', skills: ['melee', 'water', 'sup_water'] },
            { id: 'aelyra', name: 'Aelyra', type: 'Flame Witch', element: 'fire', stars: 5, hp: 1300, atk: 230, def: 60, emoji: 'üî•', img: 'src/Aelyra.png', skills: ['melee', 'fire', 'sup_fire'] },
            { id: 'kaelthar', name: 'Kaelthar', type: 'Shadow Knight', element: 'void', stars: 4, hp: 1600, atk: 180, def: 100, emoji: 'üåë', img: 'src/Kaelthar.png', skills: ['melee', 'void_slash', 'sup_void'] },
            { id: 'dhorak', name: 'Dhorak', type: 'Earth Golem', element: 'earth', stars: 4, hp: 2200, atk: 110, def: 180, emoji: 'üóø', img: 'src/Dhorak.png', skills: ['melee', 'rock_throw', 'sup_earth'] },
            { id: 'vireya', name: 'Vireya', type: 'Nature Spirit', element: 'nature', stars: 3, hp: 1200, atk: 150, def: 90, emoji: 'üçÉ', img: 'src/Vireya.png', skills: ['melee', 'leaf_cutter'] },
            { id: 'brann', name: 'Brann', type: 'Fire Warrior', element: 'fire', stars: 3, hp: 1100, atk: 160, def: 70, emoji: 'üî•', img: 'src/Brann.png', skills: ['melee', 'fire'] },
            { id: 'lysara', name: 'Lysara', type: 'Frost Mage', element: 'water', stars: 3, hp: 1050, atk: 170, def: 60, emoji: '‚ùÑÔ∏è', img: 'src/Lysara.png', skills: ['melee', 'water'] },
            { id: 'lumem', name: 'Lumem', type: 'Light Fairy', element: 'lightning', stars: 2, hp: 900, atk: 190, def: 50, emoji: '‚ú®', img: 'src/Lumem.png', skills: ['melee', 'bolt'] },
            { id: 'ravok', name: 'Ravok', type: 'Orc Grunt', element: 'earth', stars: 2, hp: 1200, atk: 130, def: 60, emoji: 'üëπ', img: 'src/Ravok.png', skills: ['melee', 'rock_throw'] },
            { id: 'slime', name: 'Slime', type: 'Blob', element: 'water', stars: 1, hp: 600, atk: 80, def: 40, emoji: 'üíß', img: '', skills: ['melee'] },
            { id: 'bat', name: 'Bat', type: 'Cave Bat', element: 'void', stars: 1, hp: 500, atk: 90, def: 20, emoji: 'ü¶á', img: '', skills: ['melee'] }
        ];

        // ADDED MP COSTS
        const SKILLS = {
            'melee': { n: 'Ataque', p: 1.0, icon: '‚öîÔ∏è', type: 'phys', mp: 0 },
            'bolt': { n: 'Raio', p: 1.5, icon: '‚ö°', type: 'lightning', mp: 20 },
            'water': { n: 'Jato', p: 1.4, icon: 'üíß', type: 'water', mp: 20 },
            'fire': { n: 'Brasa', p: 1.6, icon: 'üî•', type: 'fire', mp: 20 },
            'void_slash': { n: 'Corte Vazio', p: 1.8, icon: 'üåë', type: 'void', mp: 25 },
            'rock_throw': { n: 'Rocha', p: 1.5, icon: 'ü™®', type: 'earth', mp: 20 },
            'leaf_cutter': { n: 'Folha', p: 1.4, icon: 'üçÉ', type: 'nature', mp: 20 },
            'sup_lightning': { n: 'Tempestade', p: 3.0, icon: 'üå©Ô∏è', type: 'lightning_sup', mp: 50 },
            'sup_water': { n: 'Tsunami', p: 2.8, icon: 'üåä', type: 'water_sup', mp: 50 },
            'sup_fire': { n: 'Chuva Meteoros', p: 3.2, icon: 'üåã', type: 'fire_sup', mp: 50 },
            'sup_earth': { n: 'Avalanche', p: 3.0, icon: 'üèöÔ∏è', type: 'earth_sup', mp: 50 },
            'sup_void': { n: 'Devasta√ß√£o', p: 3.5, icon: '‚ö´', type: 'void_sup', mp: 60 }
        };

        let state = { 
            user: { name: "", crystals: 200, energy: 100, mana: 0, tickets_common: 0, tickets_epic: 0, lvl: 1, xp: 0, potions: 0, firstClear: {} },
            inventory: [], 
            leaderIdx: 0, 
            storyProgress: 1, 
            towerFloor: 1 
        };
        
        let battleState = { active: false, busy: false, mode: 'dungeon', auto: false, speed: 1 };
        let prepState = { mode: '', level: 1, selectedMonIdx: 0 };

        // --- TOAST SYSTEM ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'info') icon = '‚ÑπÔ∏è';
            
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
            
            container.appendChild(toast);
            
            // Auto remove after animation
            setTimeout(() => {
                toast.style.animation = 'toast-fade 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // --- CORE ---
        const init = () => {
            const saved = localStorage.getItem('paperwar_v11');
            if(saved) {
                state = JSON.parse(saved);
                if(state.user.potions === undefined) state.user.potions = 0;
                if(state.user.lvl === undefined) state.user.lvl = 1;
                if(state.user.firstClear === undefined) state.user.firstClear = {};
                if(state.user.tickets_common === undefined) {
                    state.user.tickets_common = state.user.tickets || 0;
                    state.user.tickets_epic = 0;
                    delete state.user.tickets;
                }
                state.inventory.forEach(m => {
                    const db = MONSTERS_DB.find(x => x.id === m.id);
                    if(db) { 
                        if(!m.img) m.img = db.img; 
                        if(!m.emoji) m.emoji = db.emoji; 
                        m.skills = db.skills; m.stars = db.stars;
                    }
                });
            } else { 
                state.user.tickets_epic = 10; 
                state.user.tickets_common = 5; 
                addMonster('thyron'); addMonster('vireya'); addMonster('slime'); 
            }
            if(state.user.name) { document.getElementById('login-name').value = state.user.name; handleLogin(); }
            updateHeader();
        };
        const save = () => localStorage.setItem('paperwar_v11', JSON.stringify(state));

        const handleLogin = () => {
            const val = document.getElementById('login-name').value.trim();
            if(!val) return;
            state.user.name = val;
            document.getElementById('player-name-ui').innerText = val;
            document.getElementById('header-initial').innerText = val[0].toUpperCase();
            save(); changeView('view-home');
        };

        const changeView = (id) => {
            const target = document.getElementById(id);
            if (!target) {
                console.error(`Tentativa de navegar para vista inexistente: ${id}`);
                return;
            }

            document.querySelectorAll('main').forEach(el => el.classList.add('hidden-view'));
            target.classList.remove('hidden-view');
            
            const h = document.getElementById('ui-header');
            if(h) {
                if(['view-login','view-battle','view-summon','view-shop','view-prep'].includes(id)) { 
                    h.classList.remove('flex'); h.classList.add('hidden'); 
                } else { 
                    h.classList.remove('hidden'); h.classList.add('flex'); 
                }
            }
            
            if(id === 'view-collection') renderMonsterBox();
            if(id === 'view-story') renderStory();
            if(id === 'view-summon') updateSummonUI();
            if(id === 'view-shop') updateShopUI();
            if(id === 'view-dungeon') renderDungeonFloors();
            if(id === 'view-tower') document.getElementById('tower-floor-display').innerText = state.towerFloor;
        };

        const updateHeader = () => {
            document.getElementById('val-crystals').innerText = state.user.crystals;
            document.getElementById('val-energy').innerText = state.user.energy;
            document.getElementById('val-mana').innerText = state.user.mana;
            document.getElementById('header-lvl').innerText = state.user.lvl;
            
            const xpReq = 100 * state.user.lvl;
            const pct = Math.min(100, (state.user.xp / xpReq) * 100);
            document.getElementById('header-xp-bar').style.width = `${pct}%`;
        };

        // --- SHOP ---
        const updateShopUI = () => {
            document.getElementById('shop-crystals').innerText = state.user.crystals;
            document.getElementById('shop-mana').innerText = state.user.mana;
        };
        const buyShopItem = (item) => {
            if(item === 'ticket_common') { if(state.user.mana < 2000) return showToast("Mana insuficiente!", "error"); state.user.mana -= 2000; state.user.tickets_common++; }
            if(item === 'ticket_epic') { if(state.user.crystals < 300) return showToast("Cristais insuficientes!", "error"); state.user.crystals -= 300; state.user.tickets_epic++; }
            if(item === 'energy') { if(state.user.crystals < 50) return showToast("Cristais insuficientes!", "error"); state.user.crystals -= 50; state.user.energy+=50; }
            if(item === 'xp_pot') { if(state.user.mana < 500) return showToast("Mana insuficiente!", "error"); state.user.mana -= 500; state.user.potions++; }
            if(item === 'xp_pot10') { if(state.user.mana < 4500) return showToast("Mana insuficiente!", "error"); state.user.mana -= 4500; state.user.potions+=10; }
            save(); updateShopUI(); updateHeader(); showToast("Item comprado com sucesso!");
        };
        const updateSummonUI = () => {
            const elC = document.getElementById('summon-tickets-common');
            const elE = document.getElementById('summon-tickets-epic');
            if(elC) elC.innerText = state.user.tickets_common;
            if(elE) elE.innerText = state.user.tickets_epic;
        };

        // --- DUNGEON & PREP ---
        const renderDungeonFloors = () => {
            const c = document.getElementById('dungeon-list'); c.innerHTML = '';
            for(let i=1; i<=12; i++) {
                const btn = document.createElement('div');
                btn.className = "glass-panel p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform border border-white/5 hover:bg-white/5";
                btn.innerHTML = `<div><h4 class="text-white font-bold">Masmorra B${i}</h4><p class="text-xs text-purple-400">Lv. ${i*5} ‚Ä¢ ${5+Math.floor(i/2)} ‚ö°</p></div><div class="text-white">‚ñ∂</div>`;
                btn.onclick = () => openPrep('dungeon', i);
                c.appendChild(btn);
            }
        };

        const openPrep = (mode, lvl) => {
            prepState = { mode, level: lvl, selectedMonIdx: state.leaderIdx };
            changeView('view-prep');
            const titles = { dungeon: `Masmorra B${lvl}`, tower: `Torre Andar ${lvl}`, story: `Campanha Fase ${lvl}` };
            const costs = { dungeon: 5 + Math.floor(lvl/2), tower: 5, story: 5 };
            document.getElementById('prep-title').innerText = titles[mode];
            document.getElementById('prep-cost').innerText = `${costs[mode]} ‚ö°`;
            renderPrepUnit(); renderPrepRoster();
        };

        const renderPrepUnit = () => {
            const mon = state.inventory[prepState.selectedMonIdx];
            document.getElementById('prep-img').src = mon.img;
            document.getElementById('prep-name').innerText = mon.name;
            document.getElementById('prep-el').innerText = {fire:'üî•', water:'üåä', lightning:'‚ö°', earth:'üóø', nature:'üçÉ', void:'üåë'}[mon.element];
            const m = 1 + (mon.lvl*0.1);
            document.getElementById('prep-stats').innerText = `Atk: ${Math.floor(mon.atk*m)} | HP: ${Math.floor(mon.hp*m)}`;
        };

        const renderPrepRoster = () => {
            const grid = document.getElementById('prep-grid'); grid.innerHTML = '';
            state.inventory.forEach((mon, idx) => {
                const el = document.createElement('div');
                const isSel = idx === prepState.selectedMonIdx;
                el.className = `aspect-square bg-slate-800 rounded-lg p-1 border-2 cursor-pointer ${isSel?'border-green-500':'border-transparent'}`;
                el.innerHTML = `<img src="${mon.img}" class="w-full h-full object-contain">`;
                el.onclick = () => { prepState.selectedMonIdx = idx; renderPrepUnit(); renderPrepRoster(); document.getElementById('prep-roster').classList.add('hidden'); };
                grid.appendChild(el);
            });
        };

        const confirmBattle = () => startBattle(prepState.mode, prepState.level);

        // --- BATTLE ---
        const startBattle = (mode, lvl=1) => {
            const cost = (mode === 'dungeon' ? 5 + Math.floor(lvl/2) : 5);
            if(state.user.energy < cost) return showToast("Sem energia!", "error");
            state.user.energy -= cost; updateHeader();

            battleState = { active: true, mode: mode, busy: false, auto: false, speed: 1 };
            updateBattleControls();
            
            const pBase = state.inventory[prepState.selectedMonIdx];
            const m = 1 + (pBase.lvl * 0.1);
            battleState.player = { 
                ...pBase, 
                curHp: Math.floor(pBase.hp * m), 
                maxHp: Math.floor(pBase.hp * m), 
                atk: Math.floor(pBase.atk * m),
                mp: 50, maxMp: 100 
            };

            setupEnemy(mode, lvl);
            changeView('view-battle');
            renderBattleScene();
            document.getElementById('battle-overlay').classList.add('hidden');
            document.getElementById('battle-overlay').style.opacity = '0';
        };

        const setupEnemy = (mode, lvlArg) => {
            const template = MONSTERS_DB[Math.floor(Math.random() * MONSTERS_DB.length)];
            let lvl = 1;
            if(mode === 'dungeon') lvl = lvlArg * 5;
            else if(mode === 'tower') lvl = lvlArg * 2;
            else lvl = lvlArg * 3;
            
            const m = 1 + (lvl * 0.15);
            battleState.enemy = { ...template, lvl: lvl, curHp: Math.floor(template.hp * m), maxHp: Math.floor(template.hp * m), atk: Math.floor(template.atk * m) };
            
            updateBattleHUD();
            const el = document.getElementById('enemy-sprite-container');
            el.innerHTML = `<img src="${template.img}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"> <span style="display:none;font-size:4rem;filter:drop-shadow(0 10px 10px rgba(0,0,0,0.5))">${template.emoji}</span>`;
        };

        const renderBattleScene = () => {
            const pl = document.getElementById('player-sprite-container');
            pl.innerHTML = `<img src="${battleState.player.img}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"> <span style="display:none;font-size:4rem;filter:drop-shadow(0 10px 10px rgba(0,0,0,0.5))">${battleState.player.emoji}</span>`;
            renderSkillGrid();
        };

        const renderSkillGrid = () => {
            const grid = document.getElementById('skill-grid');
            grid.innerHTML = '';
            grid.className = `grid gap-2 ${battleState.player.skills.length > 2 ? 'grid-cols-3' : 'grid-cols-2'}`;
            
            battleState.player.skills.forEach(k => {
                const s = SKILLS[k]; if(!s) return;
                const canAfford = battleState.player.mp >= s.mp;
                const btn = document.createElement('button');
                btn.className = `bg-slate-800/80 border border-white/10 rounded-xl p-2 flex flex-col items-center transition-all ${canAfford ? 'hover:bg-white/10 active:scale-90' : 'opacity-50 grayscale cursor-not-allowed'}`;
                btn.innerHTML = `
                    <span class="text-xl mb-1">${s.icon}</span>
                    <span class="text-[8px] font-black uppercase text-white">${s.n}</span>
                    ${s.mp > 0 ? `<span class="text-[8px] text-blue-300 font-bold">${s.mp} MP</span>` : ''}
                `;
                btn.onclick = () => { if(canAfford) doPlayerTurn(k); };
                grid.appendChild(btn);
            });
        };

        const doPlayerTurn = async (skillKey) => {
            if(battleState.busy) return;
            battleState.busy = true;
            try {
                const skill = SKILLS[skillKey];
                battleState.player.mp -= skill.mp;
                updateBattleHUD(); renderSkillGrid();

                await executeAction(battleState.player, battleState.enemy, skillKey, true);
                if(battleState.enemy.curHp <= 0) winBattle();
                else {
                    document.getElementById('combat-log').innerText = "Turno Inimigo";
                    setTimeout(doEnemyTurn, 1000 / battleState.speed);
                }
            } catch(e) { console.error(e); battleState.busy = false; }
        };

        const doEnemyTurn = async () => {
            try {
                const skills = battleState.enemy.skills;
                await executeAction(battleState.enemy, battleState.player, skills[Math.floor(Math.random()*skills.length)], false);
                
                battleState.player.mp = Math.min(battleState.player.maxMp, battleState.player.mp + 10);
                updateBattleHUD();
                renderSkillGrid();

                if(battleState.player.curHp <= 0) loseBattle();
                else {
                    document.getElementById('combat-log').innerText = "Sua Vez!";
                    battleState.busy = false;
                    if(battleState.auto) triggerAuto();
                }
            } catch(e) { console.error(e); battleState.busy = false; }
        };

        const triggerAuto = () => {
            const skills = battleState.player.skills;
            for(let i = skills.length - 1; i >= 0; i--) {
                if(battleState.player.mp >= SKILLS[skills[i]].mp) { doPlayerTurn(skills[i]); return; }
            }
            doPlayerTurn('melee');
        };

        const toggleAuto = () => {
            if(state.user.lvl < 2) return showToast("Auto libera no N√≠vel 2!", "info");
            battleState.auto = !battleState.auto; updateBattleControls();
            if(battleState.auto && !battleState.busy) triggerAuto();
        };
        const toggleSpeed = () => {
            if(state.user.lvl < 5) return showToast("3x libera no N√≠vel 5!", "info");
            battleState.speed = battleState.speed === 1 ? 3 : 1; updateBattleControls();
        };
        const updateBattleControls = () => {
            const btnA = document.getElementById('btn-auto');
            const btnS = document.getElementById('btn-speed');
            btnA.className = `w-10 h-10 rounded-full border border-white/20 text-xs font-bold text-white flex items-center justify-center transition-all ${battleState.auto ? 'bg-green-600 opacity-100' : 'bg-slate-900/80 opacity-50'}`;
            btnS.className = `w-10 h-10 rounded-full border border-white/20 text-xs font-bold text-white flex items-center justify-center transition-all ${battleState.speed > 1 ? 'bg-yellow-600 opacity-100' : 'bg-slate-900/80 opacity-50'}`;
            btnS.innerText = battleState.speed + 'x';
        };

        const executeAction = async (att, def, skKey, isPlayer) => {
            const skill = SKILLS[skKey];
            const spd = battleState.speed;
            document.getElementById('combat-log').innerText = `${att.name} usou ${skill.n}!`;
            const attackerEl = document.getElementById(isPlayer ? 'player-sprite-container' : 'enemy-sprite-container');
            const defenderEl = document.getElementById(isPlayer ? 'enemy-sprite-container' : 'player-sprite-container');
            const wrapperAtt = document.getElementById(isPlayer ? 'ent-player' : 'ent-enemy');

            if(skill.type === 'phys') {
                wrapperAtt.classList.add(isPlayer ? 'anim-melee-player' : 'anim-melee-enemy');
                attackerEl.classList.add('anim-spin-atk');
                await sleep(500 / spd);
                wrapperAtt.classList.remove(isPlayer ? 'anim-melee-player' : 'anim-melee-enemy');
                attackerEl.classList.remove('anim-spin-atk');
            } else {
                attackerEl.classList.add('anim-cast');
                await sleep(500 / spd);
                if(skill.type.endsWith('_sup')) await spawnUltimateVFX(skill.type, isPlayer);
                else await spawnVFX(skill.type, isPlayer);
                attackerEl.classList.remove('anim-cast');
            }

            defenderEl.classList.add('anim-hit-recoil');
            defenderEl.querySelector('img').classList.add('anim-hit-spin'); 
            
            setTimeout(() => {
                defenderEl.classList.remove('anim-hit-recoil');
                defenderEl.querySelector('img').classList.remove('anim-hit-spin');
            }, 600 / spd);

            const raw = att.atk * skill.p;
            const dmg = Math.floor(Math.max(10, raw - (def.def * 0.5)));
            def.curHp = Math.max(0, def.curHp - dmg);
            updateBattleHUD();
            showDmgText(dmg, isPlayer ? 'ent-enemy' : 'ent-player');
            await sleep(300 / spd);
        };

        const spawnVFX = async (type, fromPlayer) => {
            const spd = battleState.speed;
            const layer = document.getElementById('effect-layer');
            const pPos = { x: 35, y: 60, z: 250 };
            const ePos = { x: -35, y: -100, z: -450 };
            const start = fromPlayer ? pPos : ePos;
            const end = fromPlayer ? ePos : pPos;

            if(type === 'lightning') {
                const flash = document.getElementById('screen-flash');
                flash.className = 'flash-screen';
                const strike = document.createElement('div');
                strike.className = 'vfx-lightning-strike';
                const tx = fromPlayer ? -35 : 35;
                const ty = fromPlayer ? -100 : 60; 
                strike.style.transform = `translateX(${tx}px) translateY(${ty}px) skewX(-5deg)`;
                layer.appendChild(strike);
                setTimeout(() => { flash.className = 'hidden'; strike.remove(); }, 300 / spd);
                await sleep(300 / spd);
                return;
            }

            const proj = document.createElement('div');
            proj.className = 'projectile';
            if(type.includes('fire')) proj.classList.add('vfx-fireball');
            else if(type.includes('water')) proj.classList.add('vfx-waterball');
            else if(type.includes('earth')) proj.classList.add('vfx-rock');
            else if(type.includes('nature')) proj.classList.add('vfx-leaf');
            else if(type.includes('void')) proj.classList.add('vfx-void');
            else proj.classList.add('vfx-fireball');

            layer.appendChild(proj);
            const anim = proj.animate([
                { transform: `translateX(${start.x}px) translateY(${start.y}px) translateZ(${start.z}px) scale(0.5)` },
                { transform: `translateX(${end.x}px) translateY(${end.y}px) translateZ(${end.z}px) scale(1)` }
            ], { duration: 500 / spd, easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)', fill: 'forwards' });
            await anim.finished;
            proj.remove();
        };

        const spawnUltimateVFX = async (type, fromPlayer) => {
            const spd = battleState.speed;
            const layer = document.getElementById('effect-layer');
            const flash = document.getElementById('screen-flash');
            const pPos = { x: 35, y: 60, z: 250 };
            const ePos = { x: -35, y: -100, z: -450 };
            const targetPos = fromPlayer ? ePos : pPos;
            const startPos = fromPlayer ? pPos : ePos;

            flash.className = 'flash-screen';
            setTimeout(() => flash.className = 'hidden', 300 / spd);

            if(type.includes('lightning')) {
                for(let i=0; i<6; i++) {
                    const strike = document.createElement('div'); strike.className = 'vfx-lightning-strike';
                    const offX = (Math.random() - 0.5) * 100;
                    strike.style.transform = `translateX(${targetPos.x + offX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) skewX(-5deg)`;
                    layer.appendChild(strike);
                    setTimeout(() => strike.remove(), 200 / spd);
                    await sleep(80 / spd);
                }
                return;
            }
            if(type.includes('fire')) {
                const projectiles = [];
                for(let i=0; i<8; i++) {
                    const p = document.createElement('div'); p.className = 'projectile vfx-fireball';
                    p.style.width = '60px'; p.style.height = '60px'; layer.appendChild(p);
                    const sX = startPos.x + (Math.random() - 0.5) * 100;
                    const eX = targetPos.x + (Math.random() - 0.5) * 80;
                    const anim = p.animate([{ transform: `translateX(${sX}px) translateY(${startPos.y - 200}px) translateZ(${startPos.z}px) scale(0.5)` }, { transform: `translateX(${eX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.2)` }], { duration: (400 + Math.random()*200)/spd, easing: 'ease-in', fill: 'forwards' });
                    projectiles.push({el: p, anim: anim}); await sleep(50 / spd);
                }
                await Promise.all(projectiles.map(p => p.anim.finished));
                projectiles.forEach(p => p.el.remove()); return;
            }
            if(type.includes('water')) {
                const projectiles = [];
                for(let i=0; i<10; i++) {
                    const p = document.createElement('div'); p.className = 'projectile vfx-waterball'; layer.appendChild(p);
                    const eX = targetPos.x + (Math.random() - 0.5) * 120;
                    const anim = p.animate([{ transform: `translateX(${startPos.x}px) translateY(${startPos.y}px) translateZ(${startPos.z}px) scale(0.2)` }, { transform: `translateX(${eX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1)` }], { duration: 600/spd, easing: 'cubic-bezier(0,0.5,0.5,1)', fill: 'forwards' });
                    projectiles.push({el: p, anim: anim}); await sleep(30 / spd);
                }
                await sleep(500/spd); projectiles.forEach(p => p.el.remove()); return;
            }
            if(type.includes('earth')) {
                const projectiles = [];
                for(let i=0; i<5; i++) {
                    const p = document.createElement('div'); p.className = 'projectile vfx-rock'; p.style.width = '70px'; p.style.height = '70px'; layer.appendChild(p);
                    const sX = startPos.x + (Math.random() - 0.5) * 150;
                    const eX = targetPos.x + (Math.random() - 0.5) * 50;
                    const anim = p.animate([{ transform: `translateX(${sX}px) translateY(${startPos.y - 150}px) translateZ(${startPos.z}px) scale(0.5) rotate(0deg)` }, { transform: `translateX(${eX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.5) rotate(360deg)` }], { duration: 700/spd, easing: 'ease-in', fill: 'forwards' });
                    projectiles.push({el: p, anim: anim}); await sleep(100/spd);
                }
                await sleep(600/spd); projectiles.forEach(p => p.el.remove()); return;
            }
            if(type.includes('void')) {
                const p = document.createElement('div'); 
                p.className = 'vfx-blackhole';
                layer.appendChild(p);
                
                const anim = p.animate([
                    { transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(0)` }, 
                    { transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(8)` }
                ], { duration: 1500/spd, easing: 'ease-out', fill: 'forwards' });
                
                await anim.finished; 
                p.style.transition = 'opacity 0.2s';
                p.style.opacity = 0;
                await sleep(200/spd);
                p.remove(); 
                return;
            }
        };

        const showDmgText = (val, targetId) => {
            const el = document.createElement('div');
            el.className = 'dmg-text'; el.innerText = val;
            document.getElementById(targetId).appendChild(el);
            setTimeout(() => el.remove(), 800 / battleState.speed);
        };

        const updateBattleHUD = () => {
            const pPct = (battleState.player.curHp / battleState.player.maxHp) * 100;
            const mPct = (battleState.player.mp / battleState.player.maxMp) * 100;
            const ePct = (battleState.enemy.curHp / battleState.enemy.maxHp) * 100;
            document.getElementById('hud-p-hp-bar').style.width = `${pPct}%`;
            document.getElementById('hud-p-hp-txt').innerText = Math.ceil(pPct) + "%";
            document.getElementById('hud-p-mp-bar').style.width = `${mPct}%`; 
            document.getElementById('hud-e-hp-bar').style.width = `${ePct}%`;
            document.getElementById('hud-e-hp-txt').innerText = Math.ceil(ePct) + "%";
            document.getElementById('hud-e-name').innerText = battleState.enemy.name;
        };

        const winBattle = () => endScreen(true);
        const loseBattle = () => endScreen(false);
        
        const endScreen = (win) => {
            const ov = document.getElementById('battle-overlay');
            ov.classList.remove('hidden'); ov.classList.add('flex');
            void ov.offsetWidth; ov.style.opacity = '1';
            document.getElementById('outcome-title').innerText = win ? "VIT√ìRIA" : "DERROTA";
            
            if(win) {
                let rewards = "";
                const accXp = 50; 
                state.user.xp += accXp;
                
                const xpReq = 100 * state.user.lvl;
                if(state.user.xp >= xpReq) {
                    state.user.xp = state.user.xp - xpReq;
                    state.user.lvl++;
                    state.user.crystals += 25; 
                    showToast(`LEVEL UP! N√≠vel ${state.user.lvl} (+25 üíé)`);
                }

                let crystalsGained = 0;
                let manaGained = 0;

                if(battleState.mode === 'dungeon') {
                    // MELHORIA: Masmorra escala melhor (Base 500 + 250 por andar)
                    const floor = prepState.level;
                    manaGained = 500 + (floor * 250); 
                    crystalsGained = 5 + floor;
                    rewards = `+${manaGained} Mana | +${crystalsGained} üíé`;
                } else if(battleState.mode === 'tower') {
                    state.towerFloor++;
                    crystalsGained = 50 + (state.towerFloor * 10); 
                    manaGained = 500 * state.towerFloor;
                    rewards = `Andar ${state.towerFloor-1} Completo!`;
                } else {
                    // MELHORIA: Campanha agora escala recompensa baseado na fase
                    const stage = prepState.level;
                    const stageKey = `stage_${stage}`;
                    if (!state.user.firstClear[stageKey]) {
                        crystalsGained = 100;
                        manaGained = 1000 * stage; // Recompensa generosa na primeira vez
                        state.user.firstClear[stageKey] = true;
                        if(stage === state.storyProgress) state.storyProgress++;
                        rewards = `PRIMEIRA VEZ! +${crystalsGained} üíé | +${manaGained} Mana`;
                    } else {
                        crystalsGained = 5;
                        // Antes era fixo 100, agora escala: Fase 1 = 200, Fase 5 = 400
                        manaGained = 150 + (stage * 50); 
                        rewards = `+${crystalsGained} üíé | +${manaGained} Mana`;
                    }
                }

                state.user.crystals += crystalsGained;
                state.user.mana += manaGained;
                save();
                updateHeader();
                document.getElementById('outcome-rewards').innerText = rewards;
            } else {
                document.getElementById('outcome-rewards').innerText = "Tente melhorar seu time";
            }
        };
        const closeBattle = () => { changeView('view-home'); updateHeader(); };

        const useXpPotion = () => {
            const mon = state.inventory[selectedDetailIdx];
            if(state.user.potions < 1) return showToast("Sem po√ß√µes de XP!", "error");
            state.user.potions--;
            mon.lvl++;
            save();
            showToast(`${mon.name} subiu para o n√≠vel ${mon.lvl}!`);
            openDetail(selectedDetailIdx);
        };

        const renderMonsterBox = () => {
            const grid = document.getElementById('roster-grid');
            grid.innerHTML = '';
            document.getElementById('mon-count').innerText = state.inventory.length;
            state.inventory.forEach((mon, idx) => {
                const slot = document.createElement('div');
                const isLeader = idx === state.leaderIdx;
                slot.className = `sw-slot aspect-square cursor-pointer flex items-center justify-center ${isLeader ? 'selected' : ''}`;
                
                // Visual Distinction for Rarities (Borders)
                if(!isLeader) {
                    if(mon.stars >= 5) slot.style.borderColor = '#fbbf24'; // Legendary (Gold)
                    else if(mon.stars === 4) slot.style.borderColor = '#a855f7'; // Epic (Purple)
                    else if(mon.stars === 3) slot.style.borderColor = '#3b82f6'; // Rare (Blue)
                }

                const elColor = {fire:'bg-fire', water:'bg-water', lightning:'bg-lightning', earth:'bg-earth', nature:'bg-nature', void:'bg-void'}[mon.element] || 'bg-slate-500';
                slot.innerHTML = `<div class="elem-badge ${elColor}"></div><img src="${mon.img}" class="w-[90%] h-[90%] object-contain filter drop-shadow-lg" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:3rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5))">${mon.emoji}</span><div class="star-row">${'<span class="star-icon">‚òÖ</span>'.repeat(mon.stars)}</div><div class="absolute top-1 left-1 text-[8px] font-bold text-white bg-black/50 px-1 rounded">Lv.${mon.lvl}</div>`;
                slot.onclick = () => openDetail(idx);
                grid.appendChild(slot);
            });
        };

        let selectedDetailIdx = 0;
        const openDetail = (idx) => {
            selectedDetailIdx = idx;
            const mon = state.inventory[idx];
            document.getElementById('mon-detail-overlay').classList.remove('hidden'); document.getElementById('mon-detail-overlay').classList.add('flex');
            document.getElementById('det-name').innerText = mon.name;
            document.getElementById('det-type').innerText = mon.type;
            document.getElementById('det-lvl').innerText = `Lv. ${mon.lvl}`;
            document.getElementById('det-stars').innerHTML = '‚òÖ'.repeat(mon.stars);
            document.getElementById('det-nat-grade').innerText = `NAT ${mon.stars}`;
            document.getElementById('det-element-badge').innerText = {fire:'üî•', water:'üåä', lightning:'‚ö°', earth:'üóø', nature:'üçÉ', void:'üåë'}[mon.element];
            document.getElementById('det-emoji').innerText = mon.emoji;
            const img = document.getElementById('det-img'); img.style.display = 'block'; document.getElementById('det-emoji').style.display = 'none'; img.src = mon.img;
            const m = 1 + (mon.lvl * 0.1);
            document.getElementById('val-hp').innerText = Math.floor(mon.hp * m);
            document.getElementById('val-atk').innerText = Math.floor(mon.atk * m);
            document.getElementById('val-def').innerText = Math.floor(mon.def * m);
            
            const btn = document.getElementById('btn-equip');
            if(state.leaderIdx === idx) { btn.innerText = "L√≠der Atual"; btn.className = "w-full py-3 mt-2 bg-green-500 text-white font-black uppercase rounded-xl opacity-90"; }
            else { btn.innerText = "Definir L√≠der"; btn.className = "w-full py-3 mt-2 bg-white text-slate-900 font-black uppercase rounded-xl active:scale-95"; btn.onclick = equipLeader; }
            document.getElementById('btn-xp').innerText = `Usar Potion (${state.user.potions})`;
        };

        const closeDetail = () => document.getElementById('mon-detail-overlay').classList.add('hidden');
        const equipLeader = () => { state.leaderIdx = selectedDetailIdx; save(); closeDetail(); renderMonsterBox(); };

        const renderStory = () => {
            const c = document.getElementById('story-nodes'); c.innerHTML = '';
            for(let i=1; i<=5; i++) { 
                const locked = state.storyProgress < i;
                const node = document.createElement('div');
                node.className = `relative pl-6 transition-all ${locked?'opacity-50 grayscale pointer-events-none':''}`;
                node.innerHTML = `<div class="absolute left-[-5px] top-3 w-3 h-3 rounded-full ${locked?'bg-slate-700':'bg-indigo-500'}"></div><button onclick="openPrep('story',${i})" class="glass-panel w-full p-4 rounded-xl text-left"><h3 class="text-white font-bold">Cap√≠tulo ${i}</h3><p class="text-xs text-slate-400">Inimigos n√≠vel ${i*3}</p></button>`;
                c.appendChild(node);
            }
        };

        const doSummon = async (type, count) => {
            let cost = 1 * count;
            let ticketKey = type === 'common' ? 'tickets_common' : 'tickets_epic';
            
            if(state.user[ticketKey] < cost) return showToast("Bilhetes insuficientes!", "error");
            state.user[ticketKey] -= cost; 
            updateSummonUI();

            const box = document.getElementById('summon-box');
            const flash = document.getElementById('summon-flash');
            
            flash.style.transform = 'scale(20)'; flash.style.opacity = '1';
            await sleep(200);
            
            let results = [];
            for(let i=0; i<count; i++) {
                let pool = [];
                let rand = Math.random();
                let stars = 1;

                if (type === 'common') {
                    if (rand < 0.7) stars = 1;
                    else if (rand < 0.95) stars = 2;
                    else stars = 3;
                } else {
                    if (rand < 0.7) stars = 3;
                    else if (rand < 0.95) stars = 4;
                    else stars = 5;
                }

                pool = MONSTERS_DB.filter(m => m.stars === stars);
                if (pool.length === 0) pool = MONSTERS_DB.filter(m => m.stars === (stars > 1 ? stars-1 : 1));

                const mon = pool[Math.floor(Math.random() * pool.length)];
                addMonster(mon.id);
                results.push(mon);
            }

            flash.style.opacity = '0';
            
            const hasFiveStar = results.some(r => r.stars === 5);
            if (hasFiveStar) {
                document.body.classList.add('shine-bg');
                setTimeout(() => document.body.classList.remove('shine-bg'), 2000);
                showToast("LENDA INVOCADA! ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê", "success");
            }

            if (count === 1) {
                const m = results[0];
                box.innerHTML = `<img src="${m.img}" class="w-full h-full object-contain animate-float"><span style="display:none;font-size:4rem">${m.emoji}</span>`;
            } else {
                box.innerHTML = "üì¶";
                const modal = document.getElementById('summon-results');
                const grid = document.getElementById('summon-grid');
                grid.innerHTML = '';
                results.forEach(m => {
                    const el = document.createElement('div');
                    el.className = 'sw-slot aspect-square flex items-center justify-center bg-slate-800 rounded border border-slate-600';
                    if (m.stars === 5) el.style.borderColor = '#fbbf24';
                    el.innerHTML = `<img src="${m.img}" class="w-full h-full object-contain"><div class="star-row bottom-1">${'<span class="star-icon text-[6px]">‚òÖ</span>'.repeat(m.stars)}</div>`;
                    grid.appendChild(el);
                });
                modal.classList.remove('hidden');
            }

            box.classList.remove('animate-bounce');
            setTimeout(() => { flash.style.transform = 'scale(0)'; if(count===1) { box.innerHTML = "üì¶"; box.classList.add('animate-bounce'); } }, 2500);
        };

        const addMonster = (id) => {
            const base = MONSTERS_DB.find(m => m.id === id);
            state.inventory.push({...base, lvl: 1, exp: 0, skills: [...base.skills]});
            save();
        };

        const sleep = ms => new Promise(r => setTimeout(r, ms));
        window.onload = init;
    </script>
</body>
</html>