<!DOCTYPE html>
<html lang="pt-pt">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>PaperWar - Battle Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Plus Jakarta Sans"', "sans-serif"],
            },
            animation: {
              float: "float 3s ease-in-out infinite",
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              flash: "flash 0.1s ease-out",
              "toast-slide": "toast-slide 0.3s ease-out forwards",
              "toast-fade": "toast-fade 0.3s ease-in forwards",
              "shine-gold": "shine-gold 1s ease-in-out infinite",
              shake: "shake 0.5s cubic-bezier(.36,.07,.19,.97) both",
            },
            keyframes: {
              float: {
                "0%, 100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
              flash: {
                "0%": { opacity: 0 },
                "50%": { opacity: 0.8 },
                "100%": { opacity: 0 },
              },
              "toast-slide": {
                "0%": { transform: "translateY(-20px)", opacity: 0 },
                "100%": { transform: "translateY(0)", opacity: 1 },
              },
              "toast-fade": { "0%": { opacity: 1 }, "100%": { opacity: 0 } },
              "shine-gold": {
                "0%, 100%": { boxShadow: "0 0 20px #fbbf24" },
                "50%": { boxShadow: "0 0 50px #fbbf24, 0 0 20px white" },
              },
              "summon-shake": {
                "0%, 100%": { transform: "translate(0,0) rotate(0deg)" },
                "25%": { transform: "translate(-2px, 2px) rotate(-1deg)" },
                "50%": { transform: "translate(2px, -2px) rotate(1deg)" },
                "75%": { transform: "translate(-2px, -2px) rotate(-1deg)" },
              },
              "card-flip": {
                "0%": { transform: "rotateY(180deg)", opacity: 0 },
                "100%": { transform: "rotateY(0deg)", opacity: 1 },
              },
              shake: {
                "10%, 90%": { transform: "translate3d(-1px, 0, 0)" },
                "20%, 80%": { transform: "translate3d(2px, 0, 0)" },
                "30%, 50%, 70%": { transform: "translate3d(-4px, 0, 0)" },
                "40%, 60%": { transform: "translate3d(4px, 0, 0)" },
              },
              "shake-sm": {
                "0%, 100%": { transform: "translate(0,0)" },
                "25%": { transform: "translate(2px, 2px)" },
                "50%": { transform: "translate(-2px, -2px)" },
                "75%": { transform: "translate(2px, -2px)" },
              },
              "shake-lg": {
                "0%, 100%": { transform: "translate(0,0)" },
                "25%": { transform: "translate(8px, 8px)" },
                "50%": { transform: "translate(-8px, -8px)" },
                "75%": { transform: "translate(8px, -8px)" },
              },
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap");

      :root {
        --p-x: 35px;
        --p-y: 60px;
        --p-z: 250px;
        --e-x: -35px;
        --e-y: -100px;
        --e-z: -450px;
      }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #020617;
        margin: 0;
        padding: 0;
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #app {
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .scroll-container {
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scroll-container::-webkit-scrollbar {
        display: none;
      }

      .hidden-view {
        display: none !important;
      }

      /* --- PREMIUM UI ELEMENTS --- */
      .glass-panel {
        background: rgba(15, 23, 42, 0.65);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5),
          0 2px 4px -1px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .glass-panel:hover {
        background: rgba(15, 23, 42, 0.75);
        border-color: rgba(255, 255, 255, 0.15);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5),
          0 10px 10px -5px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .premium-btn {
        position: relative;
        overflow: hidden;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .premium-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0) 100%
        );
        pointer-events: none;
      }
      .premium-btn:active {
        transform: scale(0.96);
      }

      /* Enhanced Slot Design */
      .sw-slot {
        position: relative;
        background: linear-gradient(145deg, #1e293b, #0f172a);
        border: 1px solid #334155;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }
      .sw-slot:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        z-index: 10;
      }
      .sw-slot.selected {
        border: 2px solid #fbbf24;
        box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.15),
          0 10px 25px rgba(251, 191, 36, 0.15);
      }

      .sw-slot {
        position: relative;
        background: radial-gradient(circle at center, #334155 0%, #0f172a 100%);
        border: 2px solid #475569;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.1s;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
      }
      .sw-slot:active {
        transform: scale(0.95);
      }
      .sw-slot.selected {
        border-color: #fbbf24;
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
      }

      .eq-slot {
        width: 50px;
        height: 50px;
        background: #1e293b;
        border: 1px dashed #475569;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        position: relative;
      }
      .eq-slot.filled {
        border-style: solid;
        background: #0f172a;
      }

      .rarity-common {
        border-color: #94a3b8 !important;
        box-shadow: inset 0 0 15px rgba(148, 163, 184, 0.1);
      }
      .rarity-rare {
        border-color: #3b82f6 !important;
        background: radial-gradient(
          circle at center,
          rgba(59, 130, 246, 0.15),
          transparent 80%
        ) !important;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.2),
          inset 0 0 15px rgba(59, 130, 246, 0.1);
      }
      .rarity-epic {
        border-color: #a855f7 !important;
        background: radial-gradient(
          circle at center,
          rgba(168, 85, 247, 0.15),
          transparent 80%
        ) !important;
        box-shadow: 0 0 15px rgba(168, 85, 247, 0.25),
          inset 0 0 15px rgba(168, 85, 247, 0.1);
        animation: pulse-border-epic 2s infinite alternate;
      }
      .rarity-legendary {
        border-color: #fbbf24 !important;
        background: radial-gradient(
          circle at center,
          rgba(251, 191, 36, 0.2),
          transparent 70%
        ) !important;
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.3),
          inset 0 0 20px rgba(251, 191, 36, 0.1);
        animation: pulse-border-leg 1.5s infinite alternate;
      }

      @keyframes pulse-border-epic {
        from {
          box-shadow: 0 0 5px rgba(168, 85, 247, 0.2);
        }
        to {
          box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
        }
      }
      @keyframes pulse-border-leg {
        from {
          box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        to {
          box-shadow: 0 0 25px rgba(251, 191, 36, 0.6);
        }
      }

      .star-row {
        display: flex;
        gap: 0px;
        justify-content: center;
        position: absolute;
        bottom: 4px;
        width: 100%;
        z-index: 20;
        filter: drop-shadow(0 1px 2px black);
      }
      .star-icon {
        font-size: 10px;
        color: #fbbf24;
        letter-spacing: -2px;
      }

      .elem-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.3);
        z-index: 20;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }
      .bg-fire {
        background: #ef4444;
      }
      .bg-water {
        background: #3b82f6;
      }
      .bg-lightning {
        background: #eab308;
      }
      .bg-earth {
        background: #a8a29e;
      }
      .bg-nature {
        background: #22c55e;
      }
      .bg-void {
        background: #a855f7;
      }

      /* --- 3D SCENE --- */
      .battle-scene {
        perspective: 1200px;
        perspective-origin: 50% 35%;
        overflow: hidden;
        background: linear-gradient(
            to bottom,
            rgba(2, 6, 23, 0.5),
            rgba(2, 6, 23, 0.95)
          ),
          url("src/area.avif") no-repeat center center;
        background-size: cover;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .arena-container {
        position: relative;
        width: 100%;
        flex: 1;
        transform-style: preserve-3d;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #effect-layer {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        overflow: visible;
        transform-style: preserve-3d;
        z-index: 100;
      }

      .ground-plane {
        position: absolute;
        width: 300%;
        height: 300%;
        background-image: radial-gradient(
            circle at center,
            rgba(99, 102, 241, 0.15) 0%,
            transparent 50%
          ),
          linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 100% 100%, 80px 80px, 80px 80px;
        transform: rotateX(75deg) translateY(25%);
        bottom: -40%;
        z-index: 1;
      }

      .sprite-renderer {
        width: 160px;
        height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform-style: preserve-3d;
        transition: transform 0.4s ease;
      }
      #player-sprite-container {
        transform: rotateY(30deg) rotateX(5deg);
      }
      #enemy-sprite-container {
        transform: rotateY(-30deg) rotateX(5deg);
      }

      .sprite-renderer img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 20px 25px rgba(0, 0, 0, 0.6));
        animation: breathing 3s ease-in-out infinite;
      }

      @keyframes breathing {
        0%,
        100% {
          transform: scale(1) translateY(0);
        }
        50% {
          transform: scale(1.03) translateY(-4px);
        }
      }

      /* VFX Classes */
      .anim-shake-impact {
        animation: shake-sm 0.3s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }
      .anim-shake-crit {
        animation: shake-lg 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }

      .anim-spin-atk {
        animation: spin-attack 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes spin-attack {
        0% {
          transform: rotateY(30deg) rotateZ(0deg);
        }
        50% {
          transform: rotateY(210deg) rotateZ(15deg) scale(1.2);
        }
        100% {
          transform: rotateY(390deg) rotateZ(0deg);
        }
      }

      .anim-hit-recoil {
        animation: hit-recoil 0.4s ease-out;
      }
      @keyframes hit-recoil {
        0% {
          filter: brightness(1);
          transform: translateX(0);
        }
        20% {
          filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5);
          transform: translateX(-10px) rotateZ(-5deg);
        }
        100% {
          filter: brightness(1);
          transform: translateX(0);
        }
      }

      .anim-hit-spin {
        animation: hit-spin 0.6s ease-out;
      }
      @keyframes hit-spin {
        0% {
          filter: brightness(1);
          transform: rotateY(0deg) translateX(0);
        }
        15% {
          filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5);
          transform: rotateY(180deg) translateX(-15px) scale(0.9);
        }
        40% {
          transform: rotateY(360deg) translateX(-5px) scale(1);
        }
        60% {
          transform: rotateY(380deg) translateX(0);
        }
        100% {
          filter: brightness(1);
          transform: rotateY(360deg) translateX(0);
        }
      }

      .anim-cast {
        animation: cast-pulse 0.6s ease-in-out;
      }
      @keyframes cast-pulse {
        0% {
          filter: brightness(1) drop-shadow(0 0 0 transparent);
          transform: scale(1);
        }
        50% {
          filter: brightness(1.5) drop-shadow(0 0 30px currentColor);
          transform: scale(1.1);
        }
        100% {
          filter: brightness(1) drop-shadow(0 0 0 transparent);
          transform: scale(1);
        }
      }

      .projectile {
        position: absolute;
        width: 40px;
        height: 40px;
        z-index: 100;
        pointer-events: none;
        filter: drop-shadow(0 0 10px currentColor);
      }

      .vfx-fireball {
        background: radial-gradient(circle, #fff, #fbbf24, #ef4444);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        box-shadow: 0 0 20px #ef4444;
      }
      .vfx-waterball {
        background: radial-gradient(circle, #fff, #60a5fa, #2563eb);
        border-radius: 50%;
        width: 45px;
        height: 45px;
        opacity: 0.9;
        box-shadow: 0 0 20px #3b82f6;
      }
      .vfx-rock {
        background: #57534e;
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
        width: 45px;
        height: 45px;
        border: 2px solid #292524;
      }
      .vfx-leaf {
        background: #4ade80;
        border-radius: 0 50% 0 50%;
        width: 30px;
        height: 30px;
        border: 1px solid #166534;
      }
      .vfx-void {
        background: #000;
        border: 2px solid #a855f7;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        box-shadow: 0 0 15px #a855f7;
      }

      .vfx-lightning-strike {
        position: absolute;
        top: -300px;
        width: 12px;
        height: 600px;
        background: white;
        box-shadow: 0 0 20px #facc15, 0 0 50px #facc15;
        transform: translateX(-50%) skewX(-5deg);
        animation: flash 0.15s ease-out forwards;
        z-index: 101;
        pointer-events: none;
      }

      .vfx-blackhole {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: radial-gradient(circle, #000, #4c1d95, transparent);
        box-shadow: 0 0 50px #4c1d95;
        z-index: 99;
        pointer-events: none;
      }

      .entity-wrapper {
        position: absolute;
        transform-style: preserve-3d;
        transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        z-index: 10;
      }
      .pos-enemy {
        transform: translateX(var(--e-x)) translateY(var(--e-y))
          translateZ(var(--e-z));
      }
      .pos-player {
        transform: translateX(var(--p-x)) translateY(var(--p-y))
          translateZ(var(--p-z));
      }

      .anim-melee-player {
        transform: translateX(-15px) translateY(-50px) translateZ(-350px)
          scale(1.1);
      }
      .anim-melee-enemy {
        transform: translateX(15px) translateY(50px) translateZ(150px)
          scale(1.1);
      }

      .character-shadow {
        position: absolute;
        bottom: -5px;
        left: 50%;
        width: 120px;
        height: 30px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 50%;
        transform: translateX(-50%) rotateX(80deg);
        filter: blur(12px);
        z-index: -1;
      }

      .hud-bar {
        background: rgba(0, 0, 0, 0.6);
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.8);
      }
      .hud-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }
      .hud-fill::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        width: 1px;
        background: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
      }

      @keyframes float-dmg {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-80px) scale(1.5);
        }
      }
      .dmg-text {
        position: absolute;
        color: #f87171;
        font-weight: 900;
        font-size: 3rem;
        text-shadow: 2px 2px 0px #000, 0 0 10px #7f1d1d;
        animation: float-dmg 0.8s ease-out forwards;
        z-index: 100;
        left: 50%;
        top: -100px;
        margin-left: -50px;
        width: 100px;
        text-align: center;
      }
      .dmg-crit {
        color: #facc15 !important;
        font-size: 4rem !important;
        text-shadow: 0 0 15px #ca8a04 !important;
      }

      .flash-screen {
        position: absolute;
        inset: 0;
        background: white;
        z-index: 200;
        pointer-events: none;
        animation: flash 0.15s ease-out forwards;
      }

      .shine-bg {
        animation: shine-gold 2s infinite;
        border: 2px solid #fbbf24;
      }

      /* --- TOAST SYSTEM --- */
      #toast-container {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
        width: 90%;
        max-width: 300px;
      }
      .toast {
        background: rgba(15, 23, 42, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        font-size: 0.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: toast-slide 0.3s ease-out forwards;
      }
      .toast.error {
        border-color: #ef4444;
      }
      .toast.success {
        border-color: #22c55e;
      }
      .toast.info {
        border-color: #3b82f6;
      }
      .toast-icon {
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="w-full h-full max-w-md bg-slate-950 relative shadow-2xl flex flex-col sm:h-[94vh] sm:rounded-[2.5rem] border-slate-800 border-[8px]"
    >
      <div id="screen-flash" class="hidden"></div>
      <div id="toast-container"></div>

      <!-- LOGIN -->
      <main
        id="view-login"
        class="flex-1 flex flex-col items-center justify-center p-8 bg-[url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?auto=format&fit=crop&q=80&w=1000')] bg-cover bg-center relative"
      >
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        <div class="relative z-10 w-full flex flex-col items-center">
          <h1
            class="text-7xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-cyan-300 mb-2 drop-shadow-lg"
          >
            PAPER<br />WAR
          </h1>
          <p
            class="text-indigo-200 uppercase tracking-[0.3em] text-[10px] font-bold mb-12"
          >
            Tactical RPG Simulator
          </p>
          <div class="w-full glass-panel p-6 rounded-3xl space-y-4">
            <input
              type="text"
              id="login-name"
              placeholder="Nome do Comandante..."
              class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl px-5 py-4 font-bold text-white outline-none focus:border-indigo-500 transition-colors"
            />
            <button
              onclick="handleLogin()"
              class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase tracking-wider shadow-lg active:scale-95 transition-all"
            >
              Jogar
            </button>
          </div>
        </div>
      </main>

      <!-- HEADER -->
      <header
        id="ui-header"
        class="px-5 py-4 bg-slate-950/90 backdrop-blur-md border-b border-white/5 hidden justify-between items-center z-[50] shrink-0"
      >
        <div
          class="flex items-center space-x-3 cursor-pointer"
          onclick="changeView('view-home')"
        >
          <div
            class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg relative"
          >
            <span id="header-initial">P</span>
            <div
              class="absolute -bottom-1 -right-1 w-5 h-5 bg-black rounded-full flex items-center justify-center text-[9px] font-bold border border-white"
              id="header-lvl"
            >
              1
            </div>
          </div>
          <div class="leading-tight">
            <p class="text-[9px] font-bold text-slate-400 uppercase">
              Comandante
            </p>
            <p
              id="player-name-ui"
              class="font-bold text-white text-sm truncate max-w-[100px]"
            >
              ---
            </p>
            <!-- XP BAR -->
            <div
              class="w-16 h-1 bg-slate-800 rounded-full mt-0.5 overflow-hidden border border-white/10"
            >
              <div
                id="header-xp-bar"
                class="h-full bg-green-500 w-0 transition-all duration-300"
              ></div>
            </div>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <div
            class="bg-slate-800/80 border border-white/5 px-2 py-1 rounded-lg flex items-center space-x-1"
            title="Energia"
          >
            <span class="text-xs">‚ö°</span
            ><span id="val-energy" class="text-[10px] font-bold text-yellow-400"
              >0</span
            >
          </div>
          <div
            class="bg-slate-800/80 border border-white/5 px-2 py-1 rounded-lg flex items-center space-x-1"
            title="Ouro"
          >
            <span class="text-xs">üí∞</span
            ><span id="val-gold" class="text-[10px] font-bold text-yellow-400"
              >0</span
            >
          </div>
          <div
            class="bg-slate-800/80 border border-white/5 px-2 py-1 rounded-lg flex items-center space-x-1"
            title="Cristais"
          >
            <span class="text-xs">üíé</span
            ><span id="val-crystals" class="text-[10px] font-bold text-cyan-400"
              >0</span
            >
          </div>
          <button
            onclick="logout()"
            class="bg-red-900/80 px-2 py-1 rounded-lg border border-red-500/50 text-xs text-red-200 font-bold ml-2 transition-transform active:scale-95"
            title="Sair da Conta"
          >
            üö™
          </button>
        </div>
      </header>

      <!-- HOME -->
      <main
        id="view-home"
        class="scroll-container flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950 hidden-view scroll-smooth pb-24"
      >
        <div
          class="relative w-full h-40 rounded-[2rem] overflow-hidden group cursor-pointer shadow-2xl"
          onclick="changeView('view-story')"
        >
          <img
            src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&q=80&w=800"
            class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
          />
          <div
            class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/40 to-transparent"
          ></div>
          <div class="absolute bottom-6 left-6">
            <p
              class="text-indigo-400 font-bold text-[10px] uppercase tracking-widest mb-1"
            >
              Modo Hist√≥ria
            </p>
            <h2
              class="text-3xl font-black text-white italic uppercase leading-none"
            >
              Campanha
            </h2>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button
            onclick="openDungeonSelect('golem')"
            class="glass-panel p-4 rounded-3xl text-left active:scale-95 transition-all relative overflow-hidden"
          >
            <div class="absolute right-[-10px] top-[-10px] text-6xl opacity-10">
              üóø
            </div>
            <div
              class="w-10 h-10 rounded-xl bg-stone-500/20 text-stone-400 flex items-center justify-center text-xl mb-3"
            >
              üóø
            </div>
            <h3 class="text-white font-bold uppercase text-sm">Golem</h3>
            <p class="text-slate-400 text-[10px] mt-1">Armas/Armaduras</p>
          </button>
          <button
            onclick="openDungeonSelect('dragon')"
            class="glass-panel p-4 rounded-3xl text-left active:scale-95 transition-all relative overflow-hidden"
          >
            <div class="absolute right-[-10px] top-[-10px] text-6xl opacity-10">
              üêâ
            </div>
            <div
              class="w-10 h-10 rounded-xl bg-red-500/20 text-red-400 flex items-center justify-center text-xl mb-3"
            >
              üêâ
            </div>
            <h3 class="text-white font-bold uppercase text-sm">Drag√£o</h3>
            <p class="text-slate-400 text-[10px] mt-1">Cr√≠tico/Acess√≥rios</p>
          </button>
          <button
            onclick="changeView('view-tower')"
            class="col-span-2 glass-panel p-4 rounded-3xl text-left active:scale-95 transition-all border-yellow-500/20 relative overflow-hidden"
          >
            <div class="absolute right-[-10px] top-[-10px] text-6xl opacity-10">
              üè∞
            </div>
            <div
              class="w-10 h-10 rounded-xl bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xl mb-3"
            >
              üè∞
            </div>
            <h3 class="text-white font-bold uppercase text-sm">Torre</h3>
            <p class="text-slate-400 text-[10px] mt-1">Ascens√£o</p>
          </button>
        </div>

        <div class="space-y-3">
          <div
            onclick="changeView('view-shop')"
            class="glass-panel p-4 rounded-2xl flex items-center space-x-4 cursor-pointer bg-gradient-to-r from-amber-900/40 to-slate-900"
          >
            <div
              class="w-12 h-12 bg-amber-600 rounded-xl flex items-center justify-center text-2xl"
            >
              üõí
            </div>
            <div class="flex-1">
              <h4 class="text-white font-bold uppercase">Loja</h4>
              <p class="text-amber-200 text-xs">Recursos e Tickets</p>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <div
              onclick="changeView('view-collection')"
              class="glass-panel p-3 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-center"
            >
              <div class="text-xl mb-1">üé¥</div>
              <h4 class="text-white font-bold uppercase text-[10px]">
                Monstros
              </h4>
            </div>
            <div
              onclick="changeView('view-summon')"
              class="glass-panel p-3 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-center"
            >
              <div class="text-xl mb-1">üì¶</div>
              <h4 class="text-white font-bold uppercase text-[10px]">Summon</h4>
            </div>
            <!-- NEW CHEST BUTTON -->
            <div
              onclick="changeView('view-inventory')"
              class="glass-panel p-3 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-center border-indigo-500/30 bg-indigo-900/10"
            >
              <div class="text-xl mb-1">üíº</div>
              <h4 class="text-white font-bold uppercase text-[10px]">Ba√∫</h4>
            </div>
          </div>
        </div>
      </main>

      <!-- INVENTORY (CHEST) VIEW -->
      <main
        id="view-inventory"
        class="flex-1 hidden-view bg-slate-950 flex flex-col p-4"
      >
        <div class="flex items-center justify-between mb-4">
          <button
            onclick="changeView('view-home')"
            class="text-white font-bold text-xs bg-slate-800 px-3 py-2 rounded-lg"
          >
            ‚Üê Voltar
          </button>
          <span class="text-white font-bold uppercase text-xs"
            >Equipamentos</span
          >
        </div>

        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
          <button
            onclick="filterInventory('all')"
            id="tab-all"
            class="inv-tab px-3 py-1 rounded-full bg-indigo-600 text-white text-[10px] font-bold"
          >
            Todos
          </button>
          <button
            onclick="filterInventory('weapon')"
            id="tab-weapon"
            class="inv-tab px-3 py-1 rounded-full bg-slate-800 text-slate-400 text-[10px] font-bold"
          >
            Armas
          </button>
          <button
            onclick="filterInventory('armor')"
            id="tab-armor"
            class="inv-tab px-3 py-1 rounded-full bg-slate-800 text-slate-400 text-[10px] font-bold"
          >
            Armaduras
          </button>
          <button
            onclick="filterInventory('acc')"
            id="tab-acc"
            class="inv-tab px-3 py-1 rounded-full bg-slate-800 text-slate-400 text-[10px] font-bold"
          >
            Acess√≥rios
          </button>
        </div>

        <div
          id="inventory-grid"
          class="grid grid-cols-5 gap-2 overflow-y-auto pb-20 content-start"
        ></div>

        <div
          id="inv-empty-msg"
          class="hidden flex-col items-center justify-center flex-1 opacity-50"
        >
          <div class="text-4xl mb-2">üï∏Ô∏è</div>
          <p class="text-white text-xs">Ba√∫ vazio</p>
        </div>
      </main>

      <!-- PRE-BATTLE PREPARATION -->
      <main
        id="view-prep"
        class="flex-1 hidden-view bg-slate-950 flex flex-col p-6 relative"
      >
        <button
          onclick="changeView('view-home')"
          class="mb-4 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max"
        >
          ‚Üê Cancelar
        </button>

        <h2 class="text-2xl font-black text-white uppercase italic mb-1">
          Batalha
        </h2>
        <p
          id="prep-title"
          class="text-indigo-400 text-xs font-bold uppercase mb-6"
        >
          Masmorra B10
        </p>

        <div class="flex-1 flex flex-col space-y-6">
          <!-- Selected Unit -->
          <div
            class="glass-panel p-6 rounded-3xl flex flex-col items-center relative overflow-hidden"
          >
            <div
              class="absolute inset-0 bg-gradient-to-t from-indigo-900/30 to-transparent"
            ></div>
            <div
              class="text-white text-xs font-bold uppercase mb-2 relative z-10"
            >
              Seu Campe√£o
            </div>
            <div
              class="w-32 h-32 rounded-3xl bg-slate-800/50 border-2 border-indigo-500 overflow-hidden relative mb-4 shadow-xl"
            >
              <img
                id="prep-img"
                src=""
                class="w-full h-full object-contain animate-[pulse-slow_3s_infinite]"
              />
              <div
                id="prep-el"
                class="absolute bottom-2 right-2 w-7 h-7 rounded-full bg-slate-900 border border-white flex items-center justify-center text-sm shadow-md"
              >
                üî•
              </div>
            </div>
            <h3
              id="prep-name"
              class="text-xl font-bold text-white mb-1 relative z-10"
            >
              Nome
            </h3>
            <p
              id="prep-stats"
              class="text-xs text-slate-400 relative z-10 font-mono bg-slate-900/50 px-3 py-1 rounded-full"
            >
              Atk: 0 | HP: 0
            </p>

            <button
              onclick="document.getElementById('prep-roster').classList.remove('hidden')"
              class="absolute top-4 right-4 bg-slate-700/50 p-2 rounded-lg text-xs text-white hover:bg-slate-600 transition-colors z-20"
            >
              ‚Ü∫ Trocar
            </button>
          </div>

          <!-- Start Button -->
          <div class="mt-auto">
            <div
              class="flex justify-between text-xs text-slate-400 font-bold mb-2 px-2"
            >
              <span>Custo Energia:</span>
              <span class="text-yellow-400" id="prep-cost">5 ‚ö°</span>
            </div>
            <button
              onclick="confirmBattle()"
              class="w-full py-4 bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl text-white font-black uppercase text-lg shadow-lg active:scale-95 transition-transform"
            >
              INICIAR
            </button>
          </div>
        </div>

        <!-- Mini Roster Selector Overlay -->
        <div
          id="prep-roster"
          class="scroll-container absolute inset-0 bg-slate-950/95 z-20 flex flex-col p-4 hidden"
        >
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-white font-bold">Escolha seu Monstro</h3>
            <button
              onclick="document.getElementById('prep-roster').classList.add('hidden')"
              class="text-white text-xl"
            >
              ‚úï
            </button>
          </div>
          <div
            id="prep-grid"
            class="grid grid-cols-4 gap-3 overflow-y-auto pb-4"
          ></div>
        </div>
      </main>

      <!-- MASMORRA (DUNGEON SELECT) -->
      <main
        id="view-dungeon"
        class="flex-1 hidden-view bg-slate-950 p-6 flex flex-col"
      >
        <button
          onclick="changeView('view-home')"
          class="mb-4 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max"
        >
          ‚Üê Voltar
        </button>
        <h2 class="text-3xl font-black text-white uppercase italic mb-6">
          Masmorra
        </h2>
        <div
          class="glass-panel p-3 mb-4 rounded-xl flex items-center gap-3 border-indigo-500/20"
        >
          <div class="text-2xl">‚ÑπÔ∏è</div>
          <p class="text-[10px] text-slate-300">
            Andares mais altos aumentam a chance de obter equipamentos
            <span class="text-purple-400 font-bold">√âpicos</span> e
            <span class="text-yellow-400 font-bold">Lend√°rios</span>.
          </p>
        </div>
        <div
          class="scroll-container flex-1 overflow-y-auto space-y-3 pr-2"
          id="dungeon-list"
        ></div>
      </main>

      <!-- TOWER SELECT -->
      <main
        id="view-tower"
        class="flex-1 hidden-view bg-slate-950 p-6 flex flex-col items-center justify-center relative overflow-hidden"
      >
        <div
          class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"
        ></div>
        <button
          onclick="changeView('view-home')"
          class="absolute top-6 left-6 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max z-10"
        >
          ‚Üê Voltar
        </button>
        <div class="relative z-10 text-center space-y-6">
          <div
            class="w-32 h-32 mx-auto bg-yellow-500/20 rounded-full flex items-center justify-center border-4 border-yellow-500/50 shadow-[0_0_50px_rgba(234,179,8,0.3)]"
          >
            <span class="text-6xl">üè∞</span>
          </div>
          <div>
            <p
              class="text-yellow-500 font-bold uppercase tracking-widest text-sm mb-2"
            >
              Andar Atual
            </p>
            <h2 class="text-6xl font-black text-white" id="tower-floor-display">
              1
            </h2>
          </div>
          <div class="glass-panel p-4 rounded-xl max-w-xs mx-auto">
            <p class="text-slate-300 text-xs mb-1">Recompensa Prevista</p>
            <p class="text-white font-bold">üíé 50 Cristais + üí∞ 200 Ouro</p>
          </div>
          <button
            onclick="openPrep('tower', state.towerFloor)"
            class="px-12 py-4 bg-yellow-600 hover:bg-yellow-500 text-white font-black uppercase rounded-2xl shadow-lg active:scale-95 transition-all"
          >
            DESAFIAR
          </button>
        </div>
      </main>

      <!-- SHOP VIEW -->
      <main
        id="view-shop"
        class="scroll-container flex-1 hidden-view bg-slate-950 p-6 flex flex-col relative"
      >
        <button
          onclick="changeView('view-home')"
          class="mb-4 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold w-max"
        >
          ‚Üê Voltar
        </button>
        <h2 class="text-3xl font-black text-white uppercase italic mb-6">
          Loja
        </h2>

        <div class="space-y-4">
          <h4
            class="text-slate-400 font-bold text-xs uppercase tracking-widest ml-1"
          >
            Invoca√ß√£o
          </h4>

          <!-- Common Ticket -->
          <div
            class="glass-panel p-1 rounded-2xl relative overflow-hidden group"
          >
            <div
              class="absolute inset-0 bg-gradient-to-r from-blue-900/40 to-slate-900 z-0"
            ></div>
            <div class="relative z-10 p-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div
                  class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center text-2xl border border-blue-500/30"
                >
                  üìú
                </div>
                <div>
                  <h3 class="text-white font-bold">Bilhete Comum</h3>
                  <p class="text-blue-300 text-[10px]">1-3 Estrelas</p>
                </div>
              </div>
              <button
                onclick="buyShopItem('ticket_common')"
                class="premium-btn px-6 py-2 rounded-xl text-white font-bold text-xs shadow-lg shadow-blue-900/20 transform active:scale-95 transition-all"
              >
                2000 üí∞
              </button>
            </div>
          </div>

          <!-- Epic Ticket -->
          <div
            class="glass-panel p-1 rounded-2xl relative overflow-hidden group border-amber-500/20"
          >
            <div
              class="absolute inset-0 bg-gradient-to-r from-amber-900/40 to-slate-900 z-0"
            ></div>
            <div class="relative z-10 p-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div
                  class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center text-2xl border border-amber-500/30 shadow-[0_0_15px_rgba(245,158,11,0.2)]"
                >
                  üé´
                </div>
                <div>
                  <h3 class="text-white font-bold">Bilhete √âpico</h3>
                  <p class="text-amber-300 text-[10px]">3-5 Estrelas</p>
                </div>
              </div>
              <button
                onclick="buyShopItem('ticket_epic')"
                class="bg-gradient-to-r from-amber-600 to-orange-600 px-6 py-2 rounded-xl text-white font-bold text-xs shadow-lg shadow-amber-900/20 active:scale-95 transition-transform border border-amber-400/30"
              >
                300 üíé
              </button>
            </div>
          </div>
        </div>

        <!-- Section: Resources -->
        <div class="space-y-3 pt-4">
          <h4
            class="text-slate-400 font-bold text-xs uppercase tracking-widest ml-1"
          >
            Recursos
          </h4>

          <div class="grid grid-cols-2 gap-3">
            <!-- Energy -->
            <div
              class="glass-panel p-4 rounded-2xl flex flex-col items-center text-center relative overflow-hidden"
            >
              <div
                class="absolute inset-0 bg-gradient-to-b from-yellow-900/20 to-transparent"
              ></div>
              <div class="text-3xl mb-2 relative z-10">‚ö°</div>
              <h3 class="text-white font-bold text-sm relative z-10">
                50 Energia
              </h3>
              <button
                onclick="buyShopItem('energy')"
                class="mt-3 w-full py-2 bg-slate-800 border border-white/10 rounded-lg text-white font-bold text-xs hover:bg-slate-700 active:scale-95 transition-all"
              >
                50 üíé
              </button>
            </div>

            <!-- XP Potion -->
            <div
              class="glass-panel p-4 rounded-2xl flex flex-col items-center text-center relative overflow-hidden"
            >
              <div
                class="absolute inset-0 bg-gradient-to-b from-blue-900/20 to-transparent"
              ></div>
              <div class="text-3xl mb-2 relative z-10">üß™</div>
              <h3 class="text-white font-bold text-sm relative z-10">
                XP Potion
              </h3>
              <button
                onclick="buyShopItem('xp_pot')"
                class="mt-3 w-full py-2 bg-slate-800 border border-white/10 rounded-lg text-white font-bold text-xs hover:bg-slate-700 active:scale-95 transition-all"
              >
                500 üí∞
              </button>
            </div>
          </div>
        </div>

        <div
          class="mt-4 glass-panel p-4 rounded-xl flex justify-between text-xs bg-slate-900/80"
        >
          <div>
            üíé <span id="shop-crystals" class="text-cyan-400 font-bold">0</span>
          </div>
          <div>
            üí∞ <span id="shop-gold" class="text-yellow-400 font-bold">0</span>
          </div>
        </div>
      </main>

      <!-- MONSTER BOX -->
      <main
        id="view-collection"
        class="scroll-container flex-1 hidden-view bg-slate-950 flex flex-col p-4"
      >
        <div class="flex items-center justify-between mb-4">
          <button
            onclick="changeView('view-home')"
            class="text-white font-bold text-xs bg-slate-800 px-3 py-2 rounded-lg"
          >
            ‚Üê VOLTAR
          </button>
          <span class="text-white font-bold uppercase text-xs"
            >Monstros: <span id="mon-count">0</span></span
          >
        </div>
        <div
          id="roster-grid"
          class="grid grid-cols-5 gap-2 content-start overflow-y-auto pb-20"
        ></div>
        <!-- Detail Overlay -->
        <div
          id="mon-detail-overlay"
          class="absolute inset-0 z-50 bg-slate-950 hidden"
        >
          <!-- Close Button -->
          <button
            onclick="closeDetail()"
            class="absolute top-6 right-6 text-white text-2xl z-50 bg-slate-900/50 rounded-full w-10 h-10 flex items-center justify-center border border-white/10 hover:bg-slate-800 transition-colors"
          >
            ‚úï
          </button>

          <!-- Split Layout -->
          <div class="flex h-full w-full">
            <!-- LEFT: Visuals (40%) -->
            <div
              class="w-[40%] relative flex items-center justify-center bg-gradient-to-br from-indigo-900/20 to-slate-900 overflow-hidden"
            >
              <div
                class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"
              ></div>

              <!-- Element Badge -->
              <div
                id="det-element-badge"
                class="absolute top-6 left-6 text-3xl z-40 drop-shadow-lg animate-float"
              ></div>

              <!-- Monster Image (Large) -->
              <img
                id="det-img"
                src=""
                class="h-[70%] w-full object-contain filter drop-shadow-[0_20px_50px_rgba(0,0,0,0.6)] animate-[breathing_4s_infinite]"
                onerror="this.style.display='none';this.nextElementSibling.style.display='block'"
              />
              <span
                style="display: none; font-size: 8rem"
                class="filter drop-shadow-2xl animate-float"
                id="det-emoji"
                >üêâ</span
              >

              <!-- Name (Vertical or Overlay) -->
              <div class="absolute bottom-10 left-0 w-full text-center">
                <h2
                  id="det-name"
                  class="text-3xl font-black text-white italic uppercase drop-shadow-lg tracking-tight"
                >
                  NAME
                </h2>
                <p
                  id="det-type"
                  class="text-indigo-400 font-bold text-[10px] uppercase tracking-[0.3em]"
                >
                  TYPE
                </p>
              </div>
            </div>

            <!-- RIGHT: Info & Stats (60%) -->
            <div
              class="w-[60%] h-full bg-slate-900/90 relative flex flex-col p-6 border-l border-white/5"
            >
              <!-- Header Stats -->
              <div class="flex items-center justify-between mb-8">
                <div class="flex flex-col">
                  <span
                    class="text-slate-400 text-[10px] font-bold uppercase tracking-wider"
                    >Raridade</span
                  >
                  <div
                    id="det-stars"
                    class="text-yellow-400 text-sm tracking-widest"
                  >
                    ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
                  </div>
                  <span
                    id="det-nat-grade"
                    class="text-[9px] font-bold text-slate-500 mt-1"
                    >NATURAL GRADE</span
                  >
                </div>
                <div class="text-right">
                  <span
                    class="text-slate-400 text-[10px] font-bold uppercase tracking-wider"
                    >N√≠vel</span
                  >
                  <div id="det-lvl" class="text-2xl font-black text-white">
                    40
                  </div>
                </div>
              </div>

              <!-- Stats Grid -->
              <div class="grid grid-cols-2 gap-x-6 gap-y-4 mb-8">
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="text-slate-400 text-xs font-bold">HP</span>
                  <span id="val-hp" class="text-white font-mono font-bold"
                    >10000</span
                  >
                </div>
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="text-slate-400 text-xs font-bold">ATK</span>
                  <span id="val-atk" class="text-white font-mono font-bold"
                    >2500</span
                  >
                </div>
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="text-slate-400 text-xs font-bold">DEF</span>
                  <span id="val-def" class="text-white font-mono font-bold"
                    >900</span
                  >
                </div>
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="text-slate-400 text-xs font-bold">SPD</span>
                  <span class="text-white font-mono font-bold">100</span>
                </div>
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="text-slate-400 text-xs font-bold">CRIT</span>
                  <span id="val-crit" class="text-white font-mono font-bold"
                    >15%</span
                  >
                </div>
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="text-slate-400 text-xs font-bold">CDMG</span>
                  <span id="val-cdmg" class="text-white font-mono font-bold"
                    >50%</span
                  >
                </div>
              </div>

              <!-- Equipment Slots (Visual) -->
              <div class="flex justify-center gap-6 mb-auto">
                <div
                  id="eq-slot-weapon"
                  class="eq-slot transform hover:scale-105 transition-transform cursor-pointer"
                  onclick="handleEqClick('weapon')"
                >
                  <span class="text-slate-600 text-2xl">‚öîÔ∏è</span>
                </div>
                <div
                  id="eq-slot-armor"
                  class="eq-slot transform hover:scale-105 transition-transform cursor-pointer"
                  onclick="handleEqClick('armor')"
                >
                  <span class="text-slate-600 text-2xl">üõ°Ô∏è</span>
                </div>
                <div
                  id="eq-slot-acc"
                  class="eq-slot transform hover:scale-105 transition-transform cursor-pointer"
                  onclick="handleEqClick('acc')"
                >
                  <span class="text-slate-600 text-2xl">üíç</span>
                </div>
              </div>

              <!-- Actions -->
              <div class="space-y-3 mt-4">
                <button
                  onclick="useXpPotion()"
                  id="btn-xp"
                  class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold uppercase rounded-xl text-xs flex items-center justify-center gap-2 border border-white/5"
                >
                  <span>üß™</span> Usar Potion
                </button>
                <button
                  onclick="equipLeader()"
                  id="btn-equip"
                  class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-black uppercase rounded-xl shadow-lg shadow-indigo-500/20 active:scale-95 transition-all text-xs"
                >
                  Definir L√≠der
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- UPGRADE MODAL (MOVED TO BODY ROOT TO SHARE) -->
      <div
        id="eq-modal"
        class="absolute inset-0 z-[60] bg-slate-950/95 hidden flex-col items-center justify-center p-6"
      >
        <div
          class="glass-panel w-full max-w-sm p-6 rounded-3xl flex flex-col items-center relative"
        >
          <button
            onclick="document.getElementById('eq-modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-white"
          >
            ‚úï
          </button>
          <h3 id="eq-modal-title" class="text-xl font-bold text-white mb-2">
            Espada Comum
          </h3>
          <div
            id="eq-modal-level"
            class="text-xs font-bold px-2 py-1 bg-black rounded mb-4"
          >
            +0
          </div>

          <div class="w-full space-y-2 mb-6 text-sm">
            <div class="flex justify-between">
              <span class="text-slate-400">ATK</span
              ><span id="eq-stat-atk" class="text-white font-mono">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">DEF</span
              ><span id="eq-stat-def" class="text-white font-mono">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">CRIT</span
              ><span id="eq-stat-crit" class="text-white font-mono">0%</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">CDMG</span
              ><span id="eq-stat-cdmg" class="text-white font-mono">0%</span>
            </div>
          </div>

          <div class="w-full flex gap-2">
            <button
              id="btn-sell"
              onclick="sellEquipment()"
              class="flex-1 py-3 bg-red-900/50 border border-red-500 rounded-xl text-red-200 font-bold mb-2 text-xs"
            >
              Vender (<span id="sell-price">100</span> üí∞)
            </button>
            <button
              id="btn-upgrade"
              onclick="performUpgrade()"
              class="flex-[2] py-3 bg-green-600 rounded-xl text-white font-bold mb-2 disabled:opacity-50 disabled:grayscale text-xs"
            >
              Melhorar (<span id="upg-cost">100</span> üí∞)
            </button>
          </div>
          <p id="upg-chance" class="text-[10px] text-slate-400 text-center">
            Chance: 100%
          </p>
          <p
            id="eq-equipped-by"
            class="text-[10px] text-indigo-400 font-bold mt-2 hidden"
          >
            Equipado em: Monster
          </p>
        </div>
      </div>

      <!-- STORY -->
      <main
        id="view-story"
        class="scroll-container flex-1 overflow-y-auto hidden-view bg-slate-950 p-6 relative"
      >
        <button
          onclick="changeView('view-home')"
          class="mb-6 px-4 py-2 bg-slate-900 rounded-full border border-white/10 text-white text-xs font-bold"
        >
          ‚Üê Voltar
        </button>
        <h2 class="text-3xl font-black text-white uppercase italic mb-8">
          Campanha
        </h2>
        <div
          id="story-nodes"
          class="space-y-6 relative pl-4 border-l-2 border-slate-800"
        ></div>
      </main>

      <!-- BATTLE -->
      <main id="view-battle" class="flex-1 hidden-view battle-scene relative">
        <!-- Top HUD -->
        <div
          class="absolute top-0 w-full p-4 z-50 flex justify-between items-start"
        >
          <div class="glass-panel px-3 py-2 rounded-2xl w-32">
            <div
              class="flex justify-between text-[9px] text-white font-bold mb-1"
            >
              <span id="hud-p-name">HERO</span>
              <span id="hud-p-hp-txt">100%</span>
            </div>
            <div class="hud-bar bg-black">
              <div
                id="hud-p-hp-bar"
                class="hud-fill bg-emerald-500"
                style="width: 100%"
              ></div>
            </div>
            <!-- Mana Bar -->
            <div class="mt-1 flex items-center space-x-1">
              <span class="text-[8px] text-blue-300">MP</span>
              <div class="flex-1 h-1 bg-black rounded-full overflow-hidden">
                <div
                  id="hud-p-mp-bar"
                  class="h-full bg-blue-500 transition-all duration-500"
                  style="width: 100%"
                ></div>
              </div>
            </div>
          </div>
          <div class="glass-panel px-3 py-1 rounded-full">
            <span
              id="battle-info"
              class="text-[10px] font-black text-white uppercase tracking-widest"
              >VS</span
            >
          </div>
          <div class="glass-panel px-3 py-2 rounded-2xl w-32 text-right">
            <div
              class="flex justify-between text-[9px] text-white font-bold mb-1"
            >
              <span id="hud-e-hp-txt">100%</span>
              <span id="hud-e-name">BOSS</span>
            </div>
            <div class="hud-bar bg-black">
              <div
                id="hud-e-hp-bar"
                class="hud-fill bg-red-500"
                style="width: 100%"
              ></div>
            </div>
          </div>
        </div>

        <!-- Auto/Speed Controls -->
        <div class="absolute top-20 right-4 z-50 flex flex-col space-y-2">
          <button
            id="btn-auto"
            onclick="toggleAuto()"
            class="w-10 h-10 rounded-full bg-slate-900/80 border border-white/20 text-xs font-bold text-white flex items-center justify-center opacity-50"
          >
            AUTO
          </button>
          <button
            id="btn-speed"
            onclick="toggleSpeed()"
            class="w-10 h-10 rounded-full bg-slate-900/80 border border-white/20 text-xs font-bold text-white flex items-center justify-center opacity-50"
          >
            1x
          </button>
        </div>

        <div id="arena" class="arena-container">
          <div class="ground-plane"></div>
          <div id="ent-enemy" class="entity-wrapper pos-enemy">
            <div id="enemy-sprite-container" class="sprite-renderer"></div>
            <div class="character-shadow"></div>
          </div>
          <div id="effect-layer"></div>
          <div id="ent-player" class="entity-wrapper pos-player">
            <div id="player-sprite-container" class="sprite-renderer"></div>
            <div class="character-shadow"></div>
          </div>
        </div>
        <div class="glass-panel m-4 mb-6 p-4 rounded-[2rem] z-50">
          <div
            id="combat-log"
            class="text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-3 h-4"
          >
            ...
          </div>
          <div id="skill-grid" class="grid grid-cols-4 gap-2"></div>
        </div>
        <div
          id="battle-overlay"
          class="absolute inset-0 z-[60] bg-slate-950/90 backdrop-blur-md hidden flex-col items-center justify-center p-8 opacity-0 transition-opacity duration-300"
        >
          <h2
            id="outcome-title"
            class="text-5xl font-black text-white italic uppercase mb-4"
          ></h2>
          <div
            id="outcome-rewards"
            class="flex flex-wrap justify-center gap-4 mb-8"
          ></div>
          <button
            onclick="closeBattle()"
            class="px-12 py-4 bg-white text-black font-black uppercase italic rounded-full hover:scale-110 transition-transform active:scale-95"
          >
            Continuar
          </button>
        </div>
      </main>

      <!-- SUMMON VIEW (Redesigned) -->
      <main
        id="view-summon"
        class="flex-1 hidden-view bg-slate-950 flex flex-col relative overflow-hidden"
      >
        <!-- Background Scene -->
        <div class="absolute inset-0 z-0">
          <div
            class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center opacity-30"
          ></div>
          <div
            class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/50 to-slate-900/80"
          ></div>

          <!-- Magic Circle (CSS) -->
          <div
            class="absolute top-[40%] left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] rounded-full border border-indigo-500/20 animate-[spin_60s_linear_infinite] opacity-50 pointer-events-none"
          ></div>
          <div
            class="absolute top-[40%] left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] rounded-full border-2 border-dashed border-indigo-400/30 animate-[spin_20s_linear_infinite_reverse] pointer-events-none"
          ></div>
        </div>

        <!-- Header -->
        <div class="relative z-20 p-4 flex justify-between items-start">
          <button
            onclick="changeView('view-home')"
            class="w-10 h-10 rounded-full bg-slate-900/50 backdrop-blur border border-white/10 flex items-center justify-center text-white active:scale-95 transition-transform"
          >
            ‚úï
          </button>

          <div class="flex gap-2">
            <div
              class="px-3 py-1 rounded-full bg-slate-900/80 border border-indigo-500/30 flex items-center gap-2"
            >
              <span class="text-lg">üìú</span>
              <span
                id="summon-tickets-common"
                class="text-white font-bold font-mono"
                >0</span
              >
            </div>
            <div
              class="px-3 py-1 rounded-full bg-slate-900/80 border border-amber-500/30 flex items-center gap-2"
            >
              <span class="text-lg">üé´</span>
              <span
                id="summon-tickets-epic"
                class="text-amber-400 font-bold font-mono"
                >0</span
              >
            </div>
          </div>
        </div>

        <!-- Central Platform & Crystal -->
        <div
          class="relative z-10 flex-1 flex flex-col items-center justify-center -mt-20"
        >
          <div
            id="summon-crystal-container"
            class="relative w-48 h-48 cursor-pointer transition-transform duration-500 hover:scale-105 active:scale-95"
            onclick="playSummonAnim('preview')"
          >
            <div
              class="absolute inset-0 bg-indigo-600/20 blur-3xl rounded-full animate-pulse"
            ></div>
            <div
              class="relative w-full h-full flex items-center justify-center"
            >
              <span
                class="text-[8rem] filter drop-shadow-[0_0_50px_rgba(99,102,241,0.6)] animate-float"
                >üîÆ</span
              >
            </div>
          </div>
          <h2
            class="mt-8 text-3xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-indigo-400 uppercase tracking-widest"
          >
            Portal de Invoca√ß√£o
          </h2>
          <p
            class="text-indigo-300/50 text-[10px] font-bold tracking-[0.4em] uppercase"
          >
            Convoque seus aliados
          </p>
        </div>

        <!-- Summon Controls (Bottom) -->
        <div
          class="relative z-20 bg-slate-950/80 backdrop-blur-md border-t border-white/5 p-6 rounded-t-[2.5rem]"
        >
          <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto">
            <!-- Normal Summon -->
            <div class="space-y-2">
              <button
                onclick="doSummon('common', 1)"
                class="w-full py-3 rounded-xl bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 relative group overflow-hidden active:scale-95 transition-all"
              >
                <div
                  class="absolute inset-0 bg-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity"
                ></div>
                <div
                  class="text-white font-bold text-xs uppercase relative z-10"
                >
                  Invoca√ß√£o Normal
                </div>
                <div class="text-[9px] text-slate-400 relative z-10">1 üìú</div>
              </button>
              <button
                onclick="doSummon('common', 10)"
                class="w-full py-2 rounded-xl bg-slate-900 border border-slate-800 text-[10px] text-slate-400 hover:text-white hover:border-slate-600 transition-colors uppercase font-bold"
              >
                Invocar 10x
              </button>
            </div>

            <!-- Epic Summon -->
            <div class="space-y-2">
              <button
                onclick="doSummon('epic', 1)"
                class="w-full py-3 rounded-xl bg-gradient-to-r from-amber-900/50 to-slate-900 border border-amber-500/40 relative group overflow-hidden active:scale-95 transition-all shadow-[0_0_15px_rgba(245,158,11,0.1)]"
              >
                <div
                  class="absolute inset-0 bg-amber-500/10 opacity-0 group-hover:opacity-100 transition-opacity"
                ></div>
                <div
                  class="text-amber-100 font-bold text-xs uppercase relative z-10"
                >
                  Invoca√ß√£o √âpica
                </div>
                <div class="text-[9px] text-amber-500/80 relative z-10">
                  1 üé´
                </div>
              </button>
              <button
                onclick="doSummon('epic', 10)"
                class="w-full py-2 rounded-xl bg-slate-900 border border-slate-800 text-[10px] text-amber-700 hover:text-amber-400 hover:border-amber-900/50 transition-colors uppercase font-bold"
              >
                Invocar 10x
              </button>
            </div>
          </div>

          <div class="text-center mt-4">
            <button
              onclick="changeView('view-shop')"
              class="text-[10px] text-slate-500 hover:text-indigo-400 underline transition-colors"
            >
              Ir para a Loja
            </button>
          </div>
        </div>

        <!-- Fullscreen Summon Animation Overlay -->
        <div
          id="summon-anim-overlay"
          class="absolute inset-0 z-50 bg-black hidden flex-col items-center justify-center pointer-events-auto"
        >
          <div
            id="summon-flash"
            class="absolute inset-0 bg-white opacity-0 pointer-events-none"
          ></div>

          <div class="relative">
            <div
              id="summon-core"
              class="w-1 h-1 bg-white rounded-full shadow-[0_0_100px_50px_white] transition-transform duration-1000"
            ></div>
            <div
              id="summon-rays"
              class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] opacity-0 transition-opacity duration-500"
            >
              <div
                class="absolute inset-0 border-[40px] border-t-transparent border-l-transparent border-r-transparent border-b-indigo-500/50 rounded-full animate-spin"
              ></div>
              <div
                class="absolute inset-4 border-[20px] border-b-transparent border-l-transparent border-r-transparent border-t-purple-500/50 rounded-full animate-spin-reverse"
              ></div>
            </div>
          </div>
        </div>

        <!-- Results Overlay -->
        <div
          id="summon-results"
          class="absolute inset-0 z-[60] bg-slate-950/95 hidden flex-col p-6 animate-fade-in"
        >
          <h2
            class="text-center text-3xl font-black text-white italic uppercase mb-8 mt-4 tracking-tighter"
          >
            Resultado
          </h2>

          <div
            id="summon-grid"
            class="flex-1 grid grid-cols-5 content-start gap-4 overflow-y-auto pb-20"
          >
            <!-- JS Injects Cards -->
          </div>

          <div class="absolute bottom-6 left-0 w-full px-6">
            <button
              onclick="closeSummonResults()"
              class="w-full py-4 bg-white text-slate-900 font-black uppercase rounded-2xl shadow-[0_0_30px_rgba(255,255,255,0.2)] active:scale-95 transition-transform"
            >
              Confirmar
            </button>
          </div>
        </div>
      </main>
    </div>

    <script>
      // --- DATABASE ---
      const MONSTERS_DB = [
        {
          id: "vermithrax",
          name: "Vermithrax",
          type: "Ancient Dragon",
          element: "fire",
          stars: 5,
          hp: 2500,
          atk: 250,
          def: 150,
          emoji: "üêâ",
          img: "src/Vermithrax.png",
          skills: ["melee", "fire", "sup_fire"],
        },
        {
          id: "thyron",
          name: "Thyron",
          type: "Storm Bringer",
          element: "lightning",
          stars: 5,
          hp: 1400,
          atk: 210,
          def: 80,
          emoji: "‚ö°",
          img: "src/Thyron.png",
          skills: ["melee", "bolt", "sup_lightning"],
        },
        {
          id: "neriah",
          name: "Neriah",
          type: "Ocean Guardian",
          element: "water",
          stars: 5,
          hp: 1800,
          atk: 140,
          def: 120,
          emoji: "üåä",
          img: "src/Neriah.png",
          skills: ["melee", "water", "sup_water"],
        },
        {
          id: "aelyra",
          name: "Aelyra",
          type: "Flame Witch",
          element: "fire",
          stars: 5,
          hp: 1300,
          atk: 230,
          def: 60,
          emoji: "üî•",
          img: "src/Aelyra.png",
          skills: ["melee", "fire", "sup_fire"],
        },
        {
          id: "kaelthar",
          name: "Kaelthar",
          type: "Shadow Knight",
          element: "void",
          stars: 4,
          hp: 1600,
          atk: 180,
          def: 100,
          emoji: "üåë",
          img: "src/Kaelthar.png",
          skills: ["melee", "void_slash", "sup_void"],
        },
        {
          id: "dhorak",
          name: "Dhorak",
          type: "Earth Golem",
          element: "earth",
          stars: 4,
          hp: 2200,
          atk: 110,
          def: 180,
          emoji: "üóø",
          img: "src/Dhorak.png",
          skills: ["melee", "rock_throw", "sup_earth"],
        },
        {
          id: "vireya",
          name: "Vireya",
          type: "Nature Spirit",
          element: "nature",
          stars: 3,
          hp: 1200,
          atk: 150,
          def: 90,
          emoji: "üçÉ",
          img: "src/Vireya.png",
          skills: ["melee", "leaf_cutter"],
        },
        {
          id: "brann",
          name: "Brann",
          type: "Fire Warrior",
          element: "fire",
          stars: 3,
          hp: 1100,
          atk: 160,
          def: 70,
          emoji: "üî•",
          img: "src/Brann.png",
          skills: ["melee", "fire"],
        },
        {
          id: "lysara",
          name: "Lysara",
          type: "Frost Mage",
          element: "water",
          stars: 3,
          hp: 1050,
          atk: 170,
          def: 60,
          emoji: "‚ùÑÔ∏è",
          img: "src/Lysara.png",
          skills: ["melee", "water"],
        },
        {
          id: "lumem",
          name: "Lumem",
          type: "Light Fairy",
          element: "lightning",
          stars: 2,
          hp: 900,
          atk: 190,
          def: 50,
          emoji: "‚ú®",
          img: "src/Lumem.png",
          skills: ["melee", "bolt"],
        },
        {
          id: "ravok",
          name: "Ravok",
          type: "Orc Grunt",
          element: "earth",
          stars: 2,
          hp: 1200,
          atk: 130,
          def: 60,
          emoji: "üëπ",
          img: "src/Ravok.png",
          skills: ["melee", "rock_throw"],
        },
        {
          id: "slime",
          name: "Slime",
          type: "Blob",
          element: "water",
          stars: 1,
          hp: 600,
          atk: 80,
          def: 40,
          emoji: "üíß",
          img: "",
          skills: ["melee"],
        },
        {
          id: "bat",
          name: "Bat",
          type: "Cave Bat",
          element: "void",
          stars: 1,
          hp: 500,
          atk: 90,
          def: 20,
          emoji: "ü¶á",
          img: "",
          skills: ["melee"],
        },
        // --- NEW CHARACTERS (WAVE 2) ---
        // 5 STARS (LEGENDARY)
        {
          id: "ignis",
          name: "Ignis",
          type: "Fire Warlord",
          element: "fire",
          stars: 5,
          hp: 3000,
          atk: 350,
          def: 200,
          emoji: "üëπ",
          img: "src/ignis.png",
          skills: ["melee", "fire", "meteor_strike"],
        },
        {
          id: "sylphid",
          name: "Sylphid",
          type: "Wind Queen",
          element: "wind",
          stars: 5,
          hp: 2800,
          atk: 320,
          def: 180,
          emoji: "üßö‚Äç‚ôÄÔ∏è",
          img: "src/sylphid.png",
          skills: ["melee", "wind_blade", "tornado"],
        },
        {
          id: "gaia",
          name: "Gaia",
          type: "Earth Mother",
          element: "earth",
          stars: 5,
          hp: 4000,
          atk: 200,
          def: 300,
          emoji: "üåø",
          img: "src/gaia.png",
          skills: ["melee", "earth_shatter", "earthquake"],
        },
        {
          id: "zephyr",
          name: "Zephyr",
          type: "Storm God",
          element: "lightning",
          stars: 5,
          hp: 2900,
          atk: 380,
          def: 160,
          emoji: "‚ö°",
          img: "src/zephyr.png",
          skills: ["melee", "bolt", "thunder_storm"],
        },
        {
          id: "nyx",
          name: "Nyx",
          type: "Void Assassin",
          element: "void",
          stars: 5,
          hp: 2500,
          atk: 450,
          def: 120,
          emoji: "ü•∑",
          img: "src/nyx.png",
          skills: ["melee", "shadow_strike", "void_slash"],
        },
        {
          id: "glacius",
          name: "Glacius",
          type: "Ice Titan",
          element: "water",
          stars: 5,
          hp: 3500,
          atk: 280,
          def: 250,
          emoji: "üßä",
          img: "src/glacius.png",
          skills: ["melee", "ice_shards", "blizzard"],
        },

        // 4 STARS (EPIC)
        {
          id: "vulcan",
          name: "Vulcan",
          type: "Smith",
          element: "fire",
          stars: 4,
          hp: 2200,
          atk: 250,
          def: 180,
          emoji: "üî®",
          img: "src/vulcan.png",
          skills: ["melee", "fire"],
        },
        {
          id: "nereid",
          name: "Nereid",
          type: "Mermaid",
          element: "water",
          stars: 4,
          hp: 2000,
          atk: 240,
          def: 160,
          emoji: "üßú‚Äç‚ôÄÔ∏è",
          img: "src/nereid.png",
          skills: ["melee", "ice_shards"],
        },
        {
          id: "druid",
          name: "Druid",
          type: "Keeper",
          element: "nature",
          stars: 4,
          hp: 2100,
          atk: 200,
          def: 200,
          emoji: "ü¶å",
          img: "src/druid.png",
          skills: ["melee", "poison_cloud"],
        },
        {
          id: "paladin",
          name: "Paladin",
          type: "Knight",
          element: "light",
          stars: 4,
          hp: 2500,
          atk: 180,
          def: 250,
          emoji: "üõ°Ô∏è",
          img: "src/paladin.png",
          skills: ["melee", "holy_beam"],
        },
        {
          id: "necro",
          name: "Necro",
          type: "Mage",
          element: "dark",
          stars: 4,
          hp: 1800,
          atk: 300,
          def: 100,
          emoji: "üíÄ",
          img: "src/necro.png",
          skills: ["melee", "blood_drain"],
        },
        {
          id: "ronin",
          name: "Ronin",
          type: "Samurai",
          element: "wind",
          stars: 4,
          hp: 1900,
          atk: 310,
          def: 140,
          emoji: "‚öîÔ∏è",
          img: "src/ronin.png",
          skills: ["melee", "wind_blade"],
        },

        // 3 STARS (RARE)
        {
          id: "goblin_king",
          name: "Goblin King",
          type: "Goblin",
          element: "earth",
          stars: 3,
          hp: 1500,
          atk: 150,
          def: 100,
          emoji: "üë∫",
          img: "src/goblin.png",
          skills: ["melee"],
        },
        {
          id: "harpy",
          name: "Harpy",
          type: "Beast",
          element: "wind",
          stars: 3,
          hp: 1400,
          atk: 160,
          def: 80,
          emoji: "ü¶Ö",
          img: "src/harpy.png",
          skills: ["melee"],
        },
        {
          id: "stone_giant",
          name: "Stone Giant",
          type: "Construct",
          element: "earth",
          stars: 3,
          hp: 2000,
          atk: 100,
          def: 150,
          emoji: "üóø",
          img: "src/golem.png",
          skills: ["melee"],
        },
        {
          id: "lizardman",
          name: "Lizardman",
          type: "Beast",
          element: "water",
          stars: 3,
          hp: 1600,
          atk: 140,
          def: 110,
          emoji: "ü¶é",
          img: "src/lizard.png",
          skills: ["melee"],
        },
        {
          id: "skeleton_archer",
          name: "Skeleton",
          type: "Undead",
          element: "dark",
          stars: 3,
          hp: 1200,
          atk: 180,
          def: 50,
          emoji: "üèπ",
          img: "src/skel.png",
          skills: ["melee"],
        },
        {
          id: "fairy",
          name: "Fairy",
          type: "Fey",
          element: "light",
          stars: 3,
          hp: 1000,
          atk: 120,
          def: 80,
          emoji: "ü¶ã",
          img: "src/fairy.png",
          skills: ["melee"],
        },
        {
          id: "imp",
          name: "Imp",
          type: "Demon",
          element: "fire",
          stars: 3,
          hp: 1100,
          atk: 130,
          def: 70,
          emoji: "üòà",
          img: "src/imp.png",
          skills: ["melee"],
        },
        {
          id: "wolf",
          name: "Wolf",
          type: "Beast",
          element: "nature",
          stars: 3,
          hp: 1300,
          atk: 140,
          def: 90,
          emoji: "üê∫",
          img: "src/wolf.png",
          skills: ["melee"],
        },
      ];

      const SKILLS = {
        melee: { n: "Ataque", p: 1.0, icon: "‚öîÔ∏è", type: "phys", mp: 0 },
        bolt: { n: "Raio", p: 1.5, icon: "‚ö°", type: "lightning", mp: 20 },
        water: { n: "Jato", p: 1.4, icon: "üíß", type: "water", mp: 20 },
        fire: { n: "Brasa", p: 1.6, icon: "üî•", type: "fire", mp: 20 },
        void_slash: {
          n: "Corte Vazio",
          p: 1.8,
          icon: "üåë",
          type: "void",
          mp: 25,
        },
        rock_throw: { n: "Rocha", p: 1.5, icon: "ü™®", type: "earth", mp: 20 },
        leaf_cutter: { n: "Folha", p: 1.4, icon: "üçÉ", type: "nature", mp: 20 },
        sup_lightning: {
          n: "Tempestade",
          p: 3.0,
          icon: "üå©Ô∏è",
          type: "lightning_sup",
          mp: 50,
        },
        sup_water: {
          n: "Tsunami",
          p: 2.8,
          icon: "üåä",
          type: "water_sup",
          mp: 50,
        },
        sup_fire: {
          n: "Chuva Meteoros",
          p: 3.2,
          icon: "üåã",
          type: "fire_sup",
          mp: 50,
        },
        sup_earth: {
          n: "Avalanche",
          p: 3.0,
          icon: "üèöÔ∏è",
          type: "earth_sup",
          mp: 50,
        },
        sup_void: {
          n: "Devasta√ß√£o",
          p: 3.5,
          icon: "‚ö´",
          type: "void_sup",
          mp: 60,
        },
        // NEW PREMIUM SKILLS
        ice_shards: {
          n: "Estilha√ßos",
          p: 1.8,
          icon: "‚ùÑÔ∏è",
          type: "ice_shards",
          mp: 25,
        },
        poison_cloud: {
          n: "Nuvem T√≥xica",
          p: 1.5,
          icon: "‚ò†Ô∏è",
          type: "poison_cloud",
          mp: 30,
        },
        holy_beam: {
          n: "Luz Divina",
          p: 3.0,
          icon: "‚ú®",
          type: "holy_beam",
          mp: 45,
        },
        blood_drain: {
          n: "Drenar Vida",
          p: 1.6,
          icon: "ü©∏",
          type: "blood_drain",
          mp: 35,
        },
        shadow_strike: {
          n: "Golpe Sombrio",
          p: 2.2,
          icon: "üë§",
          type: "shadow_strike",
          mp: 30,
        },
        thunder_storm: {
          n: "Tempestade",
          p: 2.5,
          icon: "‚ö°",
          type: "thunder_storm",
          mp: 50,
        },
        wind_blade: {
          n: "L√¢mina de Vento",
          p: 1.7,
          icon: "üå™Ô∏è",
          type: "wind_blade",
          mp: 25,
        },
        meteor_strike: {
          n: "Meteoro",
          p: 3.2,
          icon: "‚òÑÔ∏è",
          type: "meteor_strike",
          mp: 55,
        },
        arcane_barrage: {
          n: "M√≠sseis Arcanos",
          p: 2.0,
          icon: "üîÆ",
          type: "arcane_barrage",
          mp: 35,
        },
        earth_shatter: {
          n: "Tremor",
          p: 2.1,
          icon: "üåã",
          type: "earth_shatter",
          mp: 40,
        },
      };

      const EQ_RARITY = {
        common: { name: "Comum", mult: 1, color: "rarity-common" },
        rare: { name: "Raro", mult: 1.5, color: "rarity-rare" },
        epic: { name: "√âpico", mult: 2.2, color: "rarity-epic" },
        legendary: { name: "Lend√°rio", mult: 3.5, color: "rarity-legendary" },
      };

      let state = {
        user: {
          name: "",
          crystals: 200,
          energy: 100,
          gold: 0,
          tickets_common: 0,
          tickets_epic: 0,
          lvl: 1,
          xp: 0,
          potions: 0,
          firstClear: {},
        },
        inventory: [],
        equipment: [], // Global Equipment Storage
        leaderIdx: 0,
        storyProgress: 1,
        towerFloor: 1,
      };

      let battleState = {
        active: false,
        busy: false,
        mode: "dungeon",
        auto: false,
        speed: 1,
      };
      let prepState = { mode: "", level: 1, selectedMonIdx: 0 };
      let currentEqId = null; // for modal
      let currentInvFilter = "all";

      // --- TOAST SYSTEM ---
      const showToast = (message, type = "success") => {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");

        let icon = "‚úÖ";
        if (type === "error") icon = "‚ùå";
        if (type === "info") icon = "‚ÑπÔ∏è";

        toast.className = `toast ${type}`;
        toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;

        container.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "toast-fade 0.3s ease-in forwards";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      };

      const addMonster = (id) => {
        const template = MONSTERS_DB.find((m) => m.id === id);
        if (!template) {
          console.error("Monster ID not found:", id);
          return;
        }

        const newMon = {
          ...template,
          instanceId: Date.now() + Math.random().toString(),
          xp: 0,
          lvl: 1,
          equipped: { weapon: null, armor: null, acc: null },
          stars: template.stars, // Ensure stars from DB
        };

        state.inventory.push(newMon);
      };

      // --- CORE ---
      // --- CORE ---
      const init = () => {
        const lastUser = localStorage.getItem("paperwar_last_user");

        if (lastUser) {
          const saved = localStorage.getItem(`paperwar_save_${lastUser}`);
          if (saved) {
            try {
              state = JSON.parse(saved);
              loadMigration();
              changeView("view-home");
              updateHeader();
              return;
            } catch (e) {
              console.error("Corrupted save", e);
            }
          }
        }

        // No user found, show login
        changeView("view-login");
      };

      const loadMigration = () => {
        if (!state.equipment) state.equipment = [];
        if (state.user.potions === undefined) state.user.potions = 0;
        if (state.user.lvl === undefined) state.user.lvl = 1;
        state.inventory.forEach((m) => {
          const db = MONSTERS_DB.find((x) => x.id === m.id);
          if (db) {
            if (!m.img) m.img = db.img;
            if (!m.emoji) m.emoji = db.emoji;
            m.skills = db.skills;
            m.stars = db.stars;
          }
          if (!m.equipped)
            m.equipped = { weapon: null, armor: null, acc: null };
        });
      };

      const save = () => {
        if (!state.user.name) return;
        localStorage.setItem(
          `paperwar_save_${state.user.name}`,
          JSON.stringify(state)
        );
      };

      const handleLogin = () => {
        try {
          const val = document.getElementById("login-name").value.trim();
          if (!val) {
            showToast("Por favor, digite um nome!", "error");
            return;
          }

          // Check if user exists
          const saved = localStorage.getItem(`paperwar_save_${val}`);
          if (saved) {
            state = JSON.parse(saved);
            loadMigration();
            showToast(`Bem-vindo de volta, ${val}!`);
          } else {
            // Create New
            state.user.name = val;
            state.user.crystals = 200;
            state.user.gold = 0;
            state.user.lvl = 1;
            state.user.tickets_common = 5;
            state.user.tickets_epic = 10;
            state.inventory = [];
            state.equipment = [];
            addMonster("thyron");
            addMonster("vireya");
            addMonster("slime");
            showToast(`Conta criada: ${val}`);
          }

          localStorage.setItem("paperwar_last_user", val);
          save();

          document.getElementById("player-name-ui").innerText = state.user.name;
          document.getElementById("header-initial").innerText =
            state.user.name[0].toUpperCase();
          changeView("view-home");
          updateHeader();
        } catch (e) {
          showToast("Erro no Login: " + e.message, "error");
          console.error(e);
        }
      };

      const changeView = (id) => {
        const target = document.getElementById(id);
        if (!target) return;

        document
          .querySelectorAll("main")
          .forEach((el) => el.classList.add("hidden-view"));
        target.classList.remove("hidden-view");

        const h = document.getElementById("ui-header");
        if (h) {
          if (
            [
              "view-login",
              "view-battle",
              "view-summon",
              "view-shop",
              "view-prep",
            ].includes(id)
          ) {
            h.classList.remove("flex");
            h.classList.add("hidden");
          } else {
            h.classList.remove("hidden");
            h.classList.add("flex");
          }
        }

        if (id === "view-collection") renderMonsterBox();
        if (id === "view-story") renderStory();
        if (id === "view-summon") updateSummonUI();
        if (id === "view-shop") updateShopUI();
        if (id === "view-dungeon") renderDungeonFloors();
        if (id === "view-inventory") {
          currentInvFilter = "all";
          renderInventory();
        }
        if (id === "view-tower")
          document.getElementById("tower-floor-display").innerText =
            state.towerFloor;
      };

      const updateHeader = () => {
        document.getElementById("val-crystals").innerText = state.user.crystals;
        document.getElementById("val-energy").innerText = state.user.energy;
        document.getElementById("val-gold").innerText = state.user.gold;
        document.getElementById("header-lvl").innerText = state.user.lvl;

        const xpReq = 100 * state.user.lvl;
        const pct = Math.min(100, (state.user.xp / xpReq) * 100);
        document.getElementById("header-xp-bar").style.width = `${pct}%`;
      };

      const logout = () => {
        if (confirm(`Sair da conta ${state.user.name}?`)) {
          localStorage.removeItem("paperwar_last_user");
          location.reload();
        }
      };

      // --- SHOP & EQUIPMENT LOGIC ---
      const updateShopUI = () => {
        document.getElementById("shop-crystals").innerText =
          state.user.crystals;
        document.getElementById("shop-gold").innerText = state.user.gold;
      };
      const buyShopItem = (item) => {
        if (item === "ticket_common") {
          if (state.user.gold < 2000)
            return showToast("Ouro insuficiente!", "error");
          state.user.gold -= 2000;
          state.user.tickets_common++;
        }
        if (item === "ticket_epic") {
          if (state.user.crystals < 300)
            return showToast("Cristais insuficientes!", "error");
          state.user.crystals -= 300;
          state.user.tickets_epic++;
        }
        if (item === "energy") {
          if (state.user.crystals < 50)
            return showToast("Cristais insuficientes!", "error");
          state.user.crystals -= 50;
          state.user.energy += 50;
        }
        if (item === "xp_pot") {
          if (state.user.gold < 500)
            return showToast("Ouro insuficiente!", "error");
          state.user.gold -= 500;
          state.user.potions++;
        }

        save();
      };
      let currentSummonResults = [];

      const playSummonAnim = async (type) => {
        if (type === "preview") {
          // Just a fun interaction
          const gate = document.getElementById("summon-gate");
          gate.classList.add("scale-110");
          await sleep(100);
          gate.classList.remove("scale-110");
          return;
        }
      };

      const doSummon = async (type = "common", amount = 1) => {
        // Validation
        let cost = 1 * amount;
        let tType = type === "epic" ? "tickets_epic" : "tickets_common";

        if (state.user[tType] < cost) {
          return showToast("Bilhetes insuficientes!", "error");
        }

        // Deduct
        state.user[tType] -= cost;
        updateHeader();
        updateSummonUI();

        // 1. ANIMATION SEQUENCE
        const overlay = document.getElementById("summon-anim-overlay");
        overlay.classList.remove("hidden");
        overlay.classList.add("flex");

        const core = document.getElementById("summon-core");
        const rays = document.getElementById("summon-rays");
        const flash = document.getElementById("summon-flash");

        // Reset state
        core.style.transform = "scale(1)";
        rays.style.opacity = "0";
        flash.style.opacity = "0";

        // Animate
        // Charge
        core.style.transform = "scale(0.5)";
        await sleep(500);

        // Spin
        rays.style.opacity = "1";
        await sleep(1500);

        // Flash/Explode
        flash.style.transition = "opacity 0.1s";
        flash.style.opacity = "1";
        await sleep(100);

        // Hide anim elements while white screen is up
        core.style.opacity = "0";
        rays.style.opacity = "0";

        await sleep(200);

        // 2. GENERATION
        currentSummonResults = [];
        for (let i = 0; i < amount; i++) {
          let rarity = "common";
          const r = Math.random();

          if (type === "common") {
            if (r < 0.8) rarity = "common";
            else if (r < 0.98) rarity = "rare";
            else rarity = "epic";
          } else {
            // Epic Ticket
            if (r < 0.6) rarity = "rare";
            else if (r < 0.9) rarity = "epic";
            else rarity = "legendary";
          }

          let minStar = 1,
            maxStar = 2;
          if (rarity === "rare") {
            minStar = 3;
            maxStar = 3;
          }
          if (rarity === "epic") {
            minStar = 4;
            maxStar = 4;
          }
          if (rarity === "legendary") {
            minStar = 5;
            maxStar = 5;
          }

          const pool = MONSTERS_DB.filter(
            (m) => m.stars >= minStar && m.stars <= maxStar
          );

          // Fallback if pool is empty (safety)
          let template;
          if (pool.length === 0) {
            console.warn("Empty pool for", rarity, minStar, maxStar);
            template = MONSTERS_DB[0]; // Fallback to first mon
          } else {
            template = pool[Math.floor(Math.random() * pool.length)];
          }

          const newMon = {
            ...template,
            instanceId: Date.now() + Math.random().toString() + i, // unique
            xp: 0,
            lvl: 1,
            equipped: { weapon: null, armor: null, acc: null },
            stars: template.stars,
          };

          state.inventory.push(newMon);
          currentSummonResults.push(newMon);
        }

        save();

        // 3. SHOW RESULTS
        renderSummonResults(); // Build DOM first

        flash.style.opacity = "0"; // Fade out white
        await sleep(300);

        overlay.classList.remove("flex");
        overlay.classList.add("hidden");

        // Cleanup Anim
        core.style.opacity = "1";
        core.style.transform = "scale(1)";
        rays.style.opacity = "0";
      };

      const renderSummonResults = () => {
        const modal = document.getElementById("summon-results");
        const grid = document.getElementById("summon-grid");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        grid.innerHTML = "";

        currentSummonResults.forEach((mon, idx) => {
          const card = document.createElement("div");
          // Flip animation setup
          card.className = "relative w-32 h-44 perspective-1000 opacity-0";
          card.style.animation = `card-flip 0.5s ease-out ${
            idx * 0.1
          }s forwards`;

          // Rarity Style
          let borderCol = "border-slate-600";
          let bgGrad = "from-slate-700 to-slate-900";
          let glow = "";

          if (mon.stars === 3) {
            borderCol = "border-blue-500";
            bgGrad = "from-blue-900 to-slate-900";
          }
          if (mon.stars === 4) {
            borderCol = "border-purple-500";
            bgGrad = "from-purple-900 to-slate-900";
            glow = "shadow-[0_0_15px_#a855f7]";
          }
          if (mon.stars === 5) {
            borderCol = "border-amber-400";
            bgGrad = "from-amber-900 to-slate-900";
            glow = "shadow-[0_0_20px_#fbbf24]";
          }

          card.innerHTML = `
                <div class="w-full h-full rounded-xl border-2 ${borderCol} bg-gradient-to-br ${bgGrad} p-2 flex flex-col items-center justify-between ${glow}">
                    <div class="w-full flex justify-between items-start">
                        <span class="text-[10px] text-white font-bold bg-black/50 px-1 rounded">${"‚≠ê".repeat(
                          mon.stars
                        )}</span>
                        ${
                          mon.stars >= 5
                            ? '<span class="animate-pulse text-amber-300">‚ú®</span>'
                            : ""
                        }
                    </div>
                    <div class="text-4xl filter drop-shadow-lg">${
                      mon.emoji
                    }</div>
                    <div class="text-center w-full">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">${
                          mon.type
                        }</div>
                        <div class="text-xs text-white font-black truncate w-full">${
                          mon.name
                        }</div>
                    </div>
                </div>
             `;
          grid.appendChild(card);
        });
      };

      const closeSummonResults = () => {
        document.getElementById("summon-results").classList.remove("flex");
        document.getElementById("summon-results").classList.add("hidden");
      };

      const createEquipment = (floorLevel = 1, dungeonType = "golem") => {
        let types = ["weapon", "armor", "acc"];
        if (dungeonType === "golem") types = ["weapon", "armor"];
        if (dungeonType === "dragon") types = ["acc"];

        const type = types[Math.floor(Math.random() * types.length)];

        // Logic for Rarity based on Floor Level (Dungeon)
        // Floors: 1-12
        let rarity = "common";
        const r = Math.random();

        let chanceCommon = 0.8;
        let chanceRare = 0.99;
        let chanceEpic = 1.0;

        if (floorLevel <= 3) {
          // 1-3: Mostly common
          chanceCommon = 0.8;
          chanceRare = 0.99;
        } else if (floorLevel <= 6) {
          // 4-6: Better
          chanceCommon = 0.5;
          chanceRare = 0.9;
          chanceEpic = 0.99;
        } else if (floorLevel <= 9) {
          // 7-9: Good
          chanceCommon = 0.3;
          chanceRare = 0.8;
          chanceEpic = 0.95;
        } else {
          // 10-12: High tier
          chanceCommon = 0.1;
          chanceRare = 0.5;
          chanceEpic = 0.85;
        }

        if (r < chanceCommon) rarity = "common";
        else if (r < chanceRare) rarity = "rare";
        else if (r < chanceEpic) rarity = "epic";
        else rarity = "legendary";

        const base = EQ_RARITY[rarity];
        const eq = {
          id: "eq_" + Date.now() + Math.random().toString(36).substr(2, 9),
          type: type,
          rarity: rarity,
          lvl: 0,
          stats: { atk: 0, def: 0, crit: 0, cdmg: 0 },
        };

        // Stat Generation
        if (type === "weapon") eq.stats.atk = Math.floor(10 * base.mult);
        if (type === "armor") {
          eq.stats.def = Math.floor(5 * base.mult);
          eq.stats.hp = Math.floor(50 * base.mult);
        }
        if (type === "acc") {
          eq.stats.crit = Math.floor(2 * base.mult);
          eq.stats.cdmg = Math.floor(5 * base.mult);
        }

        // Random Substats
        const subStatCount =
          rarity === "legendary"
            ? 3
            : rarity === "epic"
            ? 2
            : rarity === "rare"
            ? 1
            : 0;
        for (let i = 0; i < subStatCount; i++) {
          const sub = Math.random();
          if (sub < 0.25)
            eq.stats.atk = (eq.stats.atk || 0) + Math.floor(5 * base.mult);
          else if (sub < 0.5)
            eq.stats.def = (eq.stats.def || 0) + Math.floor(3 * base.mult);
          else if (sub < 0.75) eq.stats.crit = (eq.stats.crit || 0) + 1;
          else eq.stats.cdmg = (eq.stats.cdmg || 0) + 2;
        }

        return eq;
      };

      const handleEqClick = (slot) => {
        const mon = state.inventory[selectedDetailIdx];
        const equippedId = mon.equipped[slot];

        if (equippedId) {
          // Open Upgrade Modal
          currentEqId = equippedId;
          renderUpgradeModal();
        } else {
          // Equip Logic: Find best available or just list
          const items = state.equipment.filter(
            (e) => e.type === slot && !isEquipped(e.id)
          );
          if (items.length > 0) {
            // Sort by rarity/stats ideally, but just take first for now
            mon.equipped[slot] = items[0].id;
            save();
            openDetail(selectedDetailIdx);
            showToast("Equipado!");
          } else {
            showToast("Nenhum item dispon√≠vel no Ba√∫!", "info");
          }
        }
      };

      const isEquipped = (id) => {
        return state.inventory.some(
          (m) =>
            m.equipped.weapon === id ||
            m.equipped.armor === id ||
            m.equipped.acc === id
        );
      };

      const getEquipperName = (id) => {
        const mon = state.inventory.find(
          (m) =>
            m.equipped.weapon === id ||
            m.equipped.armor === id ||
            m.equipped.acc === id
        );
        return mon ? mon.name : null;
      };

      const renderUpgradeModal = () => {
        const eq = state.equipment.find((e) => e.id === currentEqId);
        if (!eq) return;

        const modal = document.getElementById("eq-modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        const conf = EQ_RARITY[eq.rarity];
        document.getElementById("eq-modal-title").innerText = `${
          conf.name
        } ${eq.type.toUpperCase()}`;
        document.getElementById(
          "eq-modal-title"
        ).className = `text-xl font-bold mb-2 ${conf.color.replace(
          "border-color:",
          "text-"
        )}`;
        document.getElementById("eq-modal-level").innerText = `+${eq.lvl}`;

        document.getElementById("eq-stat-atk").innerText = eq.stats.atk || 0;
        document.getElementById("eq-stat-def").innerText = eq.stats.def || 0;
        document.getElementById("eq-stat-crit").innerText =
          (eq.stats.crit || 0) + "%";
        document.getElementById("eq-stat-cdmg").innerText =
          (eq.stats.cdmg || 0) + "%";

        const cost = 100 * (eq.lvl + 1);
        const chance = Math.max(5, 100 - eq.lvl * 5);
        const sellPrice = 50 * (eq.lvl + 1) * conf.mult;

        const btn = document.getElementById("btn-upgrade");
        document.getElementById("upg-cost").innerText = cost;
        document.getElementById("sell-price").innerText = Math.floor(sellPrice);
        document.getElementById("upg-chance").innerText = `Sucesso: ${chance}%`;

        const equippedBy = getEquipperName(eq.id);
        const ownerTxt = document.getElementById("eq-equipped-by");
        if (equippedBy) {
          ownerTxt.innerText = `Equipado em: ${equippedBy}`;
          ownerTxt.classList.remove("hidden");
          document.getElementById("btn-sell").disabled = true;
          document
            .getElementById("btn-sell")
            .classList.add("opacity-50", "grayscale");
        } else {
          ownerTxt.classList.add("hidden");
          document.getElementById("btn-sell").disabled = false;
          document
            .getElementById("btn-sell")
            .classList.remove("opacity-50", "grayscale");
        }

        btn.onclick = () => performUpgrade(eq, cost, chance);
      };

      const sellEquipment = () => {
        const eq = state.equipment.find((e) => e.id === currentEqId);
        if (!eq) return;
        if (getEquipperName(eq.id))
          return showToast("Desequipe antes de vender!", "error");

        const conf = EQ_RARITY[eq.rarity];
        const price = Math.floor(50 * (eq.lvl + 1) * conf.mult);

        state.user.gold += price;
        state.equipment = state.equipment.filter((e) => e.id !== currentEqId);
        save();

        document.getElementById("eq-modal").classList.add("hidden");
        showToast(`Vendido por ${price} Ouro`);
        updateHeader();

        // Refresh views
        if (
          !document
            .getElementById("view-inventory")
            .classList.contains("hidden-view")
        )
          renderInventory();
        if (
          !document
            .getElementById("mon-detail-overlay")
            .classList.contains("hidden")
        )
          openDetail(selectedDetailIdx);
      };

      const performUpgrade = (eq, cost, chance) => {
        if (state.user.gold < cost)
          return showToast("Ouro insuficiente!", "error");
        state.user.gold -= cost;

        const roll = Math.random() * 100;
        if (roll <= chance) {
          eq.lvl++;
          // Boost Stats
          if (eq.stats.atk) eq.stats.atk += Math.ceil(eq.stats.atk * 0.1) + 2;
          if (eq.stats.def) eq.stats.def += Math.ceil(eq.stats.def * 0.1) + 1;
          if (eq.stats.crit) eq.stats.crit += 1;
          if (eq.stats.cdmg) eq.stats.cdmg += 2;

          showToast("Upgrade Sucesso! +" + eq.lvl, "success");
        } else {
          showToast("Falha no Upgrade...", "error");
          document.getElementById("eq-modal").classList.add("animate-shake");
          setTimeout(
            () =>
              document
                .getElementById("eq-modal")
                .classList.remove("animate-shake"),
            500
          );
        }
        save();
        updateHeader();
        renderUpgradeModal();
        // Refresh views underneath
        if (
          !document
            .getElementById("view-inventory")
            .classList.contains("hidden-view")
        )
          renderInventory();
        if (
          !document
            .getElementById("mon-detail-overlay")
            .classList.contains("hidden")
        )
          openDetail(selectedDetailIdx);
      };

      // --- INVENTORY VIEW LOGIC ---
      const filterInventory = (type) => {
        currentInvFilter = type;
        document.querySelectorAll(".inv-tab").forEach((b) => {
          b.classList.remove("bg-indigo-600", "text-white");
          b.classList.add("bg-slate-800", "text-slate-400");
        });
        const activeBtn = document.getElementById(`tab-${type}`);
        activeBtn.classList.remove("bg-slate-800", "text-slate-400");
        activeBtn.classList.add("bg-indigo-600", "text-white");
        renderInventory();
      };

      const renderInventory = () => {
        const grid = document.getElementById("inventory-grid");
        grid.innerHTML = "";

        let items = state.equipment;
        if (currentInvFilter !== "all")
          items = items.filter((e) => e.type === currentInvFilter);

        if (items.length === 0) {
          document.getElementById("inv-empty-msg").classList.remove("hidden");
          document.getElementById("inv-empty-msg").classList.add("flex");
        } else {
          document.getElementById("inv-empty-msg").classList.add("hidden");
          document.getElementById("inv-empty-msg").classList.remove("flex");
        }

        items.forEach((eq) => {
          const conf = EQ_RARITY[eq.rarity];
          const equippedBy = getEquipperName(eq.id);

          const el = document.createElement("div");
          el.className = `aspect-square bg-slate-900 rounded-xl border relative cursor-pointer active:scale-95 transition-transform ${conf.color}`;
          // override text color for border
          el.style.borderColor =
            eq.rarity === "legendary"
              ? "#fbbf24"
              : eq.rarity === "epic"
              ? "#a855f7"
              : eq.rarity === "rare"
              ? "#3b82f6"
              : "#94a3b8";

          const icon =
            eq.type === "weapon" ? "‚öîÔ∏è" : eq.type === "armor" ? "üõ°Ô∏è" : "üíç";

          el.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center text-2xl">${icon}</div>
                    <div class="absolute top-1 right-1 text-[9px] font-black bg-black/60 px-1 rounded text-white">+${
                      eq.lvl
                    }</div>
                    ${
                      equippedBy
                        ? `<div class="absolute bottom-1 right-1 w-4 h-4 rounded-full bg-indigo-600 border border-white flex items-center justify-center text-[8px] font-bold text-white" title="${equippedBy}">E</div>`
                        : ""
                    }
                `;
          el.onclick = () => {
            currentEqId = eq.id;
            renderUpgradeModal();
          };
          grid.appendChild(el);
        });
      };

      const updateSummonUI = () => {
        const elC = document.getElementById("summon-tickets-common");
        const elE = document.getElementById("summon-tickets-epic");
        if (elC) elC.innerText = state.user.tickets_common;
        if (elE) elE.innerText = state.user.tickets_epic;
      };

      // --- DUNGEON & PREP ---
      // --- DUNGEON & PREP ---
      let selectedDungeonType = "golem";

      const openDungeonSelect = (type) => {
        selectedDungeonType = type;
        changeView("view-dungeon");
      };

      const renderDungeonFloors = () => {
        const c = document.getElementById("dungeon-list");
        c.innerHTML = "";
        const title =
          selectedDungeonType === "golem"
            ? "Masmorra do Golem"
            : "Masmorra do Drag√£o";

        document.querySelector("#view-dungeon h2").innerText = title;

        for (let i = 1; i <= 12; i++) {
          const btn = document.createElement("div");
          btn.className =
            "glass-panel p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform border border-white/5 hover:bg-white/5";
          btn.innerHTML = `<div><h4 class="text-white font-bold">${
            selectedDungeonType === "golem" ? "Golem" : "Drag√£o"
          } B${i}</h4><p class="text-xs text-purple-400">Lv. ${i * 5} ‚Ä¢ ${
            5 + Math.floor(i / 2)
          } ‚ö°</p></div><div class="text-white">‚ñ∂</div>`;
          btn.onclick = () => openPrep("dungeon_" + selectedDungeonType, i);
          c.appendChild(btn);
        }
      };

      const openPrep = (mode, lvl) => {
        prepState = { mode, level: lvl, selectedMonIdx: state.leaderIdx };
        changeView("view-prep");
        const titles = {
          dungeon_golem: `Golem B${lvl}`,
          dungeon_dragon: `Drag√£o B${lvl}`,
          tower: `Torre Andar ${lvl}`,
          story: `Campanha Fase ${lvl}`,
        };
        // Normalize dungeon cost
        let cost = 5;
        if (mode.startsWith("dungeon")) cost = 5 + Math.floor(lvl / 2);

        document.getElementById("prep-title").innerText = titles[mode];
        document.getElementById("prep-cost").innerText = `${cost} ‚ö°`;
        renderPrepUnit();
        renderPrepRoster();
      };

      const renderPrepUnit = () => {
        const mon = state.inventory[prepState.selectedMonIdx];
        const stats = calculateStats(mon);

        document.getElementById("prep-img").src = mon.img;
        document.getElementById("prep-name").innerText = mon.name;
        document.getElementById("prep-el").innerText = {
          fire: "üî•",
          water: "üåä",
          lightning: "‚ö°",
          earth: "üóø",
          nature: "üçÉ",
          void: "üåë",
        }[mon.element];
        document.getElementById(
          "prep-stats"
        ).innerText = `Atk: ${stats.atk} | HP: ${stats.hp}`;
      };

      const calculateStats = (mon) => {
        const m = 1 + mon.lvl * 0.1;
        let s = {
          hp: Math.floor(mon.hp * m),
          atk: Math.floor(mon.atk * m),
          def: Math.floor(mon.def * m),
          crit: 10,
          cdmg: 50,
        };

        ["weapon", "armor", "acc"].forEach((slot) => {
          if (mon.equipped && mon.equipped[slot]) {
            const eq = state.equipment.find((e) => e.id === mon.equipped[slot]);
            if (eq) {
              if (eq.stats.hp) s.hp += eq.stats.hp;
              if (eq.stats.atk) s.atk += eq.stats.atk;
              if (eq.stats.def) s.def += eq.stats.def;
              if (eq.stats.crit) s.crit += eq.stats.crit;
              if (eq.stats.cdmg) s.cdmg += eq.stats.cdmg;
            }
          }
        });
        return s;
      };

      const renderPrepRoster = () => {
        const grid = document.getElementById("prep-grid");
        grid.innerHTML = "";
        state.inventory.forEach((mon, idx) => {
          const el = document.createElement("div");
          const isSel = idx === prepState.selectedMonIdx;
          el.className = `aspect-square bg-slate-800 rounded-lg p-1 border-2 cursor-pointer ${
            isSel ? "border-green-500" : "border-transparent"
          }`;
          el.innerHTML = `<img src="${mon.img}" class="w-full h-full object-contain">`;
          el.onclick = () => {
            prepState.selectedMonIdx = idx;
            renderPrepUnit();
            renderPrepRoster();
            document.getElementById("prep-roster").classList.add("hidden");
          };
          grid.appendChild(el);
        });
      };

      const confirmBattle = () => startBattle(prepState.mode, prepState.level);

      // --- BATTLE ---
      const startBattle = (mode, lvl = 1) => {
        let cost = 5;
        if (mode.startsWith("dungeon")) cost = 5 + Math.floor(lvl / 2);

        if (state.user.energy < cost) return showToast("Sem energia!", "error");
        state.user.energy -= cost;
        updateHeader();

        battleState = {
          active: true,
          mode: mode,
          busy: false,
          auto: false,
          speed: 1,
        };
        updateBattleControls();

        const pBase = state.inventory[prepState.selectedMonIdx];
        const stats = calculateStats(pBase);

        battleState.player = {
          ...pBase,
          curHp: stats.hp,
          maxHp: stats.hp,
          atk: stats.atk,
          def: stats.def,
          crit: stats.crit,
          cdmg: stats.cdmg,
          mp: 50,
          maxMp: 100,
        };

        setupEnemy(mode, lvl);
        changeView("view-battle");
        renderBattleScene();
        document.getElementById("battle-overlay").classList.add("hidden");
        document.getElementById("battle-overlay").style.opacity = "0";
      };

      const setupEnemy = (mode, lvlArg) => {
        let template;
        if (mode === "dungeon_golem") {
          template = MONSTERS_DB.find((m) => m.id === "dhorak");
        } else if (mode === "dungeon_dragon") {
          template = MONSTERS_DB.find((m) => m.id === "vermithrax");
        } else {
          template =
            MONSTERS_DB[Math.floor(Math.random() * MONSTERS_DB.length)];
        }

        let lvl = 1;
        if (mode.startsWith("dungeon")) lvl = lvlArg * 5;
        else if (mode === "tower") lvl = lvlArg * 2;
        else lvl = lvlArg * 3;

        const m = 1 + lvl * 0.15;
        battleState.enemy = {
          ...template,
          lvl: lvl,
          curHp: Math.floor(template.hp * m),
          maxHp: Math.floor(template.hp * m),
          atk: Math.floor(template.atk * m),
          def: Math.floor(template.def * m),
          crit: 5,
          cdmg: 50,
        };

        updateBattleHUD();
        const el = document.getElementById("enemy-sprite-container");
        el.innerHTML = `<img src="${template.img}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"> <span style="display:none;font-size:4rem;filter:drop-shadow(0 10px 10px rgba(0,0,0,0.5))">${template.emoji}</span>`;
      };

      const renderBattleScene = () => {
        const pl = document.getElementById("player-sprite-container");
        pl.innerHTML = `<img src="${battleState.player.img}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"> <span style="display:none;font-size:4rem;filter:drop-shadow(0 10px 10px rgba(0,0,0,0.5))">${battleState.player.emoji}</span>`;
        renderSkillGrid();
      };

      const renderSkillGrid = () => {
        const grid = document.getElementById("skill-grid");
        grid.innerHTML = "";
        grid.className = `grid gap-2 ${
          battleState.player.skills.length > 2 ? "grid-cols-3" : "grid-cols-2"
        }`;

        battleState.player.skills.forEach((k) => {
          const s = SKILLS[k];
          if (!s) return;
          const canAfford = battleState.player.mp >= s.mp;
          const btn = document.createElement("button");
          btn.className = `bg-slate-800/80 border border-white/10 rounded-xl p-2 flex flex-col items-center transition-all ${
            canAfford
              ? "hover:bg-white/10 active:scale-90"
              : "opacity-50 grayscale cursor-not-allowed"
          }`;
          btn.innerHTML = `
                    <span class="text-xl mb-1">${s.icon}</span>
                    <span class="text-[8px] font-black uppercase text-white">${
                      s.n
                    }</span>
                    ${
                      s.mp > 0
                        ? `<span class="text-[8px] text-blue-300 font-bold">${s.mp} MP</span>`
                        : ""
                    }
                `;
          btn.onclick = () => {
            if (canAfford) doPlayerTurn(k);
          };
          grid.appendChild(btn);
        });
      };

      const doPlayerTurn = async (skillKey) => {
        if (battleState.busy) return;
        battleState.busy = true;
        try {
          const skill = SKILLS[skillKey];
          battleState.player.mp -= skill.mp;
          updateBattleHUD();
          renderSkillGrid();

          await executeAction(
            battleState.player,
            battleState.enemy,
            skillKey,
            true
          );
          if (battleState.enemy.curHp <= 0) winBattle();
          else {
            document.getElementById("combat-log").innerText = "Turno Inimigo";
            setTimeout(doEnemyTurn, 1000 / battleState.speed);
          }
        } catch (e) {
          console.error(e);
          battleState.busy = false;
        }
      };

      const doEnemyTurn = async () => {
        try {
          const skills = battleState.enemy.skills;
          await executeAction(
            battleState.enemy,
            battleState.player,
            skills[Math.floor(Math.random() * skills.length)],
            false
          );

          battleState.player.mp = Math.min(
            battleState.player.maxMp,
            battleState.player.mp + 10
          );
          updateBattleHUD();
          renderSkillGrid();

          if (battleState.player.curHp <= 0) loseBattle();
          else {
            document.getElementById("combat-log").innerText = "Sua Vez!";
            battleState.busy = false;
            if (battleState.auto) triggerAuto();
          }
        } catch (e) {
          console.error(e);
          battleState.busy = false;
        }
      };

      const triggerAuto = () => {
        const skills = battleState.player.skills;
        for (let i = skills.length - 1; i >= 0; i--) {
          if (battleState.player.mp >= SKILLS[skills[i]].mp) {
            doPlayerTurn(skills[i]);
            return;
          }
        }
        doPlayerTurn("melee");
      };

      const toggleAuto = () => {
        if (state.user.lvl < 2)
          return showToast("Auto libera no N√≠vel 2!", "info");
        battleState.auto = !battleState.auto;
        updateBattleControls();
        if (battleState.auto && !battleState.busy) triggerAuto();
      };
      const toggleSpeed = () => {
        if (state.user.lvl < 5)
          return showToast("3x libera no N√≠vel 5!", "info");
        battleState.speed = battleState.speed === 1 ? 3 : 1;
        updateBattleControls();
      };
      const updateBattleControls = () => {
        const btnA = document.getElementById("btn-auto");
        const btnS = document.getElementById("btn-speed");
        btnA.className = `w-10 h-10 rounded-full border border-white/20 text-xs font-bold text-white flex items-center justify-center transition-all ${
          battleState.auto
            ? "bg-green-600 opacity-100"
            : "bg-slate-900/80 opacity-50"
        }`;
        btnS.className = `w-10 h-10 rounded-full border border-white/20 text-xs font-bold text-white flex items-center justify-center transition-all ${
          battleState.speed > 1
            ? "bg-yellow-600 opacity-100"
            : "bg-slate-900/80 opacity-50"
        }`;
        btnS.innerText = battleState.speed + "x";
      };

      const executeAction = async (att, def, skKey, isPlayer) => {
        const skill = SKILLS[skKey];
        const spd = battleState.speed;
        document.getElementById(
          "combat-log"
        ).innerText = `${att.name} usou ${skill.n}!`;
        const attackerEl = document.getElementById(
          isPlayer ? "player-sprite-container" : "enemy-sprite-container"
        );
        const defenderEl = document.getElementById(
          isPlayer ? "enemy-sprite-container" : "player-sprite-container"
        );
        const wrapperAtt = document.getElementById(
          isPlayer ? "ent-player" : "ent-enemy"
        );

        if (skill.type === "phys") {
          wrapperAtt.classList.add(
            isPlayer ? "anim-melee-player" : "anim-melee-enemy"
          );
          attackerEl.classList.add("anim-spin-atk");
          await sleep(500 / spd);
          wrapperAtt.classList.remove(
            isPlayer ? "anim-melee-player" : "anim-melee-enemy"
          );
          attackerEl.classList.remove("anim-spin-atk");
        } else {
          attackerEl.classList.add("anim-cast");
          await sleep(500 / spd);
          if (skill.type.endsWith("_sup"))
            await spawnUltimateVFX(skill.type, isPlayer);
          else await spawnVFX(skill.type, isPlayer);
          attackerEl.classList.remove("anim-cast");
        }

        defenderEl.classList.add("anim-hit-recoil");
        defenderEl.querySelector("img").classList.add("anim-hit-spin");

        setTimeout(() => {
          defenderEl.classList.remove("anim-hit-recoil");
          defenderEl.querySelector("img").classList.remove("anim-hit-spin");
        }, 600 / spd);

        // IMPACT FRAMES & SCREEN SHAKE
        const impactDelay = 100 / spd; // Ms for freeze
        if (impactDelay > 20) await sleep(impactDelay); // Hit freeze!

        // Shake Camera
        const arena = document.getElementById("app");
        arena.classList.add("anim-shake-impact");
        setTimeout(() => arena.classList.remove("anim-shake-impact"), 300);

        const raw = att.atk * skill.p;
        let dmg = Math.max(10, raw - def.def * 0.5);

        let isCrit = false;
        if (att.crit && Math.random() * 100 < att.crit) {
          isCrit = true;
          dmg = dmg * (1 + (att.cdmg || 50) / 100);
          // Stronger shake for crit
          arena.classList.add("anim-shake-crit");
          setTimeout(() => arena.classList.remove("anim-shake-crit"), 400);
        }
        dmg = Math.floor(dmg);

        def.curHp = Math.max(0, def.curHp - dmg);
        updateBattleHUD();
        showDmgText(dmg, isPlayer ? "ent-enemy" : "ent-player", isCrit);
        await sleep(300 / spd);
      };

      const spawnVFX = async (type, fromPlayer) => {
        const spd = battleState.speed;
        const layer = document.getElementById("effect-layer");
        const pPos = { x: 35, y: 60, z: 250 };
        const ePos = { x: -35, y: -100, z: -450 };
        const start = fromPlayer ? pPos : ePos;
        const end = fromPlayer ? ePos : pPos;
        const targetPos = end;
        const startPos = start;
        const flash = document.getElementById("screen-flash");

        // GLOBAL FLASH RESTRICTION (Only trigger flash if explicitly allowed)
        const triggerFlash = (duration = 100) => {
          if (
            type === "lightning" ||
            type === "thunder_storm" ||
            type.includes("bolt") ||
            type === "meteor_strike"
          ) {
            flash.className = "flash-screen";
            setTimeout(() => (flash.className = "hidden"), duration / spd);
          }
        };

        // WAVE 2 SKILLS VFX
        if (type === "tornado") {
          const wind = document.createElement("div");
          wind.style.position = "absolute";
          wind.style.width = "40px";
          wind.style.height = "100px";
          wind.style.background =
            "linear-gradient(to right, transparent, #a5f3fc, transparent)";
          wind.style.opacity = "0.5";
          wind.style.filter = "blur(4px)";
          layer.appendChild(wind);

          const anim = wind.animate(
            [
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scaleY(0) rotateY(0deg)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 200
                }px) translateZ(${targetPos.z}px) scaleY(2) rotateY(1080deg)`,
              },
            ],
            { duration: 1000 / spd }
          );
          await anim.finished;
          wind.remove();
          return;
        }

        if (type === "earthquake") {
          const ground = document.querySelector(".ground-plane");
          const app = document.getElementById("app");
          // Shake harder
          app.classList.add("anim-shake-impact");
          setTimeout(() => app.classList.remove("anim-shake-impact"), 800);

          for (let i = 0; i < 10; i++) {
            const rock = document.createElement("div");
            rock.className = "vfx-rock";
            rock.style.width = 30 + Math.random() * 40 + "px";
            rock.style.height = rock.style.width;
            rock.style.background = "#78350f";
            layer.appendChild(rock);
            const anim = rock.animate(
              [
                {
                  transform: `translateX(${
                    targetPos.x + (Math.random() - 0.5) * 200
                  }px) translateY(${targetPos.y + 100}px) translateZ(${
                    targetPos.z + (Math.random() - 0.5) * 100
                  }px) scale(0)`,
                },
                {
                  transform: `translateX(${
                    targetPos.x + (Math.random() - 0.5) * 200
                  }px) translateY(${
                    targetPos.y - Math.random() * 150
                  }px) translateZ(${
                    targetPos.z + (Math.random() - 0.5) * 100
                  }px) scale(1)`,
                },
              ],
              { duration: 500 / spd, easing: "ease-out" }
            );
            anim.finished.then(() => rock.remove());
          }
          return;
        }

        if (type === "blizzard") {
          triggerFlash(50); // Maybe a tiny flash for ultimate feel
          for (let i = 0; i < 20; i++) {
            const snow = document.createElement("div");
            snow.style.position = "absolute";
            snow.innerText = "‚ùÑÔ∏è";
            snow.style.fontSize = "20px";
            layer.appendChild(snow);

            const anim = snow.animate(
              [
                {
                  transform: `translateX(${
                    targetPos.x + (Math.random() - 0.5) * 300
                  }px) translateY(-500px) translateZ(${
                    targetPos.z + (Math.random() - 0.5) * 200
                  }px)`,
                },
                {
                  transform: `translateX(${
                    targetPos.x + (Math.random() - 0.5) * 100
                  }px) translateY(${targetPos.y}px) translateZ(${
                    targetPos.z
                  }px)`,
                },
              ],
              { duration: (500 + Math.random() * 500) / spd, easing: "linear" }
            );

            anim.finished.then(() => snow.remove());
            await sleep(20 / spd);
          }
          return;
        }

        if (type === "tidal_wave") {
          const wave = document.createElement("div");
          wave.style.position = "absolute";
          wave.style.width = "200px";
          wave.style.height = "100px";
          wave.style.background = "linear-gradient(180deg, #60a5fa, #1e3a8a)";
          wave.style.borderRadius = "50% 50% 0 0";
          wave.style.opacity = "0.8";
          layer.appendChild(wave);

          const anim = wave.animate(
            [
              {
                transform: `translateX(${startPos.x}px) translateY(${startPos.y}px) translateZ(${startPos.z}px) scale(0.1)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.5)`,
              },
            ],
            { duration: 800 / spd, easing: "ease-out" }
          );
          await anim.finished;
          wave.remove();
          return;
        }

        if (type === "solar_flare") {
          triggerFlash(300); // Fire ultimate flash? Or strict lightning? User said "somente habilidades do tipo trovao". Okay, removing flash here.
          // Actually, "solar_flare" implies bright light. But user rule is strict. No flash.

          const sun = document.createElement("div");
          sun.className = "vfx-fireball";
          sun.style.width = "150px";
          sun.style.height = "150px";
          sun.style.background = "radial-gradient(circle, #fef08a, #f97316)";
          layer.appendChild(sun);

          const anim = sun.animate(
            [
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 300
                }px) translateZ(${targetPos.z}px) scale(0.1)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.5)`,
              },
            ],
            { duration: 1000 / spd, easing: "ease-in" }
          );

          await anim.finished;
          sun.remove();
          return;
        }

        if (type === "ice_shards") {
          for (let i = 0; i < 3; i++) {
            const p = document.createElement("div");
            p.className = "projectile";
            p.style.background = "linear-gradient(45deg, #fff, #a5f3fc)";
            p.style.clipPath = "polygon(50% 0%, 0% 100%, 100% 100%)";
            p.style.width = "20px";
            p.style.height = "40px";
            layer.appendChild(p);
            await sleep(100 / spd);
            const anim = p.animate(
              [
                {
                  transform: `translateX(${startPos.x}px) translateY(${
                    startPos.y
                  }px) translateZ(${startPos.z}px) rotate(${180 + i * 30}deg)`,
                },
                {
                  transform: `translateX(${targetPos.x}px) translateY(${
                    targetPos.y
                  }px) translateZ(${targetPos.z}px) rotate(${
                    180 + i * 120
                  }deg)`,
                },
              ],
              { duration: 400 / spd, easing: "ease-out", fill: "forwards" }
            );
            anim.finished.then(() => p.remove());
          }
          return;
        }

        if (type === "poison_cloud") {
          const cloud = document.createElement("div");
          cloud.style.position = "absolute";
          cloud.style.width = "100px";
          cloud.style.height = "100px";
          cloud.style.background =
            "radial-gradient(circle, rgba(74,222,128,0.8), transparent 70%)";
          cloud.style.filter = "blur(10px)";
          layer.appendChild(cloud);
          const anim = cloud.animate(
            [
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(0)`,
                opacity: 0,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 50
                }px) translateZ(${targetPos.z}px) scale(2)`,
                opacity: 1,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 80
                }px) translateZ(${targetPos.z}px) scale(2.5)`,
                opacity: 0,
              },
            ],
            { duration: 1500 / spd, easing: "ease-out", fill: "forwards" }
          );
          await anim.finished;
          cloud.remove();
          return;
        }

        if (type === "holy_beam") {
          const beam = document.createElement("div");
          beam.style.position = "absolute";
          beam.style.width = "60px";
          beam.style.height = "1000px";
          beam.style.background =
            "linear-gradient(90deg, transparent, #fef08a, #fff, #fef08a, transparent)";
          beam.style.transformOrigin = "bottom center";
          beam.style.zIndex = "150";
          layer.appendChild(beam);
          flash.className = "flash-screen";
          setTimeout(() => (flash.className = "hidden"), 100 / spd);
          const anim = beam.animate(
            [
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 500
                }px) translateZ(${targetPos.z}px) scaleX(0)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 500
                }px) translateZ(${targetPos.z}px) scaleX(1.5)`,
                offset: 0.1,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${
                  targetPos.y - 500
                }px) translateZ(${targetPos.z}px) scaleX(0)`,
              },
            ],
            { duration: 800 / spd, easing: "ease-out", fill: "forwards" }
          );
          await sleep(300 / spd);
          await anim.finished;
          beam.remove();
          return;
        }

        if (type === "blood_drain") {
          for (let i = 0; i < 10; i++) {
            const p = document.createElement("div");
            p.style.position = "absolute";
            p.style.width = "8px";
            p.style.height = "8px";
            p.style.background = "#ef4444";
            p.style.borderRadius = "50%";
            p.style.boxShadow = "0 0 5px red";
            layer.appendChild(p);
            const rndX = (Math.random() - 0.5) * 50;
            const rndY = (Math.random() - 0.5) * 50;
            const anim = p.animate(
              [
                {
                  transform: `translateX(${targetPos.x + rndX}px) translateY(${
                    targetPos.y + rndY
                  }px) translateZ(${targetPos.z}px)`,
                },
                {
                  transform: `translateX(${startPos.x}px) translateY(${startPos.y}px) translateZ(${startPos.z}px)`,
                },
              ],
              {
                duration: (500 + Math.random() * 300) / spd,
                easing: "ease-in-out",
                fill: "forwards",
              }
            );
            anim.finished.then(() => p.remove());
            await sleep(50 / spd);
          }
          return;
        }

        if (type === "shadow_strike") {
          const attacker = document.getElementById(
            fromPlayer ? "player-sprite-container" : "enemy-sprite-container"
          );
          attacker.style.opacity = "0";
          attacker.style.filter = "blur(5px)";
          await sleep(200 / spd);
          const shadow = attacker.cloneNode(true);
          layer.appendChild(shadow);
          shadow.style.position = "absolute";
          shadow.style.opacity = "0.7";
          shadow.style.filter = "grayscale(100%) brightness(0)";
          const anim = shadow.animate(
            [
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.2)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.4)`,
                opacity: 0,
              },
            ],
            { duration: 300 / spd }
          );
          await anim.finished;
          shadow.remove();
          attacker.style.opacity = "1";
          attacker.style.filter = "none";
          return;
        }

        if (type === "thunder_storm") {
          for (let i = 0; i < 5; i++) {
            const strike = document.createElement("div");
            strike.className = "vfx-lightning-strike";
            const offX = (Math.random() - 0.5) * 200;
            const offZ = (Math.random() - 0.5) * 100;
            strike.style.height = "800px";
            strike.style.transform = `translateX(${
              targetPos.x + offX
            }px) translateY(${targetPos.y - 400}px) translateZ(${
              targetPos.z + offZ
            }px) skewX(-10deg)`;
            layer.appendChild(strike);
            setTimeout(() => strike.remove(), 150 / spd);
            await sleep(100 / spd);
          }
          return;
        }

        if (type === "wind_blade") {
          const blade = document.createElement("div");
          blade.style.position = "absolute";
          blade.style.width = "60px";
          blade.style.height = "60px";
          blade.style.border = "4px solid #a5f3fc";
          blade.style.borderRadius = "50%";
          blade.style.boxShadow = "0 0 10px #fff";
          layer.appendChild(blade);
          const anim = blade.animate(
            [
              {
                transform: `translateX(${startPos.x}px) translateY(${startPos.y}px) translateZ(${startPos.z}px) rotate(0deg) scale(0.5)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) rotate(720deg) scale(1.5)`,
              },
            ],
            { duration: 600 / spd, easing: "ease-in", fill: "forwards" }
          );
          await anim.finished;
          blade.remove();
          return;
        }

        if (type === "meteor_strike") {
          const meteor = document.createElement("div");
          meteor.className = "projectile vfx-fireball";
          meteor.style.width = "100px";
          meteor.style.height = "100px";
          layer.appendChild(meteor);
          const anim = meteor.animate(
            [
              {
                transform: `translateX(${
                  targetPos.x + 50
                }px) translateY(-500px) translateZ(${targetPos.z - 200}px)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px)`,
              },
            ],
            { duration: 800 / spd, easing: "ease-in", fill: "forwards" }
          );
          await anim.finished;
          meteor.style.transform = "scale(2)";
          meteor.style.opacity = "0";
          flash.className = "flash-screen";
          setTimeout(() => (flash.className = "hidden"), 200 / spd);
          meteor.remove();
          return;
        }

        if (type === "arcane_barrage") {
          for (let i = 0; i < 3; i++) {
            const p = document.createElement("div");
            p.className = "projectile vfx-void";
            p.style.width = "20px";
            p.style.height = "20px";
            p.style.background = "#d8b4fe";
            p.style.boxShadow = "0 0 10px #a855f7";
            layer.appendChild(p);
            const midX =
              (startPos.x + targetPos.x) / 2 + (Math.random() - 0.5) * 200;
            const midY = Math.min(startPos.y, targetPos.y) - 200;
            const anim = p.animate(
              [
                {
                  transform: `translateX(${startPos.x}px) translateY(${startPos.y}px) translateZ(${startPos.z}px)`,
                },
                {
                  transform: `translateX(${midX}px) translateY(${midY}px) translateZ(${
                    (startPos.z + targetPos.z) / 2
                  }px)`,
                  offset: 0.5,
                },
                {
                  transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px)`,
                },
              ],
              { duration: 600 / spd, easing: "ease-in-out", fill: "forwards" }
            );
            anim.finished.then(() => p.remove());
            await sleep(150 / spd);
          }
          return;
        }

        if (type === "earth_shatter") {
          for (let i = 0; i < 8; i++) {
            const rock = document.createElement("div");
            rock.className = "vfx-rock";
            rock.style.position = "absolute";
            rock.style.width = 20 + Math.random() * 30 + "px";
            rock.style.height = rock.style.width;
            layer.appendChild(rock);
            const anim = rock.animate(
              [
                {
                  transform: `translateX(${targetPos.x}px) translateY(${
                    targetPos.y + 50
                  }px) translateZ(${targetPos.z}px) scale(0)`,
                },
                {
                  transform: `translateX(${
                    targetPos.x + (Math.random() - 0.5) * 100
                  }px) translateY(${
                    targetPos.y - 100 - Math.random() * 100
                  }px) translateZ(${targetPos.z}px) scale(1) rotate(${
                    Math.random() * 360
                  }deg)`,
                },
                {
                  transform: `translateX(${
                    targetPos.x + (Math.random() - 0.5) * 120
                  }px) translateY(${targetPos.y + 50}px) translateZ(${
                    targetPos.z
                  }px) scale(1) rotate(${Math.random() * 360}deg)`,
                  opacity: 0,
                },
              ],
              { duration: 1000 / spd, easing: "cubic-bezier(0,1.5,1,1)" }
            );
            anim.finished.then(() => rock.remove());
          }
          return;
        }

        if (type === "lightning") {
          const flash = document.getElementById("screen-flash");
          flash.className = "flash-screen";
          const strike = document.createElement("div");
          strike.className = "vfx-lightning-strike";
          const tx = fromPlayer ? -35 : 35;
          const ty = fromPlayer ? -100 : 60;
          strike.style.transform = `translateX(${tx}px) translateY(${ty}px) skewX(-5deg)`;
          layer.appendChild(strike);
          setTimeout(() => {
            flash.className = "hidden";
            strike.remove();
          }, 300 / spd);
          await sleep(300 / spd);
          return;
        }

        const proj = document.createElement("div");
        proj.className = "projectile";
        if (type.includes("fire")) proj.classList.add("vfx-fireball");
        else if (type.includes("water")) proj.classList.add("vfx-waterball");
        else if (type.includes("earth")) proj.classList.add("vfx-rock");
        else if (type.includes("nature")) proj.classList.add("vfx-leaf");
        else if (type.includes("void")) proj.classList.add("vfx-void");
        else proj.classList.add("vfx-fireball");

        layer.appendChild(proj);
        const anim = proj.animate(
          [
            {
              transform: `translateX(${start.x}px) translateY(${start.y}px) translateZ(${start.z}px) scale(0.5)`,
            },
            {
              transform: `translateX(${end.x}px) translateY(${end.y}px) translateZ(${end.z}px) scale(1)`,
            },
          ],
          {
            duration: 500 / spd,
            easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
            fill: "forwards",
          }
        );
        await anim.finished;
        proj.remove();
      };

      const spawnUltimateVFX = async (type, fromPlayer) => {
        const spd = battleState.speed;
        const layer = document.getElementById("effect-layer");
        const flash = document.getElementById("screen-flash");
        const pPos = { x: 35, y: 60, z: 250 };
        const ePos = { x: -35, y: -100, z: -450 };
        const targetPos = fromPlayer ? ePos : pPos;
        const startPos = fromPlayer ? pPos : ePos;

        flash.className = "flash-screen";
        setTimeout(() => (flash.className = "hidden"), 300 / spd);

        if (type.includes("lightning")) {
          for (let i = 0; i < 6; i++) {
            const strike = document.createElement("div");
            strike.className = "vfx-lightning-strike";
            const offX = (Math.random() - 0.5) * 100;
            strike.style.transform = `translateX(${
              targetPos.x + offX
            }px) translateY(${targetPos.y}px) translateZ(${
              targetPos.z
            }px) skewX(-5deg)`;
            layer.appendChild(strike);
            setTimeout(() => strike.remove(), 200 / spd);
            await sleep(80 / spd);
          }
          return;
        }
        if (type.includes("fire")) {
          const projectiles = [];
          for (let i = 0; i < 8; i++) {
            const p = document.createElement("div");
            p.className = "projectile vfx-fireball";
            p.style.width = "60px";
            p.style.height = "60px";
            layer.appendChild(p);
            const sX = startPos.x + (Math.random() - 0.5) * 100;
            const eX = targetPos.x + (Math.random() - 0.5) * 80;
            const anim = p.animate(
              [
                {
                  transform: `translateX(${sX}px) translateY(${
                    startPos.y - 200
                  }px) translateZ(${startPos.z}px) scale(0.5)`,
                },
                {
                  transform: `translateX(${eX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.2)`,
                },
              ],
              {
                duration: (400 + Math.random() * 200) / spd,
                easing: "ease-in",
                fill: "forwards",
              }
            );
            projectiles.push({ el: p, anim: anim });
            await sleep(50 / spd);
          }
          await Promise.all(projectiles.map((p) => p.anim.finished));
          projectiles.forEach((p) => p.el.remove());
          return;
        }
        if (type.includes("water")) {
          const projectiles = [];
          for (let i = 0; i < 10; i++) {
            const p = document.createElement("div");
            p.className = "projectile vfx-waterball";
            layer.appendChild(p);
            const eX = targetPos.x + (Math.random() - 0.5) * 120;
            const anim = p.animate(
              [
                {
                  transform: `translateX(${startPos.x}px) translateY(${startPos.y}px) translateZ(${startPos.z}px) scale(0.2)`,
                },
                {
                  transform: `translateX(${eX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1)`,
                },
              ],
              {
                duration: 600 / spd,
                easing: "cubic-bezier(0,0.5,0.5,1)",
                fill: "forwards",
              }
            );
            projectiles.push({ el: p, anim: anim });
            await sleep(30 / spd);
          }
          await sleep(500 / spd);
          projectiles.forEach((p) => p.el.remove());
          return;
        }
        if (type.includes("earth")) {
          const projectiles = [];
          for (let i = 0; i < 5; i++) {
            const p = document.createElement("div");
            p.className = "projectile vfx-rock";
            p.style.width = "70px";
            p.style.height = "70px";
            layer.appendChild(p);
            const sX = startPos.x + (Math.random() - 0.5) * 150;
            const eX = targetPos.x + (Math.random() - 0.5) * 50;
            const anim = p.animate(
              [
                {
                  transform: `translateX(${sX}px) translateY(${
                    startPos.y - 150
                  }px) translateZ(${startPos.z}px) scale(0.5) rotate(0deg)`,
                },
                {
                  transform: `translateX(${eX}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(1.5) rotate(360deg)`,
                },
              ],
              { duration: 700 / spd, easing: "ease-in", fill: "forwards" }
            );
            projectiles.push({ el: p, anim: anim });
            await sleep(100 / spd);
          }
          await sleep(600 / spd);
          projectiles.forEach((p) => p.el.remove());
          return;
        }
        if (type.includes("void")) {
          const p = document.createElement("div");
          p.className = "vfx-blackhole";
          layer.appendChild(p);

          const anim = p.animate(
            [
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(0)`,
              },
              {
                transform: `translateX(${targetPos.x}px) translateY(${targetPos.y}px) translateZ(${targetPos.z}px) scale(8)`,
              },
            ],
            { duration: 1500 / spd, easing: "ease-out", fill: "forwards" }
          );

          await anim.finished;
          p.style.transition = "opacity 0.2s";
          p.style.opacity = 0;
          await sleep(200 / spd);
          p.remove();
          return;
        }
      };

      const showDmgText = (val, targetId, isCrit) => {
        const el = document.createElement("div");
        el.className = "dmg-text";
        if (isCrit) el.classList.add("dmg-crit");
        el.innerText = val + (isCrit ? "!" : "");
        document.getElementById(targetId).appendChild(el);
        setTimeout(() => el.remove(), 800 / battleState.speed);
      };

      const updateBattleHUD = () => {
        const pPct =
          (battleState.player.curHp / battleState.player.maxHp) * 100;
        const mPct = (battleState.player.mp / battleState.player.maxMp) * 100;
        const ePct = (battleState.enemy.curHp / battleState.enemy.maxHp) * 100;
        document.getElementById("hud-p-hp-bar").style.width = `${pPct}%`;
        document.getElementById("hud-p-hp-txt").innerText =
          Math.ceil(pPct) + "%";
        document.getElementById("hud-p-mp-bar").style.width = `${mPct}%`;
        document.getElementById("hud-e-hp-bar").style.width = `${ePct}%`;
        document.getElementById("hud-e-hp-txt").innerText =
          Math.ceil(ePct) + "%";
        document.getElementById("hud-e-name").innerText =
          battleState.enemy.name;
      };

      const winBattle = () => endScreen(true);
      const loseBattle = () => endScreen(false);

      const endScreen = (win) => {
        const ov = document.getElementById("battle-overlay");
        ov.classList.remove("hidden");
        ov.classList.add("flex");
        void ov.offsetWidth;
        ov.style.opacity = "1";
        document.getElementById("outcome-title").innerText = win
          ? "VIT√ìRIA"
          : "DERROTA";

        if (win) {
          let rewards = "";
          const accXp = 50;
          state.user.xp += accXp;

          const xpReq = 100 * state.user.lvl;
          if (state.user.xp >= xpReq) {
            state.user.xp = state.user.xp - xpReq;
            state.user.lvl++;
            state.user.crystals += 25;
            showToast(`LEVEL UP! N√≠vel ${state.user.lvl} (+25 üíé)`);
          }

          let crystalsGained = 0;
          let goldGained = 0;

          if (battleState.mode.startsWith("dungeon")) {
            const floor = prepState.level;
            goldGained = 1000 + floor * 500; // 2x Boost
            crystalsGained = 5 + floor;

            // EQUIPMENT DROP LOGIC
            let dropRate = 0.3 + floor * 0.02; // Base 30% + 2% per floor
            if (Math.random() < dropRate) {
              const dungeonType = battleState.mode.includes("dragon")
                ? "dragon"
                : "golem";
              const droppedEq = createEquipment(floor, dungeonType);
              state.equipment.push(droppedEq);
              const rName = EQ_RARITY[droppedEq.rarity].name;
              rewards = `DROP: ${rName} ${
                droppedEq.type === "weapon"
                  ? "Arma"
                  : droppedEq.type === "armor"
                  ? "Armadura"
                  : "Acess√≥rio"
              }!`;
            } else {
              rewards = `+${goldGained} Ouro | +${crystalsGained} üíé`;
            }
          } else if (battleState.mode === "tower") {
            state.towerFloor++;
            crystalsGained = 50 + state.towerFloor * 10;
            goldGained = 1000 * state.towerFloor; // 2x Boost
            rewards = `Andar ${state.towerFloor - 1} Completo!`;
          } else {
            const stage = prepState.level;
            const stageKey = `stage_${stage}`;
            if (!state.user.firstClear[stageKey]) {
              crystalsGained = 100;
              goldGained = 2000 * stage; // 2x Boost
              state.user.firstClear[stageKey] = true;
              if (stage === state.storyProgress) state.storyProgress++;
              rewards = `PRIMEIRA VEZ! +${crystalsGained} üíé | +${goldGained} Ouro`;
            } else {
              crystalsGained = 5;
              goldGained = 300 + stage * 100; // 2x Boost
              rewards = `+${crystalsGained} üíé | +${goldGained} Ouro`;
            }
          }

          state.user.crystals += crystalsGained;
          state.user.gold += goldGained;
          save();
          updateHeader();
          document.getElementById("outcome-rewards").innerText = rewards;
        } else {
          document.getElementById("outcome-rewards").innerText =
            "Tente melhorar seu time";
        }
      };
      const closeBattle = () => {
        changeView("view-home");
        updateHeader();
      };

      const useXpPotion = () => {
        const mon = state.inventory[selectedDetailIdx];
        if (state.user.potions < 1)
          return showToast("Sem po√ß√µes de XP!", "error");
        state.user.potions--;
        mon.lvl++;
        save();
        showToast(`${mon.name} subiu para o n√≠vel ${mon.lvl}!`);
        openDetail(selectedDetailIdx);
      };

      const renderMonsterBox = () => {
        const grid = document.getElementById("roster-grid");
        grid.innerHTML = "";
        document.getElementById("mon-count").innerText = state.inventory.length;
        state.inventory.forEach((mon, idx) => {
          const slot = document.createElement("div");
          const isLeader = idx === state.leaderIdx;
          slot.className = `sw-slot aspect-square cursor-pointer flex items-center justify-center ${
            isLeader ? "selected" : ""
          }`;

          if (!isLeader) {
            if (mon.stars >= 5) slot.style.borderColor = "#fbbf24";
            else if (mon.stars === 4) slot.style.borderColor = "#a855f7";
            else if (mon.stars === 3) slot.style.borderColor = "#3b82f6";
          }

          const elColor =
            {
              fire: "bg-fire",
              water: "bg-water",
              lightning: "bg-lightning",
              earth: "bg-earth",
              nature: "bg-nature",
              void: "bg-void",
            }[mon.element] || "bg-slate-500";
          slot.innerHTML = `<div class="elem-badge ${elColor}"></div><img src="${
            mon.img
          }" class="w-[90%] h-[90%] object-contain filter drop-shadow-lg" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:3rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5))">${
            mon.emoji
          }</span><div class="star-row">${'<span class="star-icon">‚òÖ</span>'.repeat(
            mon.stars
          )}</div><div class="absolute top-1 left-1 text-[8px] font-bold text-white bg-black/50 px-1 rounded">Lv.${
            mon.lvl
          }</div>`;
          slot.onclick = () => openDetail(idx);
          grid.appendChild(slot);
        });
      };

      let selectedDetailIdx = 0;
      const openDetail = (idx) => {
        selectedDetailIdx = idx;
        const mon = state.inventory[idx];
        if (!mon.equipped)
          mon.equipped = { weapon: null, armor: null, acc: null };

        document
          .getElementById("mon-detail-overlay")
          .classList.remove("hidden");
        document.getElementById("mon-detail-overlay").classList.add("flex");
        document.getElementById("det-name").innerText = mon.name;
        document.getElementById("det-type").innerText = mon.type;
        document.getElementById("det-lvl").innerText = `Lv. ${mon.lvl}`;
        document.getElementById("det-stars").innerHTML = "‚òÖ".repeat(mon.stars);
        document.getElementById("det-nat-grade").innerText = `NAT ${mon.stars}`;
        document.getElementById("det-element-badge").innerText = {
          fire: "üî•",
          water: "üåä",
          lightning: "‚ö°",
          earth: "üóø",
          nature: "üçÉ",
          void: "üåë",
        }[mon.element];
        document.getElementById("det-emoji").innerText = mon.emoji;
        const img = document.getElementById("det-img");
        img.style.display = "block";
        document.getElementById("det-emoji").style.display = "none";
        img.src = mon.img;

        const stats = calculateStats(mon);
        document.getElementById("val-hp").innerText = stats.hp;
        document.getElementById("val-atk").innerText = stats.atk;
        document.getElementById("val-def").innerText = stats.def;
        document.getElementById("val-crit").innerText = stats.crit + "%";
        document.getElementById("val-cdmg").innerText = stats.cdmg + "%";

        renderEqSlot("weapon", mon.equipped.weapon);
        renderEqSlot("armor", mon.equipped.armor);
        renderEqSlot("acc", mon.equipped.acc);

        const btn = document.getElementById("btn-equip");
        if (state.leaderIdx === idx) {
          btn.innerText = "L√≠der Atual";
          btn.className =
            "w-full py-3 mt-2 bg-green-500 text-white font-black uppercase rounded-xl opacity-90";
        } else {
          btn.innerText = "Definir L√≠der";
          btn.className =
            "w-full py-3 mt-2 bg-white text-slate-900 font-black uppercase rounded-xl active:scale-95";
          btn.onclick = equipLeader;
        }
        document.getElementById(
          "btn-xp"
        ).innerText = `Usar Potion (${state.user.potions})`;
      };

      const renderEqSlot = (type, id) => {
        const el = document.getElementById(`eq-slot-${type}`);
        if (id) {
          const eq = state.equipment.find((e) => e.id === id);
          if (eq) {
            el.className = `eq-slot filled ${EQ_RARITY[eq.rarity].color}`;
            el.innerHTML = `<span class="text-xs font-bold absolute bottom-0 right-1">+${
              eq.lvl
            }</span>${
              type === "weapon" ? "‚öîÔ∏è" : type === "armor" ? "üõ°Ô∏è" : "üíç"
            }`;
            return;
          }
        }
        el.className = "eq-slot";
        el.innerHTML = `<span class="opacity-20">${
          type === "weapon" ? "‚öîÔ∏è" : type === "armor" ? "üõ°Ô∏è" : "üíç"
        }</span>`;
      };

      const closeDetail = () =>
        document.getElementById("mon-detail-overlay").classList.add("hidden");
      const equipLeader = () => {
        state.leaderIdx = selectedDetailIdx;
        save();
        closeDetail();
        renderMonsterBox();
      };

      const renderStory = () => {
        const c = document.getElementById("story-nodes");
        c.innerHTML = "";
        for (let i = 1; i <= 5; i++) {
          const locked = state.storyProgress < i;
          const node = document.createElement("div");
          node.className = `relative pl-6 transition-all ${
            locked ? "opacity-50 grayscale pointer-events-none" : ""
          }`;
          node.innerHTML = `<div class="absolute left-[-5px] top-3 w-3 h-3 rounded-full ${
            locked ? "bg-slate-700" : "bg-indigo-500"
          }"></div><button onclick="openPrep('story',${i})" class="glass-panel w-full p-4 rounded-xl text-left"><h3 class="text-white font-bold">Cap√≠tulo ${i}</h3><p class="text-xs text-slate-400">Inimigos n√≠vel ${
            i * 3
          }</p></button>`;
          c.appendChild(node);
        }
      };

      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
      window.onload = init;
    </script>
  </body>
</html>
